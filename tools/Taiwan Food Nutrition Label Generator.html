<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°ç£é£Ÿå“ç‡Ÿé¤Šæ¨™ç¤ºè£½ä½œå·¥å…· v1.42</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Microsoft JhengHei','Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:40px;text-align:center}
    .header h1{font-size:2.2em;margin-bottom:8px}
    .muted{color:#e6e6e6;font-size:.9em}
    .progress-bar{display:flex;justify-content:space-between;padding:24px 40px;background:#f8f9fa;border-bottom:2px solid #e9ecef}
    .progress-step{flex:1;text-align:center;position:relative;padding:10px}
    .progress-step::before{content:attr(data-step);display:block;width:40px;height:40px;background:#dee2e6;color:#6c757d;border-radius:50%;margin:0 auto 10px;line-height:40px;font-weight:bold;transition:all .3s}
    .progress-step.active::before{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;transform:scale(1.1)}
    .progress-step.completed::before{background:#28a745;color:#fff}
    .progress-step::after{content:'';position:absolute;top:20px;left:60%;width:80%;height:2px;background:#dee2e6;z-index:-1}
    .progress-step:last-child::after{display:none}
    .progress-step.completed::after{background:#28a745}
    .content{padding:32px}
    .step-content{display:none}
    .step-content.active{display:block;animation:fadeIn .4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .form-group{margin-bottom:24px}
    .form-group label{display:block;font-weight:600;margin-bottom:10px;color:#495057}
    .radio-group{display:grid;gap:12px}
    .radio-option{position:relative;padding:16px;border:2px solid #e9ecef;border-radius:12px;cursor:pointer;transition:all .3s;background:#fff}
    .radio-option:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,.15);transform:translateY(-2px)}
    .radio-option input[type=radio]{position:absolute;opacity:0}
    .radio-label{display:flex;align-items:center}
    .radio-label::before{content:'';width:18px;height:18px;border:2px solid #dee2e6;border-radius:50%;margin-right:10px;transition:all .3s}
    .radio-option input[type=radio]:checked + .radio-label{color:#667eea;font-weight:600}
    .radio-option input[type=radio]:checked + .radio-label::before{border-color:#667eea;background:#667eea;box-shadow:inset 0 0 0 4px #fff}
    .btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.25s;margin:5px}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,126,234,.4)}
    .btn-secondary{background:#6c757d;color:#fff}
    .btn-secondary:hover{background:#5a6268;transform:translateY(-2px)}
    .btn-group{display:flex;justify-content:space-between;flex-wrap:wrap;margin-top:18px}
    .input-field{width:100%;padding:10px 14px;border:2px solid #e9ecef;border-radius:8px;font-size:1em}
    .input-field:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .input-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:10px}
    .nutrient-item{background:#f8f9fa;padding:16px;border-radius:12px;border:2px solid #e9ecef}
    select{width:100%;padding:10px;border:2px solid #e9ecef;border-radius:8px;margin-top:8px}
    .preview-section{margin-top:26px;padding:20px;background:#f8f9fa;border-radius:12px}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:22px;margin-top:12px}
    .nutrition-table{background:#fff;border:2px solid #333;border-radius:8px;overflow:hidden}
    .nutrition-table table{width:100%;border-collapse:collapse}
    .nutrition-table th{background:#495057;color:#fff;padding:10px;text-align:left}
    .nutrition-table td{padding:10px;border-bottom:1px solid #dee2e6}
    .text-right{text-align:right}
    .horizontal-label{background:#fff;border:2px solid #333;border-radius:8px;padding:16px;line-height:1.8}
    .download-section{text-align:center;margin-top:18px}
    .download-btn{margin:8px;padding:12px 22px;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer}
    .download-btn:hover{background:#218838;transform:translateY(-2px)}
    .note{margin-top:10px;padding:12px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:6px}
    .info-box{background:#e7f3ff;border-left:4px solid #2196F3;padding:12px;margin:12px 0;border-radius:6px}
    @media(max-width:768px){.btn{width:100%}}
	.local-download { margin-top:10px; text-align:right }
	.local-download .btn-mini {
	  padding:8px 14px; border:none; border-radius:8px; font-weight:600; cursor:pointer;
	  background:#28a745; color:#fff; margin-left:8px;
	}
	.local-download .btn-mini:hover { background:#218838; transform:translateY(-1px) }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¥— å°ç£é£Ÿå“ç‡Ÿé¤Šæ¨™ç¤ºè£½ä½œå·¥å…·</h1>
      <div class="muted">v1.4ï¼ˆæ ¼å¼2/3ä¾æ—ç¾¤ DV è¨ˆç®—ï¼‹åˆ—ç¤ºï¼›æ ¼å¼3 A/D/E çš„ IU å¿…å¡«ï¼‰</div>
    </div>

    <div class="progress-bar">
      <div class="progress-step active" data-step="1"><div>é¸æ“‡ç”¢å“ç‰¹æ€§</div></div>
      <div class="progress-step" data-step="2"><div>å¡«å¯«ç‡Ÿé¤Šæ•¸æ“š</div></div>
      <div class="progress-step" data-step="3"><div>é¸æ“‡æ¨™ç¤ºæ ¼å¼</div></div>
      <div class="progress-step" data-step="4"><div>é è¦½èˆ‡ä¸‹è¼‰</div></div>
    </div>

    <div class="content">
      <!-- æ­¥é©Ÿ 1 -->
      <div class="step-content active" id="step1">
        <h2>æ­¥é©Ÿ 1ï¼šé¸æ“‡ç”¢å“å‹æ…‹</h2>
        <div class="form-group">
          <label>è«‹é¸æ“‡æ‚¨çš„ç”¢å“å‹æ…‹ï¼š</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" name="productType" value="solid" id="solid">
              <label class="radio-label" for="solid">å›ºé«”ï¼ˆå–®ä½ï¼šå…¬å…‹ï¼‰</label>
            </div>
            <div class="radio-option">
              <input type="radio" name="productType" value="liquid" id="liquid">
              <label class="radio-label" for="liquid">æ¶²é«”ï¼ˆå–®ä½ï¼šæ¯«å‡ï¼‰</label>
            </div>
            <div class="radio-option">
              <input type="radio" name="productType" value="mixed" id="mixed">
              <label class="radio-label" for="mixed">å›ºæ¶²æ··åˆï¼ˆå¯é¸æ“‡å–®ä½ï¼‰</label>
            </div>
          </div>
        </div>
        <div class="btn-group">
          <div></div>
          <button class="btn btn-primary" onclick="nextStep(1)">ä¸‹ä¸€æ­¥ â†’</button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 1-2 -->
      <div class="step-content" id="step1-2">
        <h2>æ­¥é©Ÿ 1-2ï¼šé¸æ“‡ç‰¹å®šç”¢å“å‹æ…‹</h2>
        <div class="form-group">
          <label>æ‚¨çš„ç”¢å“æ˜¯å¦ç‚ºä»¥ä¸‹ç‰¹å®šå‹æ…‹ï¼Ÿ</label>
          <div class="radio-group" id="specificTypeOptions">
            <div class="radio-option">
              <input type="radio" name="specificType" value="capsule" id="capsule">
              <label class="radio-label" for="capsule">è† å›ŠéŒ ç‹€ï¼ˆä½¿ç”¨æ ¼å¼2ï¼šæ¯æ—¥åƒè€ƒç™¾åˆ†æ¯”æ ¼å¼ï¼‰</label>
            </div>
            <div class="radio-option">
              <input type="radio" name="specificType" value="vitaminCapsule" id="vitaminCapsule">
              <label class="radio-label" for="vitaminCapsule">ç¶­ç”Ÿç´ ç¤¦ç‰©è³ªè† å›ŠéŒ ç‹€ï¼ˆä½¿ç”¨æ ¼å¼3ï¼šç¶­ç”Ÿç´ ç¤¦ç‰©è³ªå°ˆç”¨æ ¼å¼ï¼‰</label>
            </div>
            <div class="radio-option">
              <input type="radio" name="specificType" value="normal" id="normal">
              <label class="radio-label" for="normal">ä¸€èˆ¬ç”¢å“ï¼ˆå¯é¸æ“‡æ ¼å¼1æˆ–æ ¼å¼2ï¼‰</label>
            </div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevStep(1)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="nextStep(2)">ä¸‹ä¸€æ­¥ â†’</button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 1-3 -->
      <div class="step-content" id="step1-3">
        <h2>æ­¥é©Ÿ 1-3ï¼šé¸æ“‡é©ç”¨å¹´é½¡</h2>
        <div class="form-group">
          <label>è«‹é¸æ“‡ç”¢å“çš„é©ç”¨å°è±¡ï¼š</label>
          <div class="radio-group">
            <div class="radio-option"><input type="radio" name="ageGroup" value="under1" id="under1"><label class="radio-label" for="under1">æœªæ»¿ä¸€æ­²ï¼ˆåƒ…æ ¼å¼1ï¼‰</label></div>
            <div class="radio-option"><input type="radio" name="ageGroup" value="1to3" id="1to3"><label class="radio-label" for="1to3">ä¸€æ­²åˆ°ä¸‰æ­²</label></div>
            <div class="radio-option"><input type="radio" name="ageGroup" value="over4" id="over4"><label class="radio-label" for="over4">éç‰¹å®šå°è±¡ï¼ˆå››æ­²ä»¥ä¸Šï¼‰</label></div>
            <div class="radio-option"><input type="radio" name="ageGroup" value="pregnant" id="pregnant"><label class="radio-label" for="pregnant">å­•ä¹³å©¦</label></div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevStep(2)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="toDataEntry()">ä¸‹ä¸€æ­¥ï¼šå¡«å¯«æ•¸æ“š â†’</button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 2 -->
      <div class="step-content" id="step2">
        <h2>æ­¥é©Ÿ 2ï¼šå¡«å¯«ç‡Ÿé¤Šæ•¸æ“š</h2>

        <!-- ä¸€èˆ¬ç”¢å“ åŸºæœ¬è³‡è¨Š -->
        <div class="form-group" id="basicInfoBox">
          <label>åŸºæœ¬è³‡è¨Š</label>
          <div class="input-grid">
            <div class="nutrient-item">
              <label>æ¯ä¸€ä»½é‡</label>
              <input type="number" class="input-field" id="servingSize" placeholder="0" step="0.1">
              <small id="unitDisplay">å…¬å…‹</small>
            </div>
            <div class="nutrient-item">
              <label>æœ¬åŒ…è£å«å¹¾ä»½</label>
              <input type="number" class="input-field" id="servingsPerContainer" placeholder="0" step="0.1">
            </div>
          </div>
        </div>

        <!-- è† å›ŠéŒ ç‹€ æ¨¡å¼ -->
        <div class="form-group" id="capsuleModeBox" style="display:none;">
          <label>è† å›ŠéŒ ç‹€è¼¸å…¥æ¨¡å¼</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" name="capsuleMode" value="count" id="capsuleModeCount">
              <label class="radio-label" for="capsuleModeCount">é¡†ç²’éŒ æ¨¡å¼ï¼ˆæ¯ä¸€ä»½é‡_é¡†æ•¸ Ã— æ¯é¡†é‡é‡_å…¬å…‹/æ¯«å…‹ï¼‰</label>
            </div>
            <div class="radio-option">
              <input type="radio" name="capsuleMode" value="weight" id="capsuleModeWeight">
              <label class="radio-label" for="capsuleModeWeight">é‡é‡æ¨¡å¼ï¼ˆæ¯ä¸€ä»½é‡_å…¬å…‹/æ¯«å…‹ï¼‰</label>
            </div>
          </div>

          <!-- é¡†ç²’éŒ æ¨¡å¼æ¬„ä½ -->
          <div id="capsuleCountFields" class="input-grid" style="margin-top:10px;display:none;">
            <div class="nutrient-item">
              <label>æ¯ä¸€ä»½é‡ï¼ˆæ•¸é‡ï¼‰</label>
              <input type="number" class="input-field" id="capsuleCount" placeholder="0" step="1">
              <select class="input-field" id="capsuleCountLabel">
                <option value="é¡†">é¡†</option>
                <option value="ç²’">ç²’</option>
                <option value="éŒ ">éŒ </option>
              </select>
            </div>
            <div class="nutrient-item">
              <label>æ¯<span id="perPieceLabel">é¡†</span>é‡é‡</label>
              <input type="number" class="input-field" id="capsuleUnitWeight" placeholder="0" step="0.01">
              <select class="input-field" id="capsuleUnitWeightUnit">
                <option value="g">å…¬å…‹</option>
                <option value="mg">æ¯«å…‹</option>
              </select>
            </div>
          </div>

          <!-- é‡é‡æ¨¡å¼æ¬„ä½ -->
          <div id="capsuleWeightFields" class="input-grid" style="margin-top:10px;display:none;">
            <div class="nutrient-item">
              <label>æ¯ä¸€ä»½é‡ï¼ˆé‡é‡ï¼‰</label>
              <input type="number" class="input-field" id="capsuleServingWeight" placeholder="0" step="0.01">
              <select class="input-field" id="capsuleServingWeightUnit">
                <option value="g">å…¬å…‹</option>
                <option value="mg">æ¯«å…‹</option>
              </select>
            </div>
          </div>

          <!-- å…±åŒæ¬„ä½ -->
          <div class="input-grid" style="margin-top:10px;">
            <div class="nutrient-item">
              <label>æœ¬åŒ…è£å«å¹¾ä»½</label>
              <input type="number" class="input-field" id="capsuleServingsPerContainer" placeholder="0" step="0.1">
            </div>
          </div>
        </div>

        <!-- å…«å¤§ç‡Ÿé¤Šç´ ï¼ˆæ¯100å–®ä½ï¼‰ -->
        <div class="form-group" id="basicNutrients">
          <label>å…«å¤§ç‡Ÿé¤Šç´ ï¼ˆæ¯ 100 <span id="per100Unit">å…¬å…‹</span>ï¼‰</label>
          <div class="input-grid">
		<div class="nutrient-item"><label>ç†±é‡ï¼ˆå¤§å¡ï¼‰</label><input type="number" class="input-field" data-nutrient="caloriesUser" placeholder="0" step="0.1"></div>
            <div class="nutrient-item"><label>è›‹ç™½è³ªï¼ˆå…¬å…‹ï¼‰</label><input type="number" class="input-field" data-nutrient="protein" placeholder="0" step="0.1"></div>
            <div class="nutrient-item"><label>è„‚è‚ªï¼ˆå…¬å…‹ï¼‰</label><input type="number" class="input-field" data-nutrient="fat" placeholder="0" step="0.1"></div>
            <div class="nutrient-item"><label>é£½å’Œè„‚è‚ªï¼ˆå…¬å…‹ï¼‰</label><input type="number" class="input-field" data-nutrient="saturatedFat" placeholder="0" step="0.1"></div>
            <div class="nutrient-item"><label>åå¼è„‚è‚ªï¼ˆå…¬å…‹ï¼‰</label><input type="number" class="input-field" data-nutrient="transFat" placeholder="0" step="0.1"></div>
            <div class="nutrient-item"><label>ç¢³æ°´åŒ–åˆç‰©ï¼ˆå…¬å…‹ï¼‰</label><input type="number" class="input-field" data-nutrient="carbs" placeholder="0" step="0.1"></div>
            <div class="nutrient-item"><label>ç³–ï¼ˆå…¬å…‹ï¼‰</label><input type="number" class="input-field" data-nutrient="sugar" placeholder="0" step="0.1"></div>
            <div class="nutrient-item"><label>éˆ‰ï¼ˆæ¯«å…‹ï¼‰</label><input type="number" class="input-field" data-nutrient="sodium" placeholder="0" step="0.1"></div>
          </div>
        </div>

        <!-- æ ¼å¼3ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ª -->
        <div class="form-group" id="vitaminMineralSection" style="display:none;">
          <div class="info-box"><strong>æ ¼å¼3å°ˆç”¨ï¼š</strong>è«‹å¡«å¯«ç¶­ç”Ÿç´ èˆ‡ç¤¦ç‰©è³ªå«é‡ï¼ˆæ¯ä»½ï¼‰ã€‚ç¶­ç”Ÿç´  Aï¼Dï¼E çš„ IU å¿…å¡«ã€‚</div>

          <h3 style="margin-top: 8px;">ç¶­ç”Ÿç´ é¡</h3>
          <div id="vitaminInputs" class="input-grid"></div>
          <button class="btn btn-primary" onclick="addVitaminInput()">+ æ–°å¢ç¶­ç”Ÿç´ </button>

          <h3 style="margin-top: 18px;">ç¤¦ç‰©è³ªé¡</h3>
          <div id="mineralInputs" class="input-grid"></div>
          <button class="btn btn-primary" onclick="addMineralInput()">+ æ–°å¢ç¤¦ç‰©è³ª</button>

          <div class="note" style="margin-top:12px;">
            <strong>æ›ç®—æé†’ï¼š</strong><br>
            Î±-TE (a-Tocopherol Equivalentï¼Œç”Ÿè‚²é†‡ç•¶é‡)ï¼š1 mg Î±-TE = 1 mg å¤©ç„¶ Î±-ç”Ÿè‚²é†‡ = 1.49 IUï¼›1 mg Î±-ç”Ÿè‚²é†‡é†‹é…¸é¹½ï¼ˆåˆæˆï¼‰= 1.1 IUã€‚<br>
            ç¶­ç”Ÿç´  Dï¼š1 Î¼g = 40 IUã€‚<br>
          </div>
        </div>

        <!-- å…¶ä»–ç‡Ÿé¤Šç´  -->
        <div class="form-group">
          <h3>æ–°å¢å…¶ä»–ç‡Ÿé¤Šç´ </h3>
          <div class="input-grid">
            <div>
              <label>é¡åˆ¥</label>
              <select id="nutrientCategory">
                <option value="">é¸æ“‡ç‡Ÿé¤Šç´ é¡åˆ¥</option>
                <option value="protein">è›‹ç™½è³ªé¡ï¼ˆå«èƒºåŸºé…¸ï¼‰</option>
                <option value="fat">è„‚è‚ªé¡</option>
                <option value="carb">ç¢³æ°´åŒ–åˆç‰©é¡</option>
                <!-- åœ¨æ ¼å¼3æœƒéš±è—ä»¥ä¸‹å…©å€‹é¸é … -->
                <option value="vitamin" class="vmOpt">ç¶­ç”Ÿç´ é¡</option>
                <option value="mineral" class="vmOpt">ç¤¦ç‰©è³ªé¡</option>
                <option value="other">å…¶ä»–é¡åˆ¥</option>
              </select>
            </div>
            <div>
              <label>ç‡Ÿé¤Šç´ </label>
              <select id="specificNutrient" disabled>
                <option value="">å…ˆé¸æ“‡é¡åˆ¥</option>
              </select>
            </div>
            <div style="align-self:end;">
              <button class="btn btn-primary" onclick="addNutrient()">+ æ–°å¢ç‡Ÿé¤Šç´ </button>
            </div>
          </div>
          <div id="additionalNutrients" class="input-grid" style="margin-top:10px;"></div>
          <div class="muted" style="margin-top:6px;">* å…¶ä»–ç‡Ÿé¤Šç´ å–®ä½ï¼šå›ºå®šæˆ–ä¸‹æ‹‰ï¼ˆå…¬å…‹ï¼æ¯«å…‹ï¼å¾®å…‹ï¼Œé è¨­å¾®å…‹ï¼‰ã€‚åœ¨æ ¼å¼3ä¸­ä¸æä¾›ã€Œç¶­ç”Ÿç´ ã€ã€Œç¤¦ç‰©è³ªã€é¸é …ã€‚</div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="backToSelection()">â† è¿”å›é¸æ“‡</button>
          <button class="btn btn-primary" onclick="calculateAndPreview()">è¨ˆç®—ä¸¦é è¦½ â†’</button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 3 -->
      <div class="step-content" id="step3">
        <h2>æ­¥é©Ÿ 3ï¼šé¸æ“‡ç‡Ÿé¤Šæ¨™ç¤ºæ ¼å¼</h2>
        <div class="info-box"><strong>è«‹é¸æ“‡æ¨™ç¤ºæ ¼å¼ï¼š</strong></div>
        <div class="form-group" id="formatOptions"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="backToDataEntry()">â† è¿”å›æ•¸æ“šå¡«å¯«</button>
          <button class="btn btn-primary" onclick="generatePreview()">ç”Ÿæˆé è¦½ â†’</button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 4 -->
      <div class="step-content" id="step4">
        <h2>æ­¥é©Ÿ 4ï¼šé è¦½èˆ‡ä¸‹è¼‰</h2>
        <div class="preview-section">
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h3>ç‡Ÿé¤Šæ¨™ç¤ºé è¦½</h3>
    <button id="btnRegen" class="btn btn-secondary" type="button">ğŸ” é‡æ–°è©•ä¼°</button>
  </div>
  <div class="preview-grid" id="previewArea"></div>
</div>


      </div>
    </div>
  </div>

  <script>
	  // âœ… å·¥å…·ï¼šå›å‚³æœ€å¾Œè¦é¡¯ç¤ºçš„ç‡Ÿé¤Šç´ åç¨±
// è®“é è¦½ï¼åŒ¯å‡ºéƒ½èƒ½é¡¯ç¤ºæœ‰æ©Ÿé…¸è‡ªè¨‚åç¨±
function getDisplayedNutrientName(n){
  const custom = (n && n.organicAcidName || '').trim();
  if (n && n.isOrganicAcid && custom) return custom; // ä¾‹å¦‚ã€Œæª¸æª¬é…¸ã€
  return n ? n.name : '';
}


	/* ===== å–®ä¸€å€å¡Š Excel ä¸‹è¼‰ï¼ˆ.xlsx HTMLï¼šå¯ä¿è­‰æ¡†ç·š/è‡ªå‹•æ›è¡Œ/æ¬„å¯¬ï¼‰===== */
/* èªªæ˜ï¼šç”¨ HTML Table ç”¢ç”Ÿ .xlsxï¼ˆExcel å¯ç›´æ¥é–‹å•Ÿï¼‰ï¼Œ
   å„ªé»æ˜¯å¯ç¢ºä¿æ¡†ç·šã€æ›è¡Œã€æ¬„å¯¬ï¼Œé¿å… SheetJS ç¤¾ç¾¤ç‰ˆç„¡æ³•å¯«å…¥æ¨£å¼çš„é™åˆ¶ã€‚ */

function excelEscape(text=''){
  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function buildVerticalTableHTML() {
  const esc = (s='') => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const unit = formData.unit;
  const isFmt3 = formData.selectedFormat === 'format3';

  let headRows = `
    <tr><th colspan="3" style="font-size:14pt;">ç‡Ÿé¤Šæ¨™ç¤º</th></tr>
    <tr><td>æ¯ä¸€ä»½é‡</td><td colspan="2">${(formData.servingSize || 0).toFixed(2)} ${isFmt3 ? 'é¡†/éŒ /ç²’' : unit}</td></tr>
    <tr><td>æœ¬åŒ…è£å«</td><td colspan="2">${formData.servingsPerContainer} ä»½</td></tr>
    <tr>
      <td></td>
      <td><b>æ¯ä»½</b></td>
      <td>${formData.selectedFormat==='format1' ? `<b>æ¯ 100 ${unit}</b>` : `<b>æ¯æ—¥åƒè€ƒå€¼ç™¾åˆ†æ¯”</b>`}</td>
    </tr>
  `;

  const rows = [];
  const pushRow = (name, perServing, per100OrPct, unitShort, isVM=false, isKcal=false) => {
    const f = isVM ? fmtSig3 : fmt;
    const left = esc(name);
    const mid = isKcal ? `${f(perServing)} å¤§å¡` : `${f(perServing)} ${getUnitText(unitShort)}`;
    rows.push(`<tr><td>${left}</td><td style="text-align:right">${esc(mid)}</td><td style="text-align:right">${esc(per100OrPct)}</td></tr>`);
  };

  if (formData.selectedFormat === 'format1') {
    pushRow('ç†±é‡', formData.perServing.calories, `${fmt(formData.nutrients.calories)} å¤§å¡`, 'kcal', false, true);
    pushRow('è›‹ç™½è³ª', formData.perServing.protein, `${fmt(formData.nutrients.protein||0)} å…¬å…‹`, 'g');
    pushRow('è„‚è‚ª', formData.perServing.fat, `${fmt(formData.nutrients.fat||0)} å…¬å…‹`, 'g');
    pushRow('é£½å’Œè„‚è‚ª', formData.perServing.saturatedFat, `${fmt(formData.nutrients.saturatedFat||0)} å…¬å…‹`, 'g');
    pushRow('åå¼è„‚è‚ª', formData.perServing.transFat, `${fmt(formData.nutrients.transFat||0)} å…¬å…‹`, 'g');
    pushRow('ç¢³æ°´åŒ–åˆç‰©', formData.perServing.carbs, `${fmt(formData.nutrients.carbs||0)} å…¬å…‹`, 'g');
    pushRow('ç³–', formData.perServing.sugar, `${fmt(formData.nutrients.sugar||0)} å…¬å…‹`, 'g');
    pushRow('éˆ‰', formData.perServing.sodium, `${fmt(formData.nutrients.sodium||0)} æ¯«å…‹`, 'mg');

    // ğŸ” é€™è£¡ç”¨é¡¯ç¤ºåç¨±
    formData.additionalNutrients.forEach(n=>{
      const per = Number(n.value||0) * (formData.servingSize/100);
      const isVM = isVitaminMineralName(n.name);
      const f = isVM ? fmtSig3 : fmt;
      const dispName = getDisplayedNutrientName(n);
      rows.push(`<tr>
        <td>${esc(dispName)}</td>
        <td style="text-align:right">${esc(`${f(per)} ${getUnitText(n.unit)}`)}</td>
        <td style="text-align:right">${esc(`${f(n.value)} ${getUnitText(n.unit)}`)}</td>
      </tr>`);
    });

  } else {
    // æ ¼å¼2/3çš„ builder åœ¨é€™å€‹ .xlsx è¼¸å‡ºä¸­ä¸æœƒç”¨åˆ° DV è¨ˆç®—ï¼Œä¿ç•™ä½ åŸæœ¬é‚è¼¯å³å¯
    // è‹¥ä½ å·²ç¶“æ”¹æˆæ”¯æ´æ ¼å¼2/3ï¼Œä¹Ÿè«‹æŠŠ n.name â†’ getDisplayedNutrientName(n)
    // é€™è£¡çœç•¥ï¼ˆé¿å…å¤ªé•·ï¼‰ï¼Œæ ¸å¿ƒæ˜¯ï¼šé¡¯ç¤ºåç¨±éƒ½ç”¨ dispName
  }

  return `
  <table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse; table-layout:fixed; width:980px;">
    <colgroup>
      <col style="width:320px;"><col style="width:330px;"><col style="width:330px;">
    </colgroup>
    <tbody>${headRows}${rows.join('')}</tbody>
  </table>`;
}

function buildHorizontalTableHTML() {
  const esc = (s='') => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const unit = formData.unit;
  const lines = [];

  if (formData.selectedFormat === 'format1') {
    let add = '';
    formData.additionalNutrients.forEach(n=>{
      const per = Number(n.value||0) * (formData.servingSize/100);
      const isVM = isVitaminMineralName(n.name);
      const f = isVM ? fmtSig3 : fmt;
      const dispName = getDisplayedNutrientName(n);              // â¬…ï¸ ç”¨é¡¯ç¤ºåç¨±
      add += `ã€${dispName}${f(per)}${getUnitText(n.unit)}ï¼ˆ${f(n.value)}${getUnitText(n.unit)}ï¼‰`;
    });

    lines.push(`æ¯ä¸€ä»½é‡${(formData.servingSize||0).toFixed(2)}${unit}ï¼›æœ¬åŒ…è£å«${formData.servingsPerContainer}ä»½ã€‚`);
    lines.push(
      `æ¯ä»½ï¼ˆæ¯100${unit}ï¼‰ï¼š` +
      `ç†±é‡${fmt(formData.perServing.calories)}å¤§å¡ï¼ˆ${fmt(formData.nutrients.calories)}å¤§å¡ï¼‰ã€` +
      `è›‹ç™½è³ª${fmt(formData.perServing.protein)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.protein||0)}å…¬å…‹ï¼‰ã€` +
      `è„‚è‚ª${fmt(formData.perServing.fat)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.fat||0)}å…¬å…‹ï¼‰ã€` +
      `é£½å’Œè„‚è‚ª${fmt(formData.perServing.saturatedFat)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.saturatedFat||0)}å…¬å…‹ï¼‰ã€` +
      `åå¼è„‚è‚ª${fmt(formData.perServing.transFat)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.transFat||0)}å…¬å…‹ï¼‰ã€` +
      `ç¢³æ°´åŒ–åˆç‰©${fmt(formData.perServing.carbs)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.carbs||0)}å…¬å…‹ï¼‰ã€` +
      `ç³–${fmt(formData.perServing.sugar)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.sugar||0)}å…¬å…‹ï¼‰ã€` +
      `éˆ‰${fmt(formData.perServing.sodium)}æ¯«å…‹ï¼ˆ${fmt(formData.nutrients.sodium||0)}æ¯«å…‹)` +
      `${add}ã€‚`
    );
  } else {
    // åŒä¸Šï¼Œè‹¥ä½ ä¹Ÿåœ¨é€™è£¡è¼¸å‡ºæ ¼å¼2/3ï¼Œè¨˜å¾—æŠŠ n.name â†’ getDisplayedNutrientName(n)
  }

  return `
  <table border="1" cellspacing="0" cellpadding="8" style="border-collapse:collapse; table-layout:fixed; width:980px;">
    <colgroup><col style="width:980px;"></colgroup>
    <tbody>
      <tr><th style="font-size:14pt;">ç‡Ÿé¤Šæ¨™ç¤ºï¼ˆæ©«å¼ï¼‰</th></tr>
      ${lines.map(s=>`<tr><td style="white-space:pre-wrap; word-wrap:break-word;">${esc(s)}</td></tr>`).join('')}
    </tbody>
  </table>`;
}



/** åŒ¯å‡ºæŒ‡å®šé è¦½å¡Šç‚º .xlsxï¼ˆä¾ nodeId åˆ¤æ–·ç›´/æ©«å¼ï¼‰ */
function downloadSingleExcel(nodeId, filename='ç‡Ÿé¤Šæ¨™ç¤º.xlsx'){
  // æ©«å¼ id å…§å« Horizontal
  const isHorizontal = /Horizontal$/.test(nodeId);
  const tableHTML = isHorizontal ? buildHorizontalTableHTML() : buildVerticalTableHTML();

  const html = `<!DOCTYPE html>
  <html lang="zh-TW"><head><meta charset="UTF-8">
  <title>ç‡Ÿé¤Šæ¨™ç¤º</title>
  </head><body>${tableHTML}</body></html>`;

  const blob = new Blob([html], {type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.rel='noopener'; a.download=filename.endsWith('.xlsx')?filename:(filename+'.xlsx');
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 0);
}
  
	  /* ===== å–®ä¸€å€å¡Šä¸‹è¼‰å·¥å…·ï¼ˆåªä¸‹è¼‰è¢«é»æ“Šçš„é‚£ä¸€å¡Šï¼‰===== */
function cloneWithoutNoDownload(node){
  const clone = node.cloneNode(true);
  clone.querySelectorAll('[data-nodownload="true"]').forEach(n=>n.remove());
  return clone;
}

async function downloadSinglePDF(nodeId, filename='ç‡Ÿé¤Šæ¨™ç¤º.pdf'){
  const node = document.getElementById(nodeId);
  if (!node){ alert('æ‰¾ä¸åˆ°å¯ä¸‹è¼‰çš„å€å¡Š'); return; }
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const pad = 24;

  const clean = cloneWithoutNoDownload(node);
  const tmp = document.createElement('div');
  tmp.style.position='fixed'; tmp.style.left='-99999px'; tmp.style.top='-99999px';
  tmp.appendChild(clean); document.body.appendChild(tmp);

  const canvas = await html2canvas(clean, { scale: 2, backgroundColor:'#ffffff' });
  const img = canvas.toDataURL('image/png');
  const s = Math.min((pageW - pad*2)/canvas.width, (pageH - pad*2)/canvas.height);
  const w = canvas.width*s, h = canvas.height*s, x = (pageW - w)/2, y = (pageH - h)/2;
  pdf.addImage(img, 'PNG', x, y, w, h);

  tmp.remove();
  pdf.save(filename);
}

function downloadSingleHTML(nodeId, filename='ç‡Ÿé¤Šæ¨™ç¤º.html'){
  const node = document.getElementById(nodeId);
  if (!node){ alert('æ‰¾ä¸åˆ°å¯ä¸‹è¼‰çš„å€å¡Š'); return; }
  const htmlFrag = cloneWithoutNoDownload(node).outerHTML;
  const css = `
    body{font-family:'Microsoft JhengHei',sans-serif;padding:20px}
    .nutrition-table{margin:20px 0;border:2px solid #333;border-radius:8px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #333}
    th{background:#495057;color:#fff}
    .horizontal-label{border:2px solid #333;padding:20px;margin:20px 0;border-radius:8px;line-height:1.8}
    .text-right{text-align:right}
    .dv-text{margin-top:10px}
  `;
  const html = `<!DOCTYPE html><html lang="zh-TW"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>ç‡Ÿé¤Šæ¨™ç¤º</title><style>${css}</style></head><body>${htmlFrag}</body></html>`;
  const blob = new Blob([html], {type:'text/html;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.rel='noopener'; a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 0);
}

    /* ===== å¯é¸é …ç›®èˆ‡å–®ä½è¦å‰‡ ===== */
    const nutrientOptions = {
      protein:['æ”¯éˆèƒºåŸºé…¸','å¤©é–€å†¬èƒºé…¸','é…¥èƒºé…¸','çµ²èƒºé…¸','éº©èƒºé…¸','éº©é†¯èƒºé…¸','è„¯èƒºé…¸','ç”˜èƒºé…¸','ä¸™èƒºé…¸','èƒ±èƒºé…¸','çºˆèƒºé…¸','ç”²ç¡«èƒºé…¸','ç•°ç™½èƒºé…¸','ç™½èƒºé…¸','é…ªèƒºé…¸','è‹¯ä¸™èƒºé…¸','é›¢èƒºé…¸','çµ„èƒºé…¸','ç²¾èƒºé…¸','è‰²èƒºé…¸','ç‰›ç£ºé…¸','å…¶ä»–'],
      fat:['è†½å›ºé†‡','ä¸­éˆè„‚è‚ªé…¸','æ”¯éˆè„‚è‚ªé…¸','ä¸é£½å’Œè„‚è‚ªé…¸','å–®å…ƒä¸é£½å’Œè„‚è‚ªé…¸','å¤šå…ƒä¸é£½å’Œè„‚è‚ªé…¸','Ï‰-3è„‚è‚ªé…¸','Ï‰-6è„‚è‚ªé…¸','é…ªé…¸','å·±é…¸','è¾›é…¸','ç™¸é…¸','æœˆæ¡‚é…¸','è‚‰è±†è”»é…¸','æ£•æ«šé…¸','ç¡¬è„‚é…¸','èŠ±ç”Ÿé…¸','æ£•æ«šçƒ¯é…¸','æ²¹é…¸','äºéº»æ²¹é…¸','æ¬¡äºéº»æ²¹é…¸','èŠ±ç”Ÿæ²¹é…¸','äºŒåç¢³äº”çƒ¯é…¸(EPA)','äºŒåäºŒç¢³å…­çƒ¯é…¸(DHA)','å…¶ä»–'],
      carb:['ä¹³ç³–','è†³é£Ÿçº–ç¶­','æ°´æº¶æ€§è†³é£Ÿçº–ç¶­','é›£æ¶ˆåŒ–ç³Šç²¾(è†³é£Ÿçº–ç¶­)','Î²-è‘¡èšé†£(è†³é£Ÿçº–ç¶­)','æœå¯¡ç³–(è†³é£Ÿçº–ç¶­)','èŠç³–(è†³é£Ÿçº–ç¶­)','èµ¤è—»ç³–é†‡','æœ¨ç³–é†‡','å±±æ¢¨ç³–é†‡','å…¶ä»–ç³–é†‡','å…¶ä»–'],
      vitamin:['ç¶­ç”Ÿç´ A','ç¶­ç”Ÿç´ B1','ç¶­ç”Ÿç´ B2','ç¶­ç”Ÿç´ B6','ç¶­ç”Ÿç´ B12','ç¶­ç”Ÿç´ C','ç¶­ç”Ÿç´ D','ç¶­ç”Ÿç´ E','ç¶­ç”Ÿç´ K','è¸é¹¼ç´ ','æ³›é…¸','è‘‰é…¸','ç”Ÿç‰©ç´ ','è†½ç´ ','è‚Œé†‡','è‘‰é»ƒç´ ','å…¶ä»–'],
      mineral:['éˆ£','ç£·','éˆ‰','æ°¯','é‰€','ç¡«','é‚','éµ','ç¢˜','æ°Ÿ','é‹…','éŠ…','é‰»','ç¡’','éŒ³','éˆ·','é‰¬','ç¡¼','é³','çŸ½','éŒ«','é‡©','å…¶ä»–'],
      other:['ç†±é‡','è›‹ç™½è³ª','è„‚è‚ª','é£½å’Œè„‚è‚ª','åå¼è„‚è‚ª','ç¢³æ°´åŒ–åˆç‰©','ç³–','éˆ‰','é…’ç²¾ï¼ˆä¹™é†‡ï¼‰','æœ‰æ©Ÿé…¸é¡ï¼ˆéœ€è¼¸å…¥åç¨±ï¼‰','ç†±é‡']
    };

    // é–å®šå–®ä½
    const vitaminUnitMap = {
      'ç¶­ç”Ÿç´ A': { mainLabel:'å¾®å…‹ RE', mainUnit:'mcgRE', allowIU:true },
      'ç¶­ç”Ÿç´ B1': { mainLabel:'æ¯«å…‹', mainUnit:'mg' },
      'ç¶­ç”Ÿç´ B2': { mainLabel:'æ¯«å…‹', mainUnit:'mg' },
      'ç¶­ç”Ÿç´ B6': { mainLabel:'æ¯«å…‹', mainUnit:'mg' },
      'ç¶­ç”Ÿç´ B12': { mainLabel:'å¾®å…‹', mainUnit:'mcg' },
      'ç¶­ç”Ÿç´ C': { mainLabel:'æ¯«å…‹', mainUnit:'mg' },
      'ç¶­ç”Ÿç´ D': { mainLabel:'å¾®å…‹', mainUnit:'mcg', allowIU:true },
      'ç¶­ç”Ÿç´ E': { mainLabel:'æ¯«å…‹ a-TE', mainUnit:'mgTE', allowIU:true },
      'ç¶­ç”Ÿç´ K': { mainLabel:'å¾®å…‹', mainUnit:'mcg' },
      'è¸é¹¼ç´ ':   { mainLabel:'æ¯«å…‹ NE', mainUnit:'mg' },
      'è‘‰é…¸':     { mainLabel:'å¾®å…‹', mainUnit:'mcg' },
      'æ³›é…¸':     { mainLabel:'æ¯«å…‹', mainUnit:'mg' },
      'ç”Ÿç‰©ç´ ':   { mainLabel:'å¾®å…‹', mainUnit:'mcg' },
      'è†½ç´ ':     { mainLabel:'æ¯«å…‹', mainUnit:'mg' },
      'è‚Œé†‡':     { mainLabel:'æ¯«å…‹', mainUnit:'mg' },
      'è‘‰é»ƒç´ ':   { mainLabel:'æ¯«å…‹', mainUnit:'mg' }
    };
    const mineralUnitMap = {
      'éˆ£':'mg','ç£·':'mg','éˆ‰':'mg','æ°¯':'mg','é‰€':'mg','ç¡«':'mg','é‚':'mg','éµ':'mg','ç¢˜':'mcg','æ°Ÿ':'mg','é‹…':'mg','éŠ…':'mg','é‹°':'mg','é‰»':'mcg','ç¡’':'mcg','éŒ³':'mg','éˆ·':'mg','é‰¬':'mcg','ç¡¼':'mg','é³':'mg','çŸ½':'mg','éŒ«':'mg','é‡©':'mg'
    };

    // æ¯æ—¥åƒè€ƒå€¼ï¼ˆä¾ä½ æä¾›è¡¨æ ¼ï¼‰
    const dailyValues = {
      over4:{ // å››æ­²ä»¥ä¸Š
        calories:2000, protein:60, fat:60, carbs:300, sodium:2000, saturatedFat:18, cholesterol:300, fiber:25,
        vitaminA:700, vitaminB1:1.4, vitaminB2:1.6, vitaminB6:1.6, vitaminB12:2.4, vitaminC:100, vitaminD:10, vitaminE:13,
        vitaminK:120, niacin:18, folate:400, pantothenicAcid:5, biotin:30, choline:500, calcium:1200, phosphorus:1000,
        iron:15, iodine:140, magnesium:390, zinc:15, fluorine:3, selenium:55
      },
      '1to3':{ // ä¸€æ­²è‡³ä¸‰æ­²ï¼ˆï¼Šè¡¨ç¤ºæœªè¨‚å®šè€…ï¼šfatã€carbsã€saturatedFatã€cholesterolï¼‰
        calories:1200, protein:20, sodium:1200, fiber:15,
        vitaminA:400, vitaminB1:0.6, vitaminB2:0.7, vitaminB6:0.5, vitaminB12:0.9, vitaminC:40, vitaminD:5, vitaminE:5,
        vitaminK:30, niacin:9, folate:170, pantothenicAcid:2, biotin:9, choline:180, calcium:500, phosphorus:400,
        iron:10, iodine:65, magnesium:80, zinc:5, fluorine:0.7, selenium:20
      },
      pregnant:{ // å­•ä¹³å©¦
        calories:2200, protein:65, fat:65, carbs:330, sodium:2000, saturatedFat:18, cholesterol:300, fiber:30,
        vitaminA:600, vitaminB1:1.1, vitaminB2:1.2, vitaminB6:1.9, vitaminB12:2.6, vitaminC:110, vitaminD:10, vitaminE:14,
        vitaminK:90, niacin:16, folate:600, pantothenicAcid:6, biotin:30, choline:410, calcium:1000, phosphorus:800,
        iron:45, iodine:200, magnesium:355, zinc:15, fluorine:3, selenium:60
      }
    };

    /* ===== ç‹€æ…‹ ===== */
    let formData = {
      productType:'', specificType:'', ageGroup:'', unit:'å…¬å…‹',
      servingSize:0, servingsPerContainer:0, capsuleUnitLabel:'é¡†',
      nutrients:{}, vitamins:[], minerals:[], additionalNutrients:[],
      selectedFormat:'', availableFormats:[]
    };
    let additionalNutrientCount=0, vitaminCount=0, mineralCount=0;

    /* ===== å°è¦½ ===== */
    function nextStep(currentStep){
      const steps=['step1','step1-2','step1-3'];
      if (currentStep===1){
  const productType=document.querySelector('input[name="productType"]:checked');
  if(!productType){ alert('è«‹é¸æ“‡ç”¢å“å‹æ…‹'); return; }
  formData.productType=productType.value;
  
  if (productType.value==='solid'){ 
    formData.unit='å…¬å…‹'; 
  }
  else if (productType.value==='liquid'){ 
    formData.unit='æ¯«å‡'; 
    document.getElementById('capsule').style.display='none'; 
    document.getElementById('vitaminCapsule').style.display='none'; 
  }
  else { 
    // å›ºæ¶²æ··åˆï¼šè®“ä½¿ç”¨è€…é¸æ“‡
    const unitChoice=prompt('è«‹é¸æ“‡å–®ä½ï¼ˆè¼¸å…¥ 1=å…¬å…‹ï¼Œ2=æ¯«å‡ï¼‰ï¼š');
    if (unitChoice==='2') {
      formData.unit='æ¯«å‡';
      formData.productType='liquid'; // æ”¹ç‚ºæ¶²é«”é‚è¼¯
      document.getElementById('capsule').closest('.radio-option').style.display='none'; 
      document.getElementById('vitaminCapsule').closest('.radio-option').style.display='none';
    } else {
      formData.unit='å…¬å…‹';
      formData.productType='solid'; // æ”¹ç‚ºå›ºé«”é‚è¼¯
    }
  }
}
      if (currentStep===2){
  const sp=document.querySelector('input[name="specificType"]:checked');
  if(!sp){ alert('è«‹é¸æ“‡ç”¢å“å‹æ…‹'); return; }
  formData.specificType=sp.value;
  
  // è† å›ŠéŒ ç‹€æ™‚éš±è—ã€Œæœªæ»¿ä¸€æ­²ã€é¸é …
  const under1Option = document.getElementById('under1').parentElement;
  if (sp.value==='capsule' || sp.value==='vitaminCapsule'){
    under1Option.style.display='none';
  } else {
    under1Option.style.display='block';
  }
}
      document.getElementById(steps[currentStep-1]).classList.remove('active');
      document.getElementById(steps[currentStep]).classList.add('active');
      updateProgressBar(currentStep+1);
    }
    function prevStep(toStep){
      const steps=['step1','step1-2','step1-3'];
      const i=steps.findIndex(s=>document.getElementById(s).classList.contains('active'));
      document.getElementById(steps[i]).classList.remove('active');
      document.getElementById(steps[toStep-1]).classList.add('active');
      updateProgressBar(toStep);
    }
    function toDataEntry(){
      const age=document.querySelector('input[name="ageGroup"]:checked');
      if(!age){ alert('è«‹é¸æ“‡é©ç”¨å¹´é½¡'); return; }
      formData.ageGroup=age.value;
	

      determineAvailableFormats();
      updateUnitDisplays();
      const isCapsuleLike=(formData.specificType==='capsule'||formData.specificType==='vitaminCapsule');
      document.getElementById('basicInfoBox').style.display = isCapsuleLike ? 'none' : 'block';
      document.getElementById('capsuleModeBox').style.display = isCapsuleLike ? 'block' : 'none';

      if (formData.specificType==='vitaminCapsule'){
        document.getElementById('basicNutrients').style.display='none';
        document.getElementById('vitaminMineralSection').style.display='block';
      }else{
        document.getElementById('basicNutrients').style.display='block';
        document.getElementById('vitaminMineralSection').style.display='none';
      }

      if (isCapsuleLike){
        document.getElementById('capsuleModeCount').checked=true;
        document.getElementById('capsuleCountFields').style.display='grid';
        document.getElementById('capsuleWeightFields').style.display='none';
      }else{
        document.getElementById('unitDisplay').textContent=formData.unit;
      }

      // åœ¨æ ¼å¼3éš±è—é¡åˆ¥ä¸‹æ‹‰ä¸­çš„ ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ª
      document.querySelectorAll('#nutrientCategory option.vmOpt').forEach(opt=>{
        opt.style.display = (formData.specificType==='vitaminCapsule') ? 'none' : 'block';
      });

      document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active'));
      document.getElementById('step2').classList.add('active');
      updateProgressBar(2);
    }
    function determineAvailableFormats(){
      formData.availableFormats=[];
      if (formData.specificType==='vitaminCapsule') formData.availableFormats=['format3'];
      else if (formData.specificType==='capsule') formData.availableFormats=['format2'];
      else if (formData.ageGroup==='under1') formData.availableFormats=['format1'];
      else formData.availableFormats=['format1','format2'];
    }
    function updateUnitDisplays(){
      document.getElementById('per100Unit').textContent=formData.unit;
      const el=document.getElementById('unitDisplay'); if (el) el.textContent=formData.unit;
    }
    function updateProgressBar(step){
      document.querySelectorAll('.progress-step').forEach((el,idx)=>{
        el.classList.remove('active','completed');
        if (idx+1<step) el.classList.add('completed');
        else if (idx+1===step) el.classList.add('active');
      });
    }


/* ===== æ–°å¢å…¶ä»–ç‡Ÿé¤Šç´ ï¼šé¡åˆ¥è®Šæ›´ ===== */
document.getElementById('nutrientCategory').addEventListener('change', function(){
  const category = this.value;
  const specific = document.getElementById('specificNutrient');
  
  // æ¸…ç©ºä¸¦é‡ç½®
  specific.innerHTML = '<option value="">é¸æ“‡ç‡Ÿé¤Šç´ </option>';
  specific.disabled = true;
  
  if (!category) return;
  
  // æ ¼å¼3ï¼šç¦æ­¢åœ¨ã€Œæ–°å¢å…¶ä»–ç‡Ÿé¤Šç´ ã€å†é¸ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ª
  if (formData.specificType === 'vitaminCapsule' && (category === 'vitamin' || category === 'mineral')) {
    alert('æ ¼å¼3å·²æ–¼ä¸Šæ–¹å¡«å¯«ç¶­ç”Ÿç´ èˆ‡ç¤¦ç‰©è³ªï¼Œè«‹å‹¿é‡è¤‡æ–°å¢ã€‚');
    this.value = '';
    return;
  }
  
  // ç”¢ç”Ÿé¸é …
  const list = nutrientOptions[category];
  if (list && list.length > 0) {
    list.forEach(n => {
      const option = document.createElement('option');
      option.value = n;
      option.textContent = n;
      specific.appendChild(option);
    });
    specific.disabled = false;  // é—œéµï¼šå•Ÿç”¨ä¸‹æ‹‰é¸å–®
  }
});

    /* ===== å–®ä½é–å®šå·¥å…· ===== */
    const aminoList=['æ”¯éˆèƒºåŸºé…¸','å¤©é–€å†¬èƒºé…¸','é…¥èƒºé…¸','çµ²èƒºé…¸','éº©èƒºé…¸','éº©é†¯èƒºé…¸','è„¯èƒºé…¸','ç”˜èƒºé…¸','ä¸™èƒºé…¸','èƒ±èƒºé…¸','çºˆèƒºé…¸','ç”²ç¡«èƒºé…¸','ç•°ç™½èƒºé…¸','ç™½èƒºé…¸','é…ªèƒºé…¸','è‹¯ä¸™èƒºé…¸','é›¢èƒºé…¸','çµ„èƒºé…¸','ç²¾èƒºé…¸','è‰²èƒºé…¸','ç‰›ç£ºé…¸'];

    function fixedUnitForName(category, name){
  // å›ºå®šå–®ä½ï¼ˆåç¨±ç›´è¦ºå„ªå…ˆï¼‰
  if (name === 'ç†±é‡') return { unit:'kcal', label:'å¤§å¡', lock:true };
  if (name === 'éˆ‰' || name === 'è†½å›ºé†‡' || aminoList.includes(name)) return { unit:'mg', label:'æ¯«å…‹', lock:true };
  if (name.includes('è†³é£Ÿçº–ç¶­')) return { unit:'g', label:'å…¬å…‹', lock:true };
  if (name === 'é£½å’Œè„‚è‚ª' || name === 'åå¼è„‚è‚ª') return { unit:'g', label:'å…¬å…‹', lock:true };

  // å¤§å®—ä¸‰å¤§ç‡Ÿé¤Šç´ èˆ‡å¸¸è¦‹æ¬„ä½
  if (category==='protein' || category==='fat' || category==='carb' || category==='other'){
    if (['ç³–','ç¢³æ°´åŒ–åˆç‰©','è„‚è‚ª','è›‹ç™½è³ª'].includes(name)) return { unit:'g', label:'å…¬å…‹', lock:true };
  }

  // ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ªå›ºå®šå–®ä½
  if (category==='vitamin'){
    const cfg = vitaminUnitMap[name];
    if (cfg) return { unit: cfg.mainUnit, label: cfg.mainLabel, lock:true };
  }
  if (category==='mineral'){
    const u = mineralUnitMap[name] || 'mg';
    return { unit: u, label: (u==='mcg'?'å¾®å…‹':'æ¯«å…‹'), lock:true };
  }

  // é è¨­
  return { unit:'mcg', label:'å¾®å…‹', lock:false };
}


    function renderLockedOrSelect(container, name, fixed){
  if (fixed.lock){
    container.innerHTML += `
      <div>
        <label>å–®ä½ï¼ˆå›ºå®šï¼‰</label>
        <div class="input-field" style="background:#fff">${fixed.label}</div>
        <input type="hidden" data-unit="${name}" value="${fixed.unit}">
      </div>
    `;
  }else{
    container.innerHTML += `
      <div>
        <label>å–®ä½</label>
        <select class="input-field" data-unit="${name}">
          <option value="g">å…¬å…‹</option>
          <option value="mg">æ¯«å…‹</option>
          <option value="mcg" selected>å¾®å…‹</option>
        </select>
      </div>
    `;
  }
}

function addNutrient(){
  const category=document.getElementById('nutrientCategory').value;
  const nutrient=document.getElementById('specificNutrient').value;
  if(!category||!nutrient){ alert('è«‹é¸æ“‡ç‡Ÿé¤Šç´ é¡åˆ¥å’Œåç¨±'); return; }

  if (formData.specificType==='vitaminCapsule' && (category==='vitamin' || category==='mineral')){
    alert('æ ¼å¼3å·²æ–¼ä¸Šæ–¹å¡«å¯«ç¶­ç”Ÿç´ èˆ‡ç¤¦ç‰©è³ªï¼Œè«‹å‹¿é‡è¤‡æ–°å¢ã€‚'); return;
  }

  additionalNutrientCount++;
  const id=`additional-${additionalNutrientCount}`;
  const container=document.getElementById('additionalNutrients');
  const card=document.createElement('div'); card.className='nutrient-item'; card.id=id;

  const isFormat3=(formData.specificType==='vitaminCapsule');
  const valueLabel=isFormat3?'å«é‡ï¼ˆæ¯ä»½ï¼‰':'å«é‡ï¼ˆæ¯100'+formData.unit+'ï¼‰';
  card.innerHTML = `<label>${nutrient}</label><div class="input-grid" style="margin-top:6px;" id="${id}-grid"></div>
    <button class="btn btn-secondary" onclick="removeNutrient('${id}')" style="margin-top:8px;width:100%">ç§»é™¤</button>`;
  container.appendChild(card);

  const grid=document.getElementById(`${id}-grid`);
  const fixed = fixedUnitForName(category, nutrient);

  // æ•¸å€¼æ¬„ï¼ˆç†±é‡é¡¯ç¤ºæˆã€Œæ¯ä»½ï¼ˆå¤§å¡ï¼‰ã€ï¼›å…¶é¤˜ç…§èˆŠï¼‰
  const valueLabelText = (nutrient==='ç†±é‡') ? 'å«é‡ï¼ˆæ¯ä»½ï¼Œå¤§å¡ï¼‰' : valueLabel;
  grid.innerHTML = `
    <div>
      <label>${valueLabelText}</label>
      <input type="number" class="input-field" data-nutrient="${nutrient}" placeholder="0" step="0.01">
    </div>
  `;
  renderLockedOrSelect(grid, nutrient, fixed);

  // ğŸ”¶ æœ‰æ©Ÿé…¸é¡ï¼šè¿½åŠ ã€Œè‡ªè¨‚åç¨±ã€æ¬„ä½ï¼Œä¸¦æ¨™è¨˜æ——æ¨™ï¼ˆä¾›å¾ŒçºŒç†±é‡è¨ˆç®—ï¼‰
  if (nutrient === 'æœ‰æ©Ÿé…¸é¡ï¼ˆéœ€è¼¸å…¥åç¨±ï¼‰'){
    const ext = document.createElement('div');
    ext.innerHTML = `
      <div>
        <label>æœ‰æ©Ÿé…¸åç¨±</label>
        <input type="text" class="input-field" data-organic-acid-name="${id}" placeholder="ä¾‹ï¼šæª¸æª¬é…¸">
        <input type="hidden" data-is-organic-acid="${id}" value="1">
      </div>
    `;
    grid.appendChild(ext);
  }

  // reset ä¸‹æ‹‰
  document.getElementById('nutrientCategory').value='';
  const sp=document.getElementById('specificNutrient'); sp.value=''; sp.disabled=true;
}

    function removeNutrient(id){ const el=document.getElementById(id); if(el) el.remove(); }

    /* ===== æ ¼å¼3ï¼šç¶­ç”Ÿç´ ï¼ç¤¦ç‰©è³ªæ¬„ ===== */
    function addVitaminInput(){
      vitaminCount++; const id=`vitamin-${vitaminCount}`;
      const wrap=document.createElement('div'); wrap.className='nutrient-item'; wrap.id=id;
      wrap.innerHTML = `
        <label>é¸æ“‡ç¶­ç”Ÿç´ </label>
        <select class="input-field" data-vitamin-name="${id}" onchange="onVitaminChange('${id}')">
          <option value="">é¸æ“‡ç¶­ç”Ÿç´ </option>
          ${nutrientOptions.vitamin.map(v=>`<option value="${v}">${v}</option>`).join('')}
        </select>
        <div class="input-grid" id="${id}-fields" style="margin-top:6px;"></div>
        <button class="btn btn-secondary" onclick="removeVitamin('${id}')" style="margin-top:8px;width:100%">ç§»é™¤</button>
      `;
      document.getElementById('vitaminInputs').appendChild(wrap);
    }
    function onVitaminChange(id){
      const sel=document.querySelector(`[data-vitamin-name="${id}"]`);
      const name=sel.value;
      const fields=document.getElementById(`${id}-fields`);
      fields.innerHTML='';
      if (!name) return;

      const cfg=vitaminUnitMap[name];
      if (cfg){
        const main = document.createElement('div');
        main.innerHTML = `
          <label>${name}ï¼ˆ${cfg.mainLabel}ï¼‰</label>
          <input type="number" class="input-field" data-vitamin-main-value="${id}" placeholder="0" step="0.01">
          <input type="hidden" data-vitamin-main-unit="${id}" value="${cfg.mainUnit}">
        `;
        fields.appendChild(main);

        if (cfg.allowIU){
          const iu = document.createElement('div');
          iu.innerHTML = `
            <label>${name}ï¼ˆIUï¼Œå¿…å¡«ï¼‰</label>
            <input type="number" class="input-field" data-vitamin-iu-value="${id}" placeholder="0" step="0.01" required>
            <input type="hidden" data-vitamin-iu-unit="${id}" value="IU">
          `;
          fields.appendChild(iu);
        }
      }else{
        const generic = document.createElement('div');
        generic.innerHTML = `
          <label>${name}ï¼ˆè«‹é¸å–®ä½ï¼‰</label>
          <input type="number" class="input-field" data-vitamin-main-value="${id}" placeholder="0" step="0.01">
          <select class="input-field" data-vitamin-main-unit="${id}">
            <option value="mg" selected>æ¯«å…‹</option>
            <option value="mcg">å¾®å…‹</option>
          </select>
        `;
        fields.appendChild(generic);
      }
    }
    function removeVitamin(id){ const el=document.getElementById(id); if(el) el.remove(); }

    function addMineralInput(){
      mineralCount++; const id=`mineral-${mineralCount}`;
      const wrap=document.createElement('div'); wrap.className='nutrient-item'; wrap.id=id;
      wrap.innerHTML = `
        <label>é¸æ“‡ç¤¦ç‰©è³ª</label>
        <select class="input-field" data-mineral-name="${id}" onchange="onMineralChange('${id}')">
          <option value="">é¸æ“‡ç¤¦ç‰©è³ª</option>
          ${nutrientOptions.mineral.map(m=>`<option value="${m}">${m}</option>`).join('')}
        </select>
        <div class="input-grid" id="${id}-fields" style="margin-top:6px;"></div>
        <button class="btn btn-secondary" onclick="removeMineral('${id}')" style="margin-top:8px;width:100%">ç§»é™¤</button>
      `;
      document.getElementById('mineralInputs').appendChild(wrap);
    }
    function onMineralChange(id){
      const sel=document.querySelector(`[data-mineral-name="${id}"]`);
      const name=sel.value;
      const fields=document.getElementById(`${id}-fields`);
      fields.innerHTML='';
      if (!name) return;

      const unit = mineralUnitMap[name] || 'mg';
      const block = document.createElement('div');
      const label = unit==='mcg' ? 'å¾®å…‹' : 'æ¯«å…‹';
      block.innerHTML = `
        <label>${name}ï¼ˆæ¯ä»½ï¼Œ${label}ï¼‰</label>
        <input type="number" class="input-field" data-mineral-main-value="${id}" placeholder="0" step="0.01">
        <input type="hidden" data-mineral-main-unit="${id}" value="${unit}">
      `;
      fields.appendChild(block);
    }
    function removeMineral(id){ const el=document.getElementById(id); if(el) el.remove(); }

    /* ===== è† å›Šå–®ä½å­—æ¨£ ===== */
    document.getElementById('capsuleCountLabel').addEventListener('change', e=>{
      formData.capsuleUnitLabel = e.target.value;
      document.getElementById('perPieceLabel').textContent = e.target.value;
    });

    /* ===== è¨ˆç®—èˆ‡é è¦½ ===== */
    function calculateAndPreview(){
      const isCapsuleLike=(formData.specificType==='capsule'||formData.specificType==='vitaminCapsule');

      if (isCapsuleLike){
        const modeEl=document.querySelector('input[name="capsuleMode"]:checked');
        if(!modeEl){ alert('è«‹é¸æ“‡è† å›ŠéŒ è¼¸å…¥æ¨¡å¼'); return; }

        const spc = parseFloat(document.getElementById('capsuleServingsPerContainer').value) || 0;
        if (!spc){ alert('è«‹å¡«å¯«ã€Œæœ¬åŒ…è£å«å¹¾ä»½ã€'); return; }
        formData.servingsPerContainer = spc;

        if (modeEl.value==='count'){
          const count= parseFloat(document.getElementById('capsuleCount').value) || 0;
          const unitW= parseFloat(document.getElementById('capsuleUnitWeight').value) || 0;
          const unitUnit=document.getElementById('capsuleUnitWeightUnit').value || 'g';
          if(!count||!unitW){ alert('è«‹å¡«å¯«ã€Œæ¯ä¸€ä»½é‡_æ•¸é‡ã€èˆ‡ã€Œæ¯'+formData.capsuleUnitLabel+'é‡é‡ã€'); return; }
          const perPieceG=(unitUnit==='mg')?(unitW/1000):unitW;
          const servingWeightG=count*perPieceG;
          formData.servingSize=servingWeightG; formData.unit='å…¬å…‹';
        }else{
          const w=parseFloat(document.getElementById('capsuleServingWeight').value) || 0;
          const u=document.getElementById('capsuleServingWeightUnit').value || 'g';
          if(!w){ alert('è«‹å¡«å¯«ã€Œæ¯ä¸€ä»½é‡_é‡é‡ã€'); return; }
          formData.servingSize=(u==='mg')?(w/1000):w; formData.unit='å…¬å…‹';
        }
      }else{
        formData.servingSize = parseFloat(document.getElementById('servingSize').value) || 0;
        formData.servingsPerContainer = parseFloat(document.getElementById('servingsPerContainer').value) || 0;
        if (formData.servingSize===0 || formData.servingsPerContainer===0){ alert('è«‹å¡«å¯«æ¯ä¸€ä»½é‡å’Œæœ¬åŒ…è£å«å¹¾ä»½'); return; }
      }

      if (formData.specificType==='vitaminCapsule'){
        // ç¶­ç”Ÿç´ 
        // ç¶­ç”Ÿç´ 
formData.vitamins=[];
let iuMissing = [];
document.querySelectorAll('#vitaminInputs .nutrient-item').forEach(box=>{
  const nameSel = box.querySelector('[data-vitamin-name]');
  if (!nameSel || !nameSel.value) return;
  const id = box.id;
  const mainValEl = box.querySelector(`[data-vitamin-main-value="${id}"]`);
  const mainUnitEl = box.querySelector(`[data-vitamin-main-unit="${id}"]`);
  const iuValEl   = box.querySelector(`[data-vitamin-iu-value="${id}"]`);
  const item = {
    name: nameSel.value,
    value: parseFloat(mainValEl?.value)||0,
    unit:  mainUnitEl?.value||'mg'
  };
  if (vitaminUnitMap[item.name]?.allowIU){
    const val = parseFloat(iuValEl?.value);
    if (!val){ iuMissing.push(item.name); }
    item.iu = val||0; item.iuUnit='IU';
  }
  formData.vitamins.push(item);
});

// ç¤¦ç‰©è³ªï¼ˆæ¬åˆ°æª¢æŸ¥å‰ï¼‰
formData.minerals=[];
document.querySelectorAll('#mineralInputs .nutrient-item').forEach(box=>{
  const nameSel = box.querySelector('[data-mineral-name]');
  if (!nameSel || !nameSel.value) return;
  const id = box.id;
  const mainValEl = box.querySelector(`[data-mineral-main-value="${id}"]`);
  const mainUnitEl = box.querySelector(`[data-mineral-main-unit="${id}"]`);
  formData.minerals.push({
    name: nameSel.value,
    value: parseFloat(mainValEl?.value)||0,
    unit:  mainUnitEl?.value||'mg'
  });
});

// å…ˆè™•ç† IU å¿…å¡«æé†’ï¼ˆåªé‡å° A/D/Eï¼‰
if (iuMissing.length>0){
  alert('æ ¼å¼3ï¼šç¶­ç”Ÿç´  Aï¼Dï¼E çš„ IU ç‚ºå¿…å¡«ï¼Œæœªå¡«é …ç›®ï¼š'+iuMissing.join('ã€'));
  return;
}

// å†ä¾†åšã€Œè‡³å°‘è¦æœ‰ç¶­ç”Ÿç´ æˆ–ç¤¦ç‰©è³ªã€æª¢æŸ¥
if (formData.vitamins.length===0 && formData.minerals.length===0){
  alert('è«‹è‡³å°‘æ–°å¢ä¸€é …ç¶­ç”Ÿç´ æˆ–ç¤¦ç‰©è³ª'); 
  return;
}


      }else{
        // å…«å¤§ç‡Ÿé¤Šç´ 
        formData.nutrients={};
        document.querySelectorAll('#basicNutrients input[data-nutrient]').forEach(input=>{
          const k=input.dataset.nutrient; formData.nutrients[k]=parseFloat(input.value)||0;
        });
      }

// å…¶ä»–ç‡Ÿé¤Šç´ 
formData.additionalNutrients=[];
document.querySelectorAll('#additionalNutrients .nutrient-item').forEach(item=>{
  const input=item.querySelector('input[data-nutrient]');
  if (!input) return;

  const name = input.dataset.nutrient;
  const unitHidden=item.querySelector('input[type="hidden"][data-unit]');
  const unitSelect=item.querySelector('select[data-unit]');
  const unitValue = unitHidden ? unitHidden.value : (unitSelect?.value || 'mcg');

  // æœ‰æ©Ÿé…¸é¡å¤–æ¬„ä½
  let isOrganicAcid=false, organicAcidName='';
  const acidFlag = item.querySelector('input[type="hidden"][data-is-organic-acid]');
  if (acidFlag){
    isOrganicAcid = true;
    const id = acidFlag.getAttribute('data-is-organic-acid');
    const nameEl = item.querySelector(`input[data-organic-acid-name="${id}"]`);
    organicAcidName = (nameEl?.value || '').trim();
  }

  formData.additionalNutrients.push({
    name,
    value: parseFloat(input.value)||0,
    unit: unitValue,
    isOrganicAcid,
    organicAcidName
  });
});



      if (formData.specificType!=='vitaminCapsule') calculatePerServing();
      showFormatSelection();
    }
// å»é™¤å¤šé¤˜ 0ï¼Œä¿ç•™è‡³å°‘ä¸€ä½å°æ•¸ï¼ˆe.g., "1.230"â†’"1.23", "2.0"â†’"2.0"ï¼‰
// å»é™¤å¤šé¤˜ 0ï¼ˆä¿ç•™è‡³å°‘ä¸€ä½å°æ•¸æ™‚ä¸æœƒæŠŠ .0 ç æ‰ï¼‰
function trimZeros(str){
  return String(str)
    .replace(/(\.\d*?[1-9])0+$/,'$1')
    .replace(/\.0$/,'.0');
}

// 0ï½0.05ï¼šé¡¯ç¤ºåˆ°ç¬¬ä¸€å€‹é 0 çš„ä½æ•¸ï¼Œå¾Œä¸€ä½å››æ¨äº”å…¥ï¼›å…¶ä»–ç¶­æŒ 1 ä½å°æ•¸
function fmt(value){
  const v = Number(value || 0);
  if (!Number.isFinite(v)) return String(value);
  if (v === 0) return '0.0';

  if (v > 0 && v < 0.05){
    // d = å°æ•¸ç¬¬å¹¾ä½å‡ºç¾ç¬¬ä¸€å€‹é 0ï¼›ç”¨ ceil(-log10(v)) å¯ä¸€æ¬¡ç®—å‡º
    const d = Math.ceil(-Math.log10(v));
    // ç›´æ¥ä¿ç•™åˆ° d ä½å°æ•¸ï¼ˆæœƒè‡ªå‹•å››æ¨äº”å…¥ï¼‰
    return v.toFixed(d);
  }
  // å…¶ä»–æƒ…æ³ï¼šç¶­æŒåŸæœ¬ 1 ä½å°æ•¸
  return v.toFixed(1);
}


/**
 * fmtSig3ï¼šç¶­ç”Ÿç´ /ç¤¦ç‰©è³ªé¡¯ç¤ºï¼Œé™åˆ¶æœ‰æ•ˆæ•¸å­— â‰¤ 3ï¼Œé¿å…ç§‘å­¸è¨˜è™Ÿ
 * ç”¨ Intl.NumberFormat ç›´æ¥é™åˆ¶ significantDigitsï¼Œå†å»æ‰å¤šé¤˜ 0
 */
function fmtSig3(value){
  const v = Number(value || 0);
  if (!Number.isFinite(v)) return String(value);
  if (v === 0) return '0.0';
  const s = new Intl.NumberFormat('en-US', {
    useGrouping: false,
    maximumSignificantDigits: 3
  }).format(v);
  return trimZeros(s);
}


    /* ===== ç†±é‡è¨ˆç®—ï¼ˆå«å–®ä½æ›ç®—ï¼‰ ===== */
    function calculatePerServing(){
      const ratio = formData.servingSize/100;

      const protein = formData.nutrients.protein || 0;       // g/100
      const fat = formData.nutrients.fat || 0;               // g/100
      const carbs = formData.nutrients.carbs || 0;           // g/100
      const sugar = formData.nutrients.sugar || 0;           // g/100
      const saturatedFat = formData.nutrients.saturatedFat || 0;
      const transFat = formData.nutrients.transFat || 0;
      const sodium = formData.nutrients.sodium || 0;         // mg/100
      const fiberBase = formData.nutrients.fiber || 0;       // g/100

      const sumFromExtra = (keywords)=>{
  let sumG=0;
  formData.additionalNutrients.forEach(n=>{
    const name = String(n.name||'');
    const unit = (n.unit||'g').toLowerCase();
    let v = Number(n.value)||0;

    // ğŸ”¶ è‹¥æ˜¯ã€Œæœ‰æ©Ÿé…¸ã€æ——æ¨™ï¼Œç„¡è«–åç¨±æ€éº¼å¯«éƒ½ç®—é€²ä¾†
    const isOA = !!n.isOrganicAcid;

    if (isOA || keywords.some(k=>name.includes(k))){
      if (unit==='mg') v/=1000;
      if (unit==='mcg') v/=1_000_000;
      sumG += v;
    }
  });
  return sumG;
};

      const fiberExtra = sumFromExtra(['è†³é£Ÿçº–ç¶­','æ°´æº¶æ€§è†³é£Ÿçº–ç¶­','é›£æ¶ˆåŒ–ç³Šç²¾','Î²-è‘¡èšé†£','æœå¯¡ç³–','èŠç³–']);
      const erythritol = sumFromExtra(['èµ¤è—»ç³–é†‡']); // 0 kcal
      const otherPolyols = sumFromExtra(['æœ¨ç³–é†‡','å±±æ¢¨ç³–é†‡','å…¶ä»–ç³–é†‡','éº¥èŠ½ç³–é†‡','ä¹³ç³–é†‡','ç•°éº¥èŠ½ç³–é†‡']); // 2.4
      const organicAcids = sumFromExtra(['æœ‰æ©Ÿé…¸']); // 3
      const ethanol = sumFromExtra(['é…’ç²¾','ä¹™é†‡','é…’ç²¾ï¼ˆä¹™é†‡ï¼‰']); // 7

      const fiber = fiberBase + fiberExtra; // g/100
      const netCarbsForCalories = Math.max(0, (carbs - fiber - erythritol)); // g/100

      const kcalPer100 =
        protein*4 + fat*9 +
        netCarbsForCalories*4 +
        fiber*2 + otherPolyols*2.4 +
        organicAcids*3 + ethanol*7;

      // æŠŠè¨ˆç®—å‡ºçš„ç†±é‡è¨˜åœ¨ caloriesCalcï¼ˆå‚™ç”¨ï¼‰
formData.nutrients.caloriesCalc = kcalPer100;

// ä½¿ç”¨è€…æœ‰å¡«ã€Œç†±é‡ï¼ˆæ¯100ï¼‰ã€å°±ç”¨ä½¿ç”¨è€…å€¼ï¼Œå¦å‰‡ç”¨è¨ˆç®—å€¼
const userKcalPer100 = Number(formData.nutrients.caloriesUser);
const caloriesPer100Display = (userKcalPer100 > 0) ? userKcalPer100 : kcalPer100;
formData.nutrients.calories = caloriesPer100Display;

formData.perServing = {
  protein: protein*ratio,
  fat: fat*ratio,
  saturatedFat: saturatedFat*ratio,
  transFat: transFat*ratio,
  carbs: carbs*ratio,
  sugar: sugar*ratio,
  sodium: sodium*ratio,
  fiber: fiber*ratio,
  calories: caloriesPer100Display*ratio
};
}

    /* ===== DV å¹«æ‰‹ï¼šéµåèˆ‡å–®ä½é¡¯ç¤º ===== */
    const nameToDVKey = {
      'ç†±é‡':'calories','è›‹ç™½è³ª':'protein','è„‚è‚ª':'fat','é£½å’Œè„‚è‚ª':'saturatedFat','ç¢³æ°´åŒ–åˆç‰©':'carbs','éˆ‰':'sodium','è†½å›ºé†‡':'cholesterol','è†³é£Ÿçº–ç¶­':'fiber',
      'ç¶­ç”Ÿç´ A':'vitaminA','ç¶­ç”Ÿç´ B1':'vitaminB1','ç¶­ç”Ÿç´ B2':'vitaminB2','ç¶­ç”Ÿç´ B6':'vitaminB6','ç¶­ç”Ÿç´ B12':'vitaminB12','ç¶­ç”Ÿç´ C':'vitaminC','ç¶­ç”Ÿç´ D':'vitaminD','ç¶­ç”Ÿç´ E':'vitaminE','ç¶­ç”Ÿç´ K':'vitaminK','è¸é¹¼ç´ ':'niacin','è‘‰é…¸':'folate','æ³›é…¸':'pantothenicAcid','ç”Ÿç‰©ç´ ':'biotin','è†½ç´ ':'choline',
      'éˆ£':'calcium','ç£·':'phosphorus','éµ':'iron','ç¢˜':'iodine','é‚':'magnesium','é‹…':'zinc','æ°Ÿ':'fluorine','ç¡’':'selenium'
    };
    const dvUnitText = (key)=>{
      const gKeys=['protein','fat','saturatedFat','carbs','fiber'];
      const mgKeys=['sodium','cholesterol','calcium','phosphorus','iron','magnesium','zinc','fluorine','choline','pantothenicAcid','niacin'];
      const mcgKeys=['vitaminA','vitaminB12','vitaminD','vitaminK','folate','iodine','selenium','biotin'];
      if (key==='calories') return 'å¤§å¡';
      if (gKeys.includes(key)) return 'å…¬å…‹';
      if (mgKeys.includes(key)) return 'æ¯«å…‹';
      if (mcgKeys.includes(key)) return 'å¾®å…‹';
      if (key==='vitaminE') return 'æ¯«å…‹ a-TE';
      if (key==='vitaminC' || key==='vitaminB1' || key==='vitaminB2' || key==='vitaminB6') return 'æ¯«å…‹';
      return ''; // fallback
    };

    function getDailyReference(){
      const ageMap={ 'under1':'over4', '1to3':'1to3', 'over4':'over4', 'pregnant':'pregnant' };
      return dailyValues[ageMap[formData.ageGroup]];
    }

// 1) ä¸­æ–‡é¡¯ç¤ºåç¨± â†’ DVéµ
const labelMap = {
  calories:'ç†±é‡', protein:'è›‹ç™½è³ª', fat:'è„‚è‚ª', saturatedFat:'é£½å’Œè„‚è‚ª',
  carbs:'ç¢³æ°´åŒ–åˆç‰©', sodium:'éˆ‰', cholesterol:'è†½å›ºé†‡', fiber:'è†³é£Ÿçº–ç¶­',
  vitaminA:'ç¶­ç”Ÿç´ A', vitaminB1:'ç¶­ç”Ÿç´ B1', vitaminB2:'ç¶­ç”Ÿç´ B2', vitaminB6:'ç¶­ç”Ÿç´ B6',
  vitaminB12:'ç¶­ç”Ÿç´ B12', vitaminC:'ç¶­ç”Ÿç´ C', vitaminD:'ç¶­ç”Ÿç´ D',
  vitaminE:'ç¶­ç”Ÿç´ E', vitaminK:'ç¶­ç”Ÿç´ K', niacin:'è¸é¹¼ç´ ',
  folate:'è‘‰é…¸', pantothenicAcid:'æ³›é…¸', biotin:'ç”Ÿç‰©ç´ ', choline:'è†½ç´ ',
  calcium:'éˆ£', phosphorus:'ç£·', iron:'éµ', iodine:'ç¢˜',
  magnesium:'é‚', zinc:'é‹…', fluorine:'æ°Ÿ', selenium:'ç¡’'
};

// 2) DVéµ â†’ å–®ä½ï¼ˆé¡¯ç¤ºæ–¼ã€Œæ¯æ—¥åƒè€ƒå€¼ï¼šã€é‚£è¡Œï¼‰
const dvUnitMap = {
  calories:'å¤§å¡', protein:'å…¬å…‹', fat:'å…¬å…‹', saturatedFat:'å…¬å…‹',
  carbs:'å…¬å…‹', sodium:'æ¯«å…‹', cholesterol:'æ¯«å…‹', fiber:'å…¬å…‹',
  vitaminA:'å¾®å…‹ RE', vitaminB1:'æ¯«å…‹', vitaminB2:'æ¯«å…‹', vitaminB6:'æ¯«å…‹',
  vitaminB12:'å¾®å…‹', vitaminC:'æ¯«å…‹', vitaminD:'å¾®å…‹',
  vitaminE:'æ¯«å…‹ Î±-TE', vitaminK:'å¾®å…‹', niacin:'æ¯«å…‹ NE',
  folate:'å¾®å…‹', pantothenicAcid:'æ¯«å…‹', biotin:'å¾®å…‹', choline:'æ¯«å…‹',
  calcium:'æ¯«å…‹', phosphorus:'æ¯«å…‹', iron:'æ¯«å…‹', iodine:'å¾®å…‹',
  magnesium:'æ¯«å…‹', zinc:'æ¯«å…‹', fluorine:'æ¯«å…‹', selenium:'å¾®å…‹'
};

// 3) é …ç›®ä¸­æ–‡ â†’ DVéµï¼ˆè¡¨æ ¼å…§åˆ—åè¦èƒ½å°ä¸Š DVï¼‰
function nutrientNameToDVKey(name) {
  const map = {
    'ç†±é‡':'calories', 'è›‹ç™½è³ª':'protein', 'è„‚è‚ª':'fat', 'é£½å’Œè„‚è‚ª':'saturatedFat',
    'åå¼è„‚è‚ª': null, // æ²’æœ‰DV
    'ç¢³æ°´åŒ–åˆç‰©':'carbs', 'ç³–': null, // æ²’æœ‰DV
    'éˆ‰':'sodium', 'è†½å›ºé†‡':'cholesterol', 'è†³é£Ÿçº–ç¶­':'fiber',

    'ç¶­ç”Ÿç´ A':'vitaminA','ç¶­ç”Ÿç´ B1':'vitaminB1','ç¶­ç”Ÿç´ B2':'vitaminB2',
    'ç¶­ç”Ÿç´ B6':'vitaminB6','ç¶­ç”Ÿç´ B12':'vitaminB12','ç¶­ç”Ÿç´ C':'vitaminC',
    'ç¶­ç”Ÿç´ D':'vitaminD','ç¶­ç”Ÿç´ E':'vitaminE','ç¶­ç”Ÿç´ K':'vitaminK',
    'è¸é¹¼ç´ ':'niacin','è‘‰é…¸':'folate','æ³›é…¸':'pantothenicAcid','ç”Ÿç‰©ç´ ':'biotin',
    'è†½ç´ ':'choline',

    'éˆ£':'calcium','ç£·':'phosphorus','éµ':'iron','ç¢˜':'iodine','é‚':'magnesium',
    'é‹…':'zinc','æ°Ÿ':'fluorine','ç¡’':'selenium'
  };
  return map[name] ?? null;
}
// === ç¶­ç”Ÿç´ ï¼ç¤¦ç‰©è³ªåˆ¤æ–·å·¥å…·ï¼ˆä¾› fmt èˆ‡ %DV é¡¯ç¤ºç”¨ï¼‰===
// èªªæ˜ï¼šä½ åœ¨ withDVPercent()ã€generateFormat1/2/3(å«æ©«å¼) è£¡é¢æœƒå‘¼å«
// isVitaminMineralByKey() å’Œ isVitaminMineralName()ï¼Œå…ˆå‰æœªå®šç¾©å°è‡´ ReferenceErrorã€‚
// é€™è£¡è£œä¸Šå…©å€‹å·¥å…·å‡½å¼èˆ‡éµé›†åˆ VM_KEYSã€‚

// ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ªå°æ‡‰çš„ DV éµé›†åˆ
const VM_KEYS = new Set([
  // ç¶­ç”Ÿç´ 
  'vitaminA','vitaminB1','vitaminB2','vitaminB6','vitaminB12','vitaminC',
  'vitaminD','vitaminE','vitaminK','niacin','folate','pantothenicAcid',
  'biotin','choline',
  // ç¤¦ç‰©è³ª
  'calcium','phosphorus','iron','iodine','magnesium','zinc','fluorine','selenium'
]);

/**
 * ä¾ DV éµåˆ¤æ–·æ˜¯å¦å±¬æ–¼ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ª
 * åƒè€ƒè™•ï¼šwithDVPercent()ã€generateFormat2() æœƒå‚³å…¥ dvKey ä¾†æ±ºå®šç”¨ fmtSig3 æˆ– fmtã€‚
 */
function isVitaminMineralByKey(key){
  return VM_KEYS.has(key);
}

/**
 * ä¾ã€Œä¸­æ–‡åç¨±ã€åˆ¤æ–·æ˜¯å¦å±¬æ–¼ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ª
 * ä½œæ³•ï¼šå…ˆç”¨ nutrientNameToDVKey(name) è½‰æˆ DV éµï¼Œå†æŸ¥ VM_KEYSã€‚
 * åƒè€ƒè™•ï¼šgenerateAdditionalNutrientsRows()ã€æ ¼å¼1/2/3æ©«å¼å­—ä¸²éƒ½æœƒç”¨åˆ°ã€‚
 */
function isVitaminMineralName(name){
  const key = nutrientNameToDVKey(name);
  return key ? VM_KEYS.has(key) : false;
}

// 4) è®“ã€Œæ¯ä»½ã€å€¼æ›åˆ° DV çš„å–®ä½ï¼ˆg/mg/Î¼gï¼‰å¾Œå†ç®—ç™¾åˆ†æ¯”

// [æ–°å¢] å°‡å¤šç¨®å¯«æ³•æ­£è¦åŒ–æˆæ›ç®—ç”¨å–®ä½
function normalizeUnitAlias(u){
  if(!u) return u;
  const unit = String(u).toLowerCase();
  if (unit === 'kcal') return 'kcal';
  if (unit === 'mcgre' || unit === 'Î¼gre' || unit === 'ugre') return 'mcg'; // ç¶­ç”Ÿç´ A: å¾®å…‹RE ç•¶ä½œå¾®å…‹è™•ç†
  if (unit === 'mgte') return 'mg';  // ç¶­ç”Ÿç´ E: æ¯«å…‹ a-TE ç•¶ä½œæ¯«å…‹è™•ç†
  if (unit === 'iu') return 'iu';    // IU ä¸åƒèˆ‡ç™¾åˆ†æ¯”æ›ç®—ï¼Œåªé¡¯ç¤º
  return unit; // g, mg, mcg, Î¼g, å…¶ä»–
}


function normalizeToDVUnit(value, unit, dvKey) {
  if (value == null || isNaN(value)) return NaN;

  // IU ä¸åƒèˆ‡ç™¾åˆ†æ¯”æ›ç®—ï¼ˆA/D/E çš„ IU æ˜¯é¡å¤–é¡¯ç¤ºç”¨ï¼‰ï¼Œç›´æ¥å›å‚³ NaN è®“ä¸Šå±¤èµ° '*'
  if (String(unit).toLowerCase() === 'iu') return NaN;

  const u = normalizeUnitAlias(unit); // å¥—ç”¨åˆ¥åæ­£è¦åŒ–

  if (dvKey === 'calories') return value; // ç†±é‡ç”¨å¤§å¡ï¼Œä¸è½‰

  // ç›®æ¨™å–®ä½ï¼ˆä¾ dvKey åˆ¤æ–·ï¼‰
  const target = (() => {
    if (['protein','fat','saturatedFat','carbs','fiber'].includes(dvKey)) return 'g';
    if (['sodium','cholesterol','vitaminB1','vitaminB2','vitaminB6',
         'vitaminC','vitaminE','niacin','pantothenicAcid','choline',
         'calcium','phosphorus','iron','magnesium','zinc','fluorine'].includes(dvKey)) return 'mg';
    if (['vitaminA','vitaminB12','vitaminD','vitaminK','folate','biotin',
         'iodine','selenium'].includes(dvKey)) return 'mcg';
    return u; // å…¶ä»–ä¸è½‰
  })();

  // è½‰æ›è‡³ç›®æ¨™å–®ä½
  const toG   = (val, uu) => (uu==='g') ? val : (uu==='mg') ? val/1000 : (uu==='mcg'||uu==='Î¼g') ? val/1_000_000 : val;
  const toMg  = (val, uu) => (uu==='g') ? val*1000 : (uu==='mg') ? val : (uu==='mcg'||uu==='Î¼g') ? val/1000 : val;
  const toMcg = (val, uu) => (uu==='g') ? val*1_000_000 : (uu==='mg') ? val*1000 : (uu==='mcg'||uu==='Î¼g') ? val : val;

  if (target === 'g')   return toG(value, u);
  if (target === 'mg')  return toMg(value, u);
  if (target === 'mcg') return toMcg(value, u);
  return value;
}


// 5) è¨ˆç®—ç™¾åˆ†æ¯”ï¼šæœ‰DVå°±ç®—ï¼›æ²’æœ‰å°±å›å‚³*
function withDVPercent(perServingValue, perServingUnit, dvValue, dvKey) {
  // æ²’ DV â†’ é¡¯ç¤º *
  if (typeof dvValue !== 'number' || !(dvValue > 0)) {
    return { text: '*', starred: true };
  }

  // å…ˆæŠŠã€Œæ¯ä»½å€¼ã€è½‰æˆèˆ‡ DV ä¸€è‡´çš„å–®ä½
  const normalized = normalizeToDVUnit(perServingValue, perServingUnit, dvKey);
  if (!Number.isFinite(normalized)) {
    return { text: '*', starred: true };
  }

  // ä»¥ã€Œç™¾åˆ†æ¯”æ•¸å€¼æœ¬èº«ã€ä¾†æ±ºå®šä½æ•¸ï¼ˆè€Œä¸æ˜¯å°æ•¸å½¢å¼ï¼‰
  const pctVal = (normalized / dvValue) * 100; // ä¾‹å¦‚ 0.0085ï¼ˆ%ï¼‰å°±æœƒç”¨ 0.0085 ä¾†åˆ¤æ–·

  let txt;
  if (pctVal > 0 && pctVal < 0.05) {
    // è¶…å°ç™¾åˆ†æ¯”ï¼šç”¨èˆ‡ fmt ç›¸åŒè¦å‰‡
    const d = Math.ceil(-Math.log10(pctVal));
    txt = pctVal.toFixed(d);
  } else {
    // å…¶ä»–ï¼š
    //   - ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ª â†’ ä¿æŒä½ åŸæœ¬ã€Œæœ‰æ•ˆæ•¸å­— â‰¤ 3ã€çš„è¡¨ç¾
    //   - å…¶é¤˜ â†’ 1 ä½å°æ•¸
    if (isVitaminMineralByKey(dvKey)) {
      txt = fmtSig3(pctVal);
    } else {
      txt = pctVal.toFixed(1);
    }
  }
  return { text: txt + ' %', starred: false };
}



// 6) çµ„ã€Œæ¯æ—¥åƒè€ƒå€¼ï¼šã€é€™ä¸€è¡Œï¼ˆåªåˆ—æœ‰ DV çš„é …ç›®ï¼‰
// keysInOrderï¼šå‚³å…¥ã€Œæœ¬æ¬¡æ¨™ç¤ºä¸­å¯¦éš›å‡ºç¾ï¼Œä¸”ç™¾åˆ†æ¯”ä¸æ˜¯ï¼Šã€çš„ dvKey é™£åˆ—
function buildDVLine(dv, keysInOrder) {
  const seen = new Set();
  const parts = [];
  for (const k of keysInOrder) {
    if (seen.has(k)) continue;
    seen.add(k);
    if (typeof dv[k] === 'number') {
      parts.push(`${labelMap[k]}${dv[k]}${dvUnitMap[k]}`);
    }
  }
  return parts.length ? `æ¯æ—¥åƒè€ƒå€¼ï¼š${parts.join('ã€')}ã€‚` : '';
}


// 7) ä¸åŒæ ¼å¼çš„ DV åˆ—å°é †åº
const dvOrderFormat2 = [
  'calories','protein','fat','saturatedFat','carbs','sodium','cholesterol','fiber',
  'vitaminA','vitaminB1','vitaminB2','vitaminB6','vitaminB12','vitaminC','vitaminD',
  'vitaminE','vitaminK','niacin','folate','pantothenicAcid','biotin','choline',
  'calcium','phosphorus','iron','iodine','magnesium','zinc','fluorine','selenium'
];
const dvOrderFormat3 = [
  'vitaminA','vitaminD','vitaminE','vitaminK','vitaminC','vitaminB1','vitaminB2',
  'vitaminB6','vitaminB12','niacin','folate','pantothenicAcid','biotin','choline',
  'calcium','phosphorus','iron','iodine','magnesium','zinc','fluorine','selenium',
  'protein','fat','saturatedFat','carbs','fiber','sodium','cholesterol','calories'
];
    function buildDVListText(dv, scope){
      // scope: 'format2' or 'format3' -> æ§åˆ¶åˆ—å‡ºå“ªäº›éµ
      const orderF2 = ['calories','protein','fat','saturatedFat','carbs','fiber','sodium','cholesterol']; // æ ¼å¼2å¸¸è¦‹
      const vitKeys = ['vitaminA','vitaminB1','vitaminB2','vitaminB6','vitaminB12','vitaminC','vitaminD','vitaminE','vitaminK','niacin','folate','pantothenicAcid','biotin','choline'];
      const minKeys = ['calcium','phosphorus','iron','iodine','magnesium','zinc','fluorine','selenium'];
      const orderF3 = [...vitKeys, ...minKeys];

      const seq = scope==='format3' ? orderF3 : orderF2;
      const zhMap = {
        calories:'ç†±é‡', protein:'è›‹ç™½è³ª', fat:'è„‚è‚ª', saturatedFat:'é£½å’Œè„‚è‚ª', carbs:'ç¢³æ°´åŒ–åˆç‰©', fiber:'è†³é£Ÿçº–ç¶­', sodium:'éˆ‰', cholesterol:'è†½å›ºé†‡',
        vitaminA:'ç¶­ç”Ÿç´ A', vitaminB1:'ç¶­ç”Ÿç´ B1', vitaminB2:'ç¶­ç”Ÿç´ B2', vitaminB6:'ç¶­ç”Ÿç´ B6', vitaminB12:'ç¶­ç”Ÿç´ B12', vitaminC:'ç¶­ç”Ÿç´ C', vitaminD:'ç¶­ç”Ÿç´ D', vitaminE:'ç¶­ç”Ÿç´ E', vitaminK:'ç¶­ç”Ÿç´ K',
        niacin:'è¸é¹¼ç´ ', folate:'è‘‰é…¸', pantothenicAcid:'æ³›é…¸', biotin:'ç”Ÿç‰©ç´ ', choline:'è†½ç´ ',
        calcium:'éˆ£', phosphorus:'ç£·', iron:'éµ', iodine:'ç¢˜', magnesium:'é‚', zinc:'é‹…', fluorine:'æ°Ÿ', selenium:'ç¡’'
      };

      const parts=[];
      seq.forEach(key=>{
        if (dv[key]!==undefined){
          parts.push(`${zhMap[key]}${dv[key]}${dvUnitText(key)}`);
        }
      });
      return parts.join('ã€');
    }

    /* ===== æ ¼å¼é¸æ“‡ã€é è¦½ç”¢ç”Ÿ ===== */
    function showFormatSelection(){
      const box=document.getElementById('formatOptions');
      box.innerHTML='<div class="radio-group">';
      const names={ format1:'æ ¼å¼ 1ï¼šæ¯ 100 å…¬å…‹/æ¯«å‡', format2:'æ ¼å¼ 2ï¼šæ¯æ—¥åƒè€ƒç™¾åˆ†æ¯”', format3:'æ ¼å¼ 3ï¼šç¶­ç”Ÿç´ ç¤¦ç‰©è³ªå°ˆç”¨' };
      formData.availableFormats.forEach(f=>{
        box.innerHTML += `
          <div class="radio-option">
            <input type="radio" name="format" value="${f}" id="${f}">
            <label class="radio-label" for="${f}">${names[f]}</label>
          </div>`;
      });
      box.innerHTML+='</div>';
      document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active'));
      document.getElementById('step3').classList.add('active'); updateProgressBar(3);
    }

    function generatePreview(){
      const sel=document.querySelector('input[name="format"]:checked');
      if(!sel){ alert('è«‹é¸æ“‡ç‡Ÿé¤Šæ¨™ç¤ºæ ¼å¼'); return; }
      formData.selectedFormat=sel.value;

      const area=document.getElementById('previewArea'); area.innerHTML='';
      if (formData.selectedFormat==='format1'){ area.innerHTML = generateFormat1() + generateFormat1Horizontal(); }
      else if (formData.selectedFormat==='format2'){ area.innerHTML = generateFormat2() + generateFormat2Horizontal(); }
      else { area.innerHTML = generateFormat3() + generateFormat3Horizontal(); }

      document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active'));
      document.getElementById('step4').classList.add('active'); updateProgressBar(4);
    }

    function generateFormat1(){
  const unit = formData.unit;
  return `
  <div class="nutrition-table" id="format1Table">
    <table>
      <thead><tr><th colspan="3" style="background:#fff;color:#333;text-align:center;font-size:1.1em;">ç‡Ÿé¤Šæ¨™ç¤º</th></tr></thead>
      <tbody>
        <tr><td colspan="2">æ¯ä¸€ä»½é‡</td><td>${(formData.servingSize || 0).toFixed(2)} ${unit}</td></tr>
        <tr><td colspan="2">æœ¬åŒ…è£å«</td><td>${formData.servingsPerContainer} ä»½</td></tr>
      </tbody>
    </table>
    <table>
      <tbody>
        <tr><td></td><td class="text-right"><strong>æ¯ä»½</strong></td><td class="text-right"><strong>æ¯ 100 ${unit}</strong></td></tr>
        <tr><td>ç†±é‡</td><td class="text-right">${fmt(formData.perServing.calories)} å¤§å¡</td><td class="text-right">${fmt(formData.nutrients.calories)} å¤§å¡</td></tr>
        <tr><td>è›‹ç™½è³ª</td><td class="text-right">${fmt(formData.perServing.protein)} å…¬å…‹</td><td class="text-right">${fmt(formData.nutrients.protein || 0)} å…¬å…‹</td></tr>
        <tr><td>è„‚è‚ª</td><td class="text-right">${fmt(formData.perServing.fat)} å…¬å…‹</td><td class="text-right">${fmt(formData.nutrients.fat || 0)} å…¬å…‹</td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;é£½å’Œè„‚è‚ª</td><td class="text-right">${fmt(formData.perServing.saturatedFat)} å…¬å…‹</td><td class="text-right">${fmt(formData.nutrients.saturatedFat || 0)} å…¬å…‹</td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;åå¼è„‚è‚ª</td><td class="text-right">${fmt(formData.perServing.transFat)} å…¬å…‹</td><td class="text-right">${fmt(formData.nutrients.transFat || 0)} å…¬å…‹</td></tr>
        <tr><td>ç¢³æ°´åŒ–åˆç‰©</td><td class="text-right">${fmt(formData.perServing.carbs)} å…¬å…‹</td><td class="text-right">${fmt(formData.nutrients.carbs || 0)} å…¬å…‹</td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;ç³–</td><td class="text-right">${fmt(formData.perServing.sugar)} å…¬å…‹</td><td class="text-right">${fmt(formData.nutrients.sugar || 0)} å…¬å…‹</td></tr>
        <tr><td>éˆ‰</td><td class="text-right">${fmt(formData.perServing.sodium)} æ¯«å…‹</td><td class="text-right">${fmt(formData.nutrients.sodium || 0)} æ¯«å…‹</td></tr>
        ${generateAdditionalNutrientsRows()}
      </tbody>
    </table>
  </div>
  <div class="local-download">
    <button class="btn-mini" onclick="downloadSinglePDF('format1Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.pdf')">ğŸ“„ ä¸‹è¼‰ç›´å¼ PDF</button>
    <button class="btn-mini" onclick="downloadSingleHTML('format1Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.html')">ğŸŒ ä¸‹è¼‰ç›´å¼ HTML</button>
	<button class="btn-mini" onclick="downloadSingleExcel('format1Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.xlsx')">ğŸ“Š ä¸‹è¼‰ç›´å¼ Excel</button>

  </div>`;
}


    function generateFormat1Horizontal(){
  const unit = formData.unit;
  let add = '';
  formData.additionalNutrients.forEach(n=>{
    const per = Number(n.value || 0) * (formData.servingSize / 100);
    const isVM = isVitaminMineralName(n.name);
    const f = isVM ? fmtSig3 : fmt;
    const dispName = getDisplayedNutrientName(n);
    add += `ã€${dispName}${f(per)}${getUnitText(n.unit)}ï¼ˆ${f(n.value)}${getUnitText(n.unit)}ï¼‰`;
  });

  return `
  <div class="horizontal-label" id="format1Horizontal">
    <p style="text-align:center;font-size:1.1em;"><strong>ç‡Ÿé¤Šæ¨™ç¤º</strong></p>
    <p>
      æ¯ä¸€ä»½é‡${(formData.servingSize || 0).toFixed(2)}${unit}ï¼Œæœ¬åŒ…è£å«${formData.servingsPerContainer}ä»½ã€‚
      æ¯ä»½ï¼ˆæ¯100${unit}ï¼‰ï¼š
      ç†±é‡${fmt(formData.perServing.calories)}å¤§å¡ï¼ˆ${fmt(formData.nutrients.calories)}å¤§å¡ï¼‰ã€
      è›‹ç™½è³ª${fmt(formData.perServing.protein)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.protein || 0)}å…¬å…‹ï¼‰ã€
      è„‚è‚ª${fmt(formData.perServing.fat)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.fat || 0)}å…¬å…‹ï¼‰ã€
      é£½å’Œè„‚è‚ª${fmt(formData.perServing.saturatedFat)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.saturatedFat || 0)}å…¬å…‹ï¼‰ã€
      åå¼è„‚è‚ª${fmt(formData.perServing.transFat)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.transFat || 0)}å…¬å…‹ï¼‰ã€
      ç¢³æ°´åŒ–åˆç‰©${fmt(formData.perServing.carbs)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.carbs || 0)}å…¬å…‹ï¼‰ã€
      ç³–${fmt(formData.perServing.sugar)}å…¬å…‹ï¼ˆ${fmt(formData.nutrients.sugar || 0)}å…¬å…‹ï¼‰ã€
      éˆ‰${fmt(formData.perServing.sodium)}æ¯«å…‹ï¼ˆ${fmt(formData.nutrients.sodium || 0)}æ¯«å…‹ï¼‰
      ${add}ã€‚
    </p>
  </div>
  <div class="note" data-nodownload="true" style="margin-top:10px;">é©ç”¨æ–¼ç¸½è¡¨é¢ç©å°æ–¼100å¹³æ–¹å…¬åˆ†ä»¥ä¸‹çš„ç”¢å“ã€‚</div>
  <div class="local-download">
    <button class="btn-mini" onclick="downloadSinglePDF('format1Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.pdf')">ğŸ“„ ä¸‹è¼‰æ©«å¼ PDF</button>
    <button class="btn-mini" onclick="downloadSingleHTML('format1Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.html')">ğŸŒ ä¸‹è¼‰æ©«å¼ HTML</button>
    <button class="btn-mini" onclick="downloadSingleExcel('format1Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.xlsx')">ğŸ“Š ä¸‹è¼‰æ©«å¼ Excel</button>
  </div>`;
}

function generateFormat2(){
  const dailyRef = getDailyReference();
  const unit = formData.unit;

  const rows = [];
  const presentDVKeys = [];
  const pushRow = (name, perServing, unitShort, dvKey) => {
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const percent = dvKey ? withDVPercent(perServing, unitShort, dvVal, dvKey) : { text:'*', starred:true };
    rows.push({ name, perServing, unitShort, dvKey, percentText:percent.text, starred:percent.starred });
    if (dvKey && !percent.starred) presentDVKeys.push(dvKey);
  };

  pushRow('ç†±é‡', formData.perServing.calories, 'kcal', 'calories');
  pushRow('è›‹ç™½è³ª', formData.perServing.protein, 'g', 'protein');
  pushRow('è„‚è‚ª', formData.perServing.fat, 'g', 'fat');
  pushRow('é£½å’Œè„‚è‚ª', formData.perServing.saturatedFat, 'g', 'saturatedFat');
  pushRow('åå¼è„‚è‚ª', formData.perServing.transFat, 'g', null);
  pushRow('ç¢³æ°´åŒ–åˆç‰©', formData.perServing.carbs, 'g', 'carbs');
  pushRow('ç³–', formData.perServing.sugar, 'g', null);
  pushRow('éˆ‰', formData.perServing.sodium, 'mg', 'sodium');

  formData.additionalNutrients.forEach(n=>{
    const perServing = (n.value * formData.servingSize / 100);
    const dvKey = nutrientNameToDVKey(n.name) || null;
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const percent = dvKey ? withDVPercent(perServing, n.unit, dvVal, dvKey) : { text:'*', starred:true };
    const dispName = getDisplayedNutrientName(n);
    rows.push({ name:dispName, perServing, unitShort:n.unit, dvKey, percentText:percent.text, starred:percent.starred });
    if (dvKey && !percent.starred) presentDVKeys.push(dvKey);
  });

  const anyStar = rows.some(r=>r.starred);
  let dvText = '';
  if (anyStar) dvText += 'ï¼Šåƒè€ƒå€¼æœªè¨‚å®š\n';
  const line = buildDVLine(dailyRef, presentDVKeys);
  if (line) dvText += line;

  const body = rows.map(r=>{
    const formatter = isVitaminMineralByKey(r.dvKey) ? fmtSig3 : fmt;
    const valTxt = r.unitShort==='kcal' ? `${formatter(r.perServing)} å¤§å¡` : `${formatter(r.perServing)} ${getUnitText(r.unitShort)}`;
    return `<tr><td>${r.name}</td><td class="text-right">${valTxt}</td><td class="text-right">${r.percentText}</td></tr>`;
  }).join('');

  return `
    <div class="nutrition-table" id="format2Table">
      <table>
        <thead><tr><th colspan="3" style="background:#fff;color:#333;text-align:center;font-size:1.1em;">ç‡Ÿé¤Šæ¨™ç¤º</th></tr></thead>
        <tbody>
          <tr><td colspan="2">æ¯ä¸€ä»½é‡</td><td>${formData.servingSize} ${unit}</td></tr>
          <tr><td colspan="2">æœ¬åŒ…è£å«</td><td>${formData.servingsPerContainer} ä»½</td></tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr><td></td><td class="text-right"><strong>æ¯ä»½</strong></td><td class="text-right"><strong>æ¯æ—¥åƒè€ƒå€¼ç™¾åˆ†æ¯”</strong></td></tr>
          ${body}
        </tbody>
      </table>
      ${dvText ? `<p class="dv-text" style="white-space:pre-line">${dvText}</p>` : ''}
    </div>
    <div class="local-download">
      <button class="btn-mini" onclick="downloadSinglePDF('format2Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.pdf')">ğŸ“„ ä¸‹è¼‰ç›´å¼ PDF</button>
      <button class="btn-mini" onclick="downloadSingleHTML('format2Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.html')">ğŸŒ ä¸‹è¼‰ç›´å¼ HTML</button>
      <button class="btn-mini" onclick="downloadSingleExcel('format2Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.xlsx')">ğŸ“Š ä¸‹è¼‰ç›´å¼ Excel</button>
    </div>
  `;
}




function generateFormat2Horizontal(){
  const dailyRef = getDailyReference();
  const unit = formData.unit;

  const items = [];
  const presentDVKeys = [];
  let anyStar = false;

  const cell = (name, value, unitShort) => {
    const dvKey = nutrientNameToDVKey(name);
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const res = dvKey ? withDVPercent(value, unitShort, dvVal, dvKey) : { text:'*', starred:true };
    const formatter = isVitaminMineralByKey(dvKey) ? fmtSig3 : fmt;
    const valTxt = unitShort==='kcal' ? `${formatter(value)}å¤§å¡` : `${formatter(value)}${getUnitText(unitShort)}`;
    if (dvKey && !res.starred) presentDVKeys.push(dvKey);
    if (res.starred) anyStar = true;
    return `${name}${valTxt}ï¼ˆ${res.text}ï¼‰`;
  };

  items.push(cell('ç†±é‡', formData.perServing.calories, 'kcal'));
  items.push(cell('è›‹ç™½è³ª', formData.perServing.protein, 'g'));
  items.push(cell('è„‚è‚ª', formData.perServing.fat, 'g'));
  items.push(cell('é£½å’Œè„‚è‚ª', formData.perServing.saturatedFat, 'g'));
  items.push(cell('åå¼è„‚è‚ª', formData.perServing.transFat, 'g'));
  items.push(cell('ç¢³æ°´åŒ–åˆç‰©', formData.perServing.carbs, 'g'));
  items.push(cell('ç³–', formData.perServing.sugar, 'g'));
  items.push(cell('éˆ‰', formData.perServing.sodium, 'mg'));

  formData.additionalNutrients.forEach(n=>{
    const perServing = (n.value*formData.servingSize/100);
    const dvKey = nutrientNameToDVKey(n.name);
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const res = dvKey ? withDVPercent(perServing, n.unit, dvVal, dvKey) : { text:'*', starred:true };
    if (dvKey && !res.starred) presentDVKeys.push(dvKey);
    if (res.starred) anyStar = true;

    const f = isVitaminMineralName(n.name) ? fmtSig3 : fmt;
    const dispName = getDisplayedNutrientName(n);
    items.push(`${dispName}${f(perServing)}${getUnitText(n.unit)}ï¼ˆ${res.text}ï¼‰`);
  });

  let dvText = '';
  if (anyStar) dvText += 'ï¼Šåƒè€ƒå€¼æœªè¨‚å®š\n';
  const line = buildDVLine(dailyRef, presentDVKeys);
  if (line) dvText += line;

  return `
    <div class="horizontal-label" id="format2Horizontal">
      <p style="text-align:center;font-size:1.1em;"><strong>ç‡Ÿé¤Šæ¨™ç¤º</strong></p>
      <p>æ¯ä¸€ä»½é‡${formData.servingSize}${unit}ï¼Œæœ¬åŒ…è£å«${formData.servingsPerContainer}ä»½ã€‚æ¯ä»½ï¼š${items.join('ã€')}ã€‚</p>
      ${dvText ? `<p class="dv-text" style="white-space:pre-line">${dvText}</p>` : ''}
    </div>
    <div class="note" data-nodownload="true" style="margin-top:10px;">é©ç”¨æ–¼ç¸½è¡¨é¢ç©å°æ–¼100å¹³æ–¹å…¬åˆ†ä»¥ä¸‹çš„ç”¢å“ã€‚</div>
    <div class="local-download">
      <button class="btn-mini" onclick="downloadSinglePDF('format2Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.pdf')">ğŸ“„ ä¸‹è¼‰æ©«å¼ PDF</button>
      <button class="btn-mini" onclick="downloadSingleHTML('format2Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.html')">ğŸŒ ä¸‹è¼‰æ©«å¼ HTML</button>
      <button class="btn-mini" onclick="downloadSingleExcel('format2Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.xlsx')">ğŸ“Š ä¸‹è¼‰æ©«å¼ Excel</button>
    </div>
  `;
}


function generateFormat3() {
  const dailyRef = getDailyReference();
  const rows = [];
  const presentDVKeys = [];

  // ç¶­ç”Ÿç´ 
  formData.vitamins.forEach(v=>{
    const dvKey = nutrientNameToDVKey(v.name);
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const pct = dvKey ? withDVPercent(v.value, v.unit, dvVal, dvKey) : { text:'*', starred:true };
    let displayValue = `${fmtSig3(v.value)} ${getUnitText(v.unit)}`;
    if (['ç¶­ç”Ÿç´ A','ç¶­ç”Ÿç´ D','ç¶­ç”Ÿç´ E'].includes(v.name) && typeof v.iu === 'number' && !isNaN(v.iu)){
      displayValue += `ï¼ˆ${v.iu} IUï¼‰`;
    }
    rows.push({ name:v.name, displayValue, percentText:pct.text, starred:pct.starred, dvKey });
    if (dvKey && !pct.starred) presentDVKeys.push(dvKey);
  });

  // ç¤¦ç‰©è³ª
  formData.minerals.forEach(m=>{
    const dvKey = nutrientNameToDVKey(m.name);
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const pct = dvKey ? withDVPercent(m.value, m.unit, dvVal, dvKey) : { text:'*', starred:true };
    rows.push({ name:m.name, displayValue:`${fmtSig3(m.value)} ${getUnitText(m.unit)}`, percentText:pct.text, starred:pct.starred, dvKey });
    if (dvKey && !pct.starred) presentDVKeys.push(dvKey);
  });

  // å…¶ä»–ï¼ˆå«æœ‰æ©Ÿé…¸ï¼ç†±é‡ç­‰è‡ªé¡˜æ¨™ç¤ºï¼›æ ¼å¼3 ä¸è¨ˆ %DVï¼‰
  formData.additionalNutrients.forEach(n=>{
    const dvKey = nutrientNameToDVKey(n.name); // å¯èƒ½ç‚º null
    const f = isVitaminMineralName(n.name) ? fmtSig3 : fmt;
    const dispName = getDisplayedNutrientName ? getDisplayedNutrientName(n) : (n.isOrganicAcid && n.organicAcidName ? n.organicAcidName : n.name);
    const display = (n.unit === 'kcal') ? `${fmt(n.value)} å¤§å¡` : `${f(n.value)} ${getUnitText(n.unit)}`;
    rows.push({ name:dispName, displayValue:display, percentText:'ï¼Š', starred:true, dvKey });
  });

  // è¨»è¨˜è¡Œèˆ‡ DV è¡Œ
  const anyStar = rows.some(r=>r.starred);
  let dvText = '';
  if (anyStar) dvText += 'ï¼Šåƒè€ƒå€¼æœªè¨‚å®š\n';
  const line = buildDVLine(dailyRef, presentDVKeys);
  if (line) dvText += line;

  const body = rows.map(r=>`
    <tr>
      <td>${r.name}</td>
      <td class="text-right">${r.displayValue}</td>
      <td class="text-right">${r.percentText}</td>
    </tr>`).join('');

  return `
    <div class="nutrition-table" id="format3Table">
      <table>
        <thead><tr><th colspan="3" style="background:#fff;color:#333;text-align:center;font-size:1.1em;">ç‡Ÿé¤Šæ¨™ç¤º</th></tr></thead>
        <tbody>
          <tr><td colspan="2">æ¯ä¸€ä»½é‡</td><td>${getCapsuleServingContent()}</td></tr>
          <tr><td colspan="2">æœ¬åŒ…è£å«</td><td>${formData.servingsPerContainer} ä»½</td></tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr><td></td><td class="text-right"><strong>æ¯ä»½</strong></td><td class="text-right"><strong>æ¯æ—¥åƒè€ƒå€¼ç™¾åˆ†æ¯”</strong></td></tr>
          ${body}
        </tbody>
      </table>
      ${dvText ? `<p class="dv-text" style="white-space:pre-line">${dvText}</p>` : ''}
    </div>
    <div class="local-download">
      <button class="btn-mini" onclick="downloadSinglePDF('format3Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.pdf')">ğŸ“„ ä¸‹è¼‰ç›´å¼ PDF</button>
      <button class="btn-mini" onclick="downloadSingleHTML('format3Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.html')">ğŸŒ ä¸‹è¼‰ç›´å¼ HTML</button>
      <button class="btn-mini" onclick="downloadSingleExcel('format3Table','ç‡Ÿé¤Šæ¨™ç¤º_ç›´å¼.xls')">ğŸ“Š ä¸‹è¼‰ç›´å¼ Excel</button>
    </div>
  `;
}


function generateFormat3Horizontal() {
  const dailyRef = getDailyReference();
  const items = [];
  const presentDVKeys = [];
  let anyStar = false;

  const lineFor = (name, value, unitShort, iuOpt) => {
    const dvKey = nutrientNameToDVKey(name);
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const res = dvKey ? withDVPercent(value, unitShort, dvVal, dvKey) : { text:'*', starred:true };
    const f = isVitaminMineralName(name) ? fmtSig3 : fmt;
    let v = `${f(value)}${getUnitText(unitShort)}`;
    if (['ç¶­ç”Ÿç´ A','ç¶­ç”Ÿç´ D','ç¶­ç”Ÿç´ E'].includes(name) && typeof iuOpt === 'number' && !isNaN(iuOpt)) {
      v += `ï¼ˆ${iuOpt} IUï¼‰`;
    }
    if (dvKey && !res.starred) presentDVKeys.push(dvKey);
    if (res.starred) anyStar = true;
    return `${name}${v}ï¼ˆ${res.text}ï¼‰`;
  };

  formData.vitamins.forEach(v => items.push(lineFor(v.name, v.value, v.unit, v.iu)));
  formData.minerals.forEach(m => items.push(lineFor(m.name, m.value, m.unit)));
  formData.additionalNutrients.forEach(n => {
    const dispName = getDisplayedNutrientName ? getDisplayedNutrientName(n) : (n.isOrganicAcid && n.organicAcidName ? n.organicAcidName : n.name);
    const dvKey = nutrientNameToDVKey(n.name);
    const dvVal = dvKey ? dailyRef[dvKey] : undefined;
    const res = dvKey ? withDVPercent(n.value, n.unit, dvVal, dvKey) : { text:'*', starred:true };
    if (dvKey && !res.starred) presentDVKeys.push(dvKey);
    if (res.starred) anyStar = true;
    const f = isVitaminMineralName(n.name) ? fmtSig3 : fmt;
    const valueTxt = (n.unit === 'kcal') ? `${fmt(n.value)}${getUnitText(n.unit)}` : `${f(n.value)}${getUnitText(n.unit)}`;
    items.push(`${dispName}${valueTxt}ï¼ˆ${res.text}ï¼‰`);
  });

  let dvText = '';
  if (anyStar) dvText += 'ï¼Šåƒè€ƒå€¼æœªè¨‚å®š\n';
  const line = buildDVLine(dailyRef, presentDVKeys);
  if (line) dvText += line;

  return `
    <div class="horizontal-label" id="format3Horizontal">
      <p style="text-align:center;font-size:1.1em;"><strong>ç‡Ÿé¤Šæ¨™ç¤º</strong></p>
      <p>
        æ¯ä¸€ä»½é‡${getCapsuleServingContent()}ï¼Œæœ¬åŒ…è£å«${formData.servingsPerContainer}ä»½ã€‚
        æ¯ä»½ï¼š${items.join('ã€')}ã€‚
      </p>
      ${dvText ? `<p class="dv-text" style="white-space:pre-line">${dvText}</p>` : ''}
    </div>
    <div class="note" data-nodownload="true" style="margin-top:10px;">
      é©ç”¨æ–¼ç¸½è¡¨é¢ç©å°æ–¼100å¹³æ–¹å…¬åˆ†ä»¥ä¸‹çš„ç”¢å“ã€‚
    </div>
    <div class="local-download">
      <button class="btn-mini" onclick="downloadSinglePDF('format3Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.pdf')">ğŸ“„ ä¸‹è¼‰æ©«å¼ PDF</button>
      <button class="btn-mini" onclick="downloadSingleHTML('format3Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.html')">ğŸŒ ä¸‹è¼‰æ©«å¼ HTML</button>
      <button class="btn-mini" onclick="downloadSingleExcel('format3Horizontal','ç‡Ÿé¤Šæ¨™ç¤º_æ©«å¼.xls')">ğŸ“Š ä¸‹è¼‰æ©«å¼ Excel</button>
    </div>
  `;
}

    function renderCapsuleServingLine(){
      const countEl=document.getElementById('capsuleCount');
      const perEl=document.getElementById('capsuleUnitWeight');
      const perUnit=document.getElementById('capsuleUnitWeightUnit')?.value;
      const modeEl=document.querySelector('input[name="capsuleMode"]:checked');
      if (modeEl && modeEl.value==='count' && countEl && perEl && perUnit){
        const label=formData.capsuleUnitLabel||'é¡†';
        return `æ¯ä¸€ä»½é‡ ${countEl.value||0} ${label}ï¼ˆæ¯${label}${perEl.value||0} ${perUnit==='mg'?'æ¯«å…‹':'å…¬å…‹'}ï¼‰`;
      }
      return `æ¯ä¸€ä»½é‡ ${formData.servingSize.toFixed(2)} å…¬å…‹`;
    }

    function translateLockedUnit(u){
      if (u==='mcgRE') return 'å¾®å…‹ RE';
      if (u==='mgTE') return 'æ¯«å…‹ a-TE';
      if (u==='mcg') return 'å¾®å…‹';
      if (u==='mg') return 'æ¯«å…‹';
      return u;
    }

    function calculateDailyPercentage(nutrientName, value, dv){
      const map={
        'ç¶­ç”Ÿç´ A':'vitaminA','ç¶­ç”Ÿç´ B1':'vitaminB1','ç¶­ç”Ÿç´ B2':'vitaminB2','ç¶­ç”Ÿç´ B6':'vitaminB6','ç¶­ç”Ÿç´ B12':'vitaminB12',
        'ç¶­ç”Ÿç´ C':'vitaminC','ç¶­ç”Ÿç´ D':'vitaminD','ç¶­ç”Ÿç´ E':'vitaminE','ç¶­ç”Ÿç´ K':'vitaminK','è¸é¹¼ç´ ':'niacin','è‘‰é…¸':'folate',
        'æ³›é…¸':'pantothenicAcid','ç”Ÿç‰©ç´ ':'biotin','è†½ç´ ':'choline','éˆ£':'calcium','ç£·':'phosphorus','éµ':'iron','ç¢˜':'iodine',
        'é‚':'magnesium','é‹…':'zinc','æ°Ÿ':'fluorine','ç¡’':'selenium'
      };
      const key=map[nutrientName];
      if (key && dv[key]!==undefined) return ((value/dv[key])*100).toFixed(1)+'%';
      return 'ï¼Š';
    }

function generateAdditionalNutrientsRows(){
  let html = '';
  formData.additionalNutrients.forEach(n=>{
    const per = (Number(n.value || 0) * (formData.servingSize / 100));
    const isVM = isVitaminMineralName(n.name);
    const f = isVM ? fmtSig3 : fmt;

    const dispName = getDisplayedNutrientName(n);
    html += `<tr>
      <td>${dispName}</td>
      <td class="text-right">${f(per)} ${getUnitText(n.unit)}</td>
      <td class="text-right">${f(n.value)} ${getUnitText(n.unit)}</td>
    </tr>`;
  });
  return html;
}



    // ä»¥ DV è¨ˆç®—ã€Œæ–°å¢å…¶ä»–ç‡Ÿé¤Šç´ ã€çš„ç™¾åˆ†æ¯”ï¼ˆæ ¼å¼2ï¼‰
    function generateAdditionalNutrientsRowsFormat2WithDV(dv){
      let html='';
      formData.additionalNutrients.forEach(n=>{
        const per=(n.value*formData.servingSize/100); // æ¯ä»½çš„æ•¸å€¼ï¼ˆåŸå–®ä½ï¼‰
        const key=nameToDVKey[n.name];
        let pctText='ï¼Š';
        if (key && dv[key]!==undefined){
          // å–®ä½å°é½Šï¼šæŠŠæ¯ä»½æ•¸å€¼è½‰æˆèˆ‡ DV åŒå–®ä½å†é™¤
          const perSameUnit = convertToSameUnit(per, n.unit, dvUnitFromKey(key)); // number
          pctText = ((perSameUnit/dv[key])*100).toFixed(1)+' %';
        }
        html += `<tr><td>${n.name}</td><td class="text-right">${per.toFixed(2)} ${getUnitText(n.unit)}</td><td class="text-right">${pctText}</td></tr>`;
      });
      return html;
    }

    function dvUnitFromKey(key){
      // å›å‚³ 'g'/'mg'/'mcg'/'kcal'
      if (key==='calories') return 'kcal';
      if (['protein','fat','saturatedFat','carbs','fiber'].includes(key)) return 'g';
      if (['vitaminA','vitaminB12','vitaminD','vitaminK','folate','iodine','selenium','biotin'].includes(key)) return 'mcg';
      if (key==='vitaminE') return 'mg'; // a-TE
      if (['vitaminC','vitaminB1','vitaminB2','vitaminB6','niacin','pantothenicAcid','choline'].includes(key)) return 'mg';
      if (['sodium','cholesterol','calcium','phosphorus','iron','magnesium','zinc','fluorine'].includes(key)) return 'mg';
      return 'mg';
    }
    function unitForPerServing(unit){ // additionalNutrient çš„å–®ä½
      if (unit==='g'||unit==='mg'||unit==='mcg') return unit;
      return 'mg';
    }
    function convertToSameUnit(val, fromUnit, toUnit){
      // val ç‚ºã€Œæ¯ä»½ã€æ•¸å€¼
      if (toUnit==='kcal') return val; // ç†±é‡ä¸åœ¨æ­¤è·¯å¾‘
      // å…ˆè½‰æˆå¾®å…‹
      let mcg;
      if (fromUnit==='g') mcg = val*1_000_000;
      else if (fromUnit==='mg') mcg = val*1_000;
      else mcg = val; // mcg
      // å†è½‰æˆç›®æ¨™å–®ä½
      if (toUnit==='g') return mcg/1_000_000;
      if (toUnit==='mg') return mcg/1_000;
      return mcg; // mcg
    }

    function getUnitText(unit){
	  const map={ g:'å…¬å…‹', mg:'æ¯«å…‹', mcg:'å¾®å…‹', IU:'IU', kcal:'å¤§å¡' };
	  if (unit==='mcgRE') return 'å¾®å…‹ RE';
	  if (unit==='mgTE') return 'æ¯«å…‹ a-TE';
	  return map[unit]||unit;
}


    /* ===== ä¸‹è¼‰ï¼ˆç›´å¼/æ©«å¼åˆ†æµ + æ’é™¤ data-nodownloadï¼‰===== */

/** ä¾ä½¿ç”¨è€…é¸æ“‡å›å‚³è¦ä¸‹è¼‰çš„ DOM ç¯€é»é™£åˆ—ï¼ˆåªå–ç›®å‰é è¦½é ä¸­çš„é‚£ä¸€ç¨®æ ¼å¼ï¼‰ */
function getPreviewNodes(mode /* 'vertical' | 'horizontal' */){
  const area = document.getElementById('previewArea');
  if (!area) return [];

  // ä¾ç›®å‰é¸æ“‡çš„æ ¼å¼æ±ºå®šè¦æŠ“çš„ç¯€é» ID
  const map = {
    vertical: {
      format1: ['format1Table'],
      format2: ['format2Table'],
      format3: ['format3Table']
    },
    horizontal: {
      format1: ['format1Horizontal'],
      format2: ['format2Horizontal'],
      format3: ['format3Horizontal']
    }
  };

  const ids = map[mode]?.[formData.selectedFormat] || [];
  const nodes = [];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if (el) nodes.push(el);
  });
  return nodes;
}

/** è¤‡è£½ä¸€ä»½ç¯€é»ï¼Œä¸¦ç§»é™¤æ‰€æœ‰ data-nodownload="true" çš„å…ƒç´ ï¼ˆé¿å…è¢«å°å‡ºï¼‰ */
function cloneWithoutNoDownload(node){
  const clone = node.cloneNode(true);
  clone.querySelectorAll('[data-nodownload="true"]').forEach(n=>n.remove());
  return clone;
}

/** ä¸‹è¼‰ PDFï¼ˆåˆ†ç›´å¼/æ©«å¼ï¼‰ */
async function downloadPDF(mode /* 'vertical' | 'horizontal' */ = 'vertical'){
  const targets = getPreviewNodes(mode);
  if (!targets.length){ alert('è«‹å…ˆç”Ÿæˆé è¦½ï¼Œæˆ–ç¢ºèªå·²é¸æ“‡æ­£ç¢ºçš„ç‰ˆå‹ã€‚'); return; }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const pad = 24;
  let first = true;

  for (const node of targets){
    const clean = cloneWithoutNoDownload(node);
    // ç‚ºé¿å…èˆ‡ç•«é¢è¡çªï¼Œå…ˆæ›åˆ°é›¢ç·šå®¹å™¨å†è½‰åœ–
    const tmp = document.createElement('div');
    tmp.style.position = 'fixed'; tmp.style.left='-99999px'; tmp.style.top='-99999px';
    tmp.appendChild(clean); document.body.appendChild(tmp);

    const canvas = await html2canvas(clean, { scale: 2, backgroundColor:'#ffffff' });
    const img = canvas.toDataURL('image/png');
    const s = Math.min((pageW - pad*2)/canvas.width, (pageH - pad*2)/canvas.height);
    const w = canvas.width*s, h = canvas.height*s, x = (pageW - w)/2, y = (pageH - h)/2;
    if (!first) pdf.addPage();
    pdf.addImage(img, 'PNG', x, y, w, h);
    first = false;

    tmp.remove();
  }

  const orientLabel = mode === 'horizontal' ? 'æ©«å¼' : 'ç›´å¼';
  pdf.save(`ç‡Ÿé¤Šæ¨™ç¤º_${orientLabel}.pdf`);
}

/** ä¸‹è¼‰ HTMLï¼ˆåˆ†ç›´å¼/æ©«å¼ï¼Œä¸”æ’é™¤ data-nodownloadï¼‰ */
function downloadHTML(mode /* 'vertical' | 'horizontal' */ = 'vertical'){
  const targets = getPreviewNodes(mode);
  if (!targets.length){ alert('è«‹å…ˆç”Ÿæˆé è¦½ï¼Œæˆ–ç¢ºèªå·²é¸æ“‡æ­£ç¢ºçš„ç‰ˆå‹ã€‚'); return; }

  // é€ä¸€è¤‡è£½ä¸¦ç§»é™¤ä¸ä¸‹è¼‰çš„å‚™è¨»
  const fragments = targets.map(n => cloneWithoutNoDownload(n).outerHTML).join('\n');

  const css = `
    body{font-family:'Microsoft JhengHei',sans-serif;padding:20px}
    .nutrition-table{margin:20px 0;border:2px solid #333;border-radius:8px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #333}
    th{background:#495057;color:#fff}
    .horizontal-label{border:2px solid #333;padding:20px;margin:20px 0;border-radius:8px;line-height:1.8}
    .note{margin-top:10px;padding:12px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:6px}
    .text-right{text-align:right}
  `;

  const html = `<!DOCTYPE html><html lang="zh-TW"><head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ç‡Ÿé¤Šæ¨™ç¤º</title>
  <style>${css}</style>
  </head><body>${fragments}</body></html>`;

  const blob = new Blob([html], {type:'text/html;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.rel = 'noopener';
  const orientLabel = mode === 'horizontal' ? 'æ©«å¼' : 'ç›´å¼';
  a.download = `ç‡Ÿé¤Šæ¨™ç¤º_${orientLabel}.html`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 0);
}

/** ä¸‹è¼‰ Excelï¼ˆåˆ†ç›´å¼/æ©«å¼æŒ‰éˆ•ï¼Œä½†å…§å®¹ä¸€è‡´ï¼›æª”åæœƒæ¨™è¨»ï¼‰ */
function downloadExcel(mode /* 'vertical' | 'horizontal' */ = 'vertical'){
  const prev = document.getElementById('previewArea');
  if(!prev || prev.children.length===0){
    alert('è«‹å…ˆç”Ÿæˆé è¦½'); 
    return;
  }

  const dv = getDailyReference();
  const data = [];
  const orientLabel = mode === 'horizontal' ? 'ï¼ˆæ©«å¼ï¼‰' : 'ï¼ˆç›´å¼ï¼‰';

  // é é¦–
  data.push(['ç‡Ÿé¤Šæ¨™ç¤º' + orientLabel]);
  data.push([]);

  // ä»½é‡è¡Œ
  if (formData.selectedFormat==='format3'){
    data.push(['æ¯ä¸€ä»½é‡', (Number(formData.servingSize)||0).toFixed(2), 'é¡†/éŒ /ç²’']);
  }else{
    data.push(['æ¯ä¸€ä»½é‡', (Number(formData.servingSize)||0).toFixed(2), formData.unit]);
  }
  // æœ¬åŒ…è£å«
  data.push(['æœ¬åŒ…è£å«', formData.servingsPerContainer, 'ä»½']);
  data.push([]);

  // === å„æ ¼å¼ ===
  if (formData.selectedFormat==='format3'){
    // æ¬„é ­
    data.push(['ç‡Ÿé¤Šç´ ','æ¯ä»½','æ¯æ—¥åƒè€ƒå€¼ç™¾åˆ†æ¯”']);

    // ç¶­ç”Ÿç´ 
    formData.vitamins.forEach(v=>{
      const pct = calculateDailyPercentage(v.name, v.value, dv); // ä½ åŸæœ¬çš„å·¥å…·
      const showIU = ['ç¶­ç”Ÿç´ A','ç¶­ç”Ÿç´ D','ç¶­ç”Ÿç´ E'].includes(v.name) && typeof v.iu === 'number' && !isNaN(v.iu);
      const valTxt = showIU
        ? `${fmtSig3(v.value)} ${getUnitText(v.unit)}ï¼ˆ${v.iu} IUï¼‰`
        : `${fmtSig3(v.value)} ${getUnitText(v.unit)}`;
      data.push([v.name, valTxt, pct]);
    });

    // ç¤¦ç‰©è³ª
    formData.minerals.forEach(m=>{
      data.push([m.name, `${fmtSig3(m.value)} ${getUnitText(m.unit)}`, calculateDailyPercentage(m.name, m.value, dv)]);
    });

    // å…¶ä»–ï¼ˆè‡ªé¡˜æ¨™ç¤ºé …ç›®ï¼›åŒ…å«æœ‰æ©Ÿé…¸èˆ‡ä½ æ‰‹å‹•æ–°å¢çš„å…«å¤§ç‡Ÿé¤Šç´ èˆ‡ã€Œç†±é‡ã€ï¼‰
    // è¦å‰‡ï¼šæ ¼å¼3ä¸è¨ˆç®— %DVï¼Œæ°¸é é¡¯ç¤ºã€Œï¼Šã€
    if (formData.additionalNutrients.length>0){
      formData.additionalNutrients.forEach(n=>{
        const dispName = getDisplayedNutrientName(n);            // â˜… ä½¿ç”¨é¡¯ç¤ºåç¨±
        const f = isVitaminMineralName(n.name) ? fmtSig3 : fmt;
        const show = (n.unit === 'kcal')
          ? `${fmt(n.value)} å¤§å¡`
          : `${f(n.value)} ${getUnitText(n.unit)}`;
        data.push([dispName, show, 'ï¼Š']);
      });
    }

    data.push([]);
    // åƒè€ƒå€¼æ¸…å–®ï¼ˆæ ¼å¼3ç”¨ç¶­ç”Ÿç´ /ç¤¦ç‰©è³ªæ¸…å–®ï¼‰
    data.push(['æ¯æ—¥åƒè€ƒå€¼', buildDVListText(dv,'format3')]);

  }else if (formData.selectedFormat==='format1'){
    // æ¬„é ­
    data.push(['ç‡Ÿé¤Šç´ ','æ¯ä»½','æ¯100'+formData.unit]);
    // å…«å¤§
    data.push(['ç†±é‡', `${fmt(formData.perServing.calories)} å¤§å¡`, `${fmt(formData.nutrients.calories)} å¤§å¡`]);
    data.push(['è›‹ç™½è³ª', `${fmt(formData.perServing.protein)} å…¬å…‹`, `${fmt(formData.nutrients.protein||0)} å…¬å…‹`]);
    data.push(['è„‚è‚ª', `${fmt(formData.perServing.fat)} å…¬å…‹`, `${fmt(formData.nutrients.fat||0)} å…¬å…‹`]);
    data.push(['é£½å’Œè„‚è‚ª', `${fmt(formData.perServing.saturatedFat)} å…¬å…‹`, `${fmt(formData.nutrients.saturatedFat||0)} å…¬å…‹`]);
    data.push(['åå¼è„‚è‚ª', `${fmt(formData.perServing.transFat)} å…¬å…‹`, `${fmt(formData.nutrients.transFat||0)} å…¬å…‹`]);
    data.push(['ç¢³æ°´åŒ–åˆç‰©', `${fmt(formData.perServing.carbs)} å…¬å…‹`, `${fmt(formData.nutrients.carbs||0)} å…¬å…‹`]);
    data.push(['ç³–', `${fmt(formData.perServing.sugar)} å…¬å…‹`, `${fmt(formData.nutrients.sugar||0)} å…¬å…‹`]);
    data.push(['éˆ‰', `${fmt(formData.perServing.sodium)} æ¯«å…‹`, `${fmt(formData.nutrients.sodium||0)} æ¯«å…‹`]);

    // å…¶ä»–è‡ªé¡˜é …ç›®ï¼ˆç”¨é¡¯ç¤ºåç¨±ï¼‰
    formData.additionalNutrients.forEach(n=>{
      const per = (Number(n.value||0) * (formData.servingSize/100));
      const f = isVitaminMineralName(n.name) ? fmtSig3 : fmt;
      const dispName = getDisplayedNutrientName(n);              // â˜… ä½¿ç”¨é¡¯ç¤ºåç¨±
      data.push([dispName, `${f(per)} ${getUnitText(n.unit)}`, `${f(n.value)} ${getUnitText(n.unit)}`]);
    });

  }else if (formData.selectedFormat==='format2'){
    // æ¬„é ­
    data.push(['ç‡Ÿé¤Šç´ ','æ¯ä»½','æ¯æ—¥åƒè€ƒå€¼ç™¾åˆ†æ¯”']);
    // å…«å¤§ï¼ˆ%DVï¼‰
    data.push(['ç†±é‡', `${fmt(formData.perServing.calories)} å…¬å…‹`.replace(' å…¬å…‹',' å¤§å¡'), ((formData.perServing.calories/dv.calories)*100).toFixed(1)+'%']);
    data.push(['è›‹ç™½è³ª', `${fmt(formData.perServing.protein)} å…¬å…‹`, ((formData.perServing.protein/dv.protein)*100).toFixed(1)+'%']);
    data.push(['è„‚è‚ª', `${fmt(formData.perServing.fat)} å…¬å…‹`, dv.fat?((formData.perServing.fat/dv.fat)*100).toFixed(1)+'%':'ï¼Š']);
    data.push(['é£½å’Œè„‚è‚ª', `${fmt(formData.perServing.saturatedFat)} å…¬å…‹`, dv.saturatedFat?((formData.perServing.saturatedFat/dv.saturatedFat)*100).toFixed(1)+'%':'ï¼Š']);
    data.push(['åå¼è„‚è‚ª', `${fmt(formData.perServing.transFat)} å…¬å…‹`, 'ï¼Š']);
    data.push(['ç¢³æ°´åŒ–åˆç‰©', `${fmt(formData.perServing.carbs)} å…¬å…‹`, dv.carbs?((formData.perServing.carbs/dv.carbs)*100).toFixed(1)+'%':'ï¼Š']);
    data.push(['ç³–', `${fmt(formData.perServing.sugar)} å…¬å…‹`, 'ï¼Š']);
    data.push(['éˆ‰', `${fmt(formData.perServing.sodium)} æ¯«å…‹`, ((formData.perServing.sodium/dv.sodium)*100).toFixed(1)+'%']);

    // å…¶ä»–ï¼ˆè¨ˆ %DVï¼›åç¨±è¦ç”¨é¡¯ç¤ºåç¨±ï¼‰
    formData.additionalNutrients.forEach(n=>{
      const per = (n.value*formData.servingSize/100);
      const key = nutrientNameToDVKey(n.name);
      let pctText='ï¼Š';
      if (key && dv[key]!==undefined){
        const perSameUnit = convertToSameUnit(per, n.unit, dvUnitFromKey(key));
        pctText = ((perSameUnit/dv[key])*100).toFixed(1)+'%';
      }
      const f = isVitaminMineralName(n.name) ? fmtSig3 : fmt;
      const dispName = getDisplayedNutrientName(n);              // â˜… ä½¿ç”¨é¡¯ç¤ºåç¨±
      data.push([dispName, `${f(per)} ${getUnitText(n.unit)}`, pctText]);
    });

    data.push([]);
    data.push(['æ¯æ—¥åƒè€ƒå€¼', buildDVListText(dv,'format2')]);
  }

  // === è¼¸å‡º .xlsx ===
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ç‡Ÿé¤Šæ¨™ç¤º');

  // ç²—ç•¥è‡ªå‹•æ¬„å¯¬ï¼ˆé¿å…è¢«æ“ åœ¨ä¸€èµ·ï¼‰
  const colWidths = [];
  data.forEach(row=>{
    row.forEach((cell, i)=>{
      const len = String(cell).length;
      colWidths[i] = Math.max(colWidths[i]||10, Math.min(len+4, 40));
    });
  });
  ws['!cols'] = (colWidths||[]).map(w => ({wch:w}));

  XLSX.writeFile(wb, `ç‡Ÿé¤Šæ¨™ç¤º_${mode==='horizontal'?'æ©«å¼':'ç›´å¼'}.xlsx`);
}


    /* ===== è¿”å›/é‡ç½® ===== */
    function backToSelection(){ document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active')); document.getElementById('step1-3').classList.add('active'); updateProgressBar(1); }
    function backToDataEntry(){ document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active')); document.getElementById('step2').classList.add('active'); updateProgressBar(2); }
    function backToFormatSelection(){ document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active')); document.getElementById('step3').classList.add('active'); updateProgressBar(3); }
    function resetTool(){ if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡è¢«æ¸…é™¤ã€‚')) location.reload(); }

    /* ===== åˆå§‹åŒ– ===== */
    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('mixed').addEventListener('change', function(){
        if (this.checked){
          const unitChoice=prompt('è«‹é¸æ“‡å–®ä½ï¼ˆè¼¸å…¥ 1=å…¬å…‹ï¼Œ2=æ¯«å‡ï¼‰ï¼š');
          formData.unit = unitChoice==='2' ? 'æ¯«å‡' : 'å…¬å…‹';
        }
      });
      document.addEventListener('change', function(e){
        if (e.target && e.target.name==='capsuleMode'){
          if (e.target.value==='count'){
            document.getElementById('capsuleCountFields').style.display='grid';
            document.getElementById('capsuleWeightFields').style.display='none';
          }else{
            document.getElementById('capsuleCountFields').style.display='none';
            document.getElementById('capsuleWeightFields').style.display='grid';
          }
        }
      });
    });
	function detectCurrentFormatFromDOM(){
  // å„ªå…ˆç”¨ formDataï¼Œå¦‚æœæ²’æœ‰å°±å¾ç•«é¢ä¸Šçš„é è¦½ç¯€é»åˆ¤æ–·
  if (formData && formData.selectedFormat) return formData.selectedFormat;

  const area = document.getElementById('previewArea');
  if (!area) return '';

  if (area.querySelector('#format1Table') || area.querySelector('#format1Horizontal')) return 'format1';
  if (area.querySelector('#format2Table') || area.querySelector('#format2Horizontal')) return 'format2';
  if (area.querySelector('#format3Table') || area.querySelector('#format3Horizontal')) return 'format3';

  // å†ä¸è¡Œå°±çœ‹æ­¥é©Ÿ3çš„é¸å–ï¼ˆè¬ä¸€ä½¿ç”¨è€…åœç•™åœ¨æ­¥é©Ÿ3ï¼‰
  const sel = document.querySelector('input[name="format"]:checked');
  return sel ? sel.value : '';
}

function rerenderByFormat(fmt){
  const area = document.getElementById('previewArea');
  if (!area) { alert('æ‰¾ä¸åˆ°é è¦½å€å¡Š'); return; }

  if (fmt === 'format1'){
    area.innerHTML = generateFormat1() + generateFormat1Horizontal();
  } else if (fmt === 'format2'){
    area.innerHTML = generateFormat2() + generateFormat2Horizontal();
  } else if (fmt === 'format3'){
    area.innerHTML = generateFormat3() + generateFormat3Horizontal();
  } else {
    alert('å°šæœªé¸æ“‡æ¨™ç¤ºæ ¼å¼'); 
  }
}

function regeneratePreview(){
  try{
    // 1) å…ˆåˆ¤æ–·ç›®å‰æ‡‰è©²ç”¨å“ªå€‹æ ¼å¼
    const fmt = detectCurrentFormatFromDOM();
    if (!fmt){
      alert('å°šæœªé¸æ“‡æ¨™ç¤ºæ ¼å¼'); 
      return;
    }

    // 2) è£œå¯«å› formData.selectedFormatï¼ˆé¿å…å¾ŒçºŒåŠŸèƒ½éœ€è¦ï¼‰
    formData.selectedFormat = fmt;

    // 3) è‹¥ä¸æ˜¯æ ¼å¼3ï¼ˆè† å›Šç¶­ç”Ÿç´ å°ˆç”¨ï¼‰ï¼Œé‡ç®—æ¯ä»½æ•¸å€¼
    //    ï¼ˆä¸å½ˆçª—ã€ä¸è®€å–è¼¸å…¥æ¡†ï¼Œç´”ç²¹ç”¨ formData æ—¢æœ‰å€¼é‡ç®—ï¼‰
    if (formData.specificType !== 'vitaminCapsule'){
      calculatePerServing();
    }

    // 4) é‡æ–°æ¸²æŸ“è©²æ ¼å¼çš„ç›´å¼ï¼‹æ©«å¼
    rerenderByFormat(fmt);

  }catch(err){
    console.error('regeneratePreview error:', err);
    alert('é‡æ–°è©•ä¼°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é–‹å•Ÿä¸»æ§å°ï¼ˆConsoleï¼‰æŸ¥çœ‹ç´°ç¯€');
  }
}
/* è®“å‡½å¼åœ¨å…¨åŸŸå¯è¦‹ï¼Œé¿å…ä½œç”¨åŸŸå°è‡´æ‰¾ä¸åˆ° */
window.regeneratePreview = function regeneratePreview(){
  try{
    const fmt = detectCurrentFormatFromDOM();
    if (!fmt){ alert('å°šæœªé¸æ“‡æ¨™ç¤ºæ ¼å¼'); return; }

    // å›å¡«é¸æ“‡æ ¼å¼åˆ°ç‹€æ…‹ï¼Œä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨
    if (window.formData) formData.selectedFormat = fmt;

    // éæ ¼å¼3ï¼ˆç¶­ç”Ÿç´ ç¤¦ç‰©è³ªå°ˆç”¨ï¼‰æ‰éœ€è¦ä¾ç›®å‰ formData é‡ç®—æ¯ä»½
    if (formData?.specificType !== 'vitaminCapsule'){
      if (typeof calculatePerServing === 'function') {
        calculatePerServing();
      }
    }

    rerenderByFormat(fmt);
  }catch(err){
    console.error('regeneratePreview error:', err);
    alert('é‡æ–°è©•ä¼°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ‰“é–‹ Console æŸ¥çœ‹è¨Šæ¯');
  }
};

/* æ”¯æ´å‡½å¼ï¼ˆä¹Ÿæ›åˆ°å…¨åŸŸï¼Œé¿å…æ‰¾ä¸åˆ°ï¼‰ */
window.detectCurrentFormatFromDOM = function detectCurrentFormatFromDOM(){
  if (window.formData?.selectedFormat) return formData.selectedFormat;
  const area = document.getElementById('previewArea');
  if (!area) return '';
  if (area.querySelector('#format1Table, #format1Horizontal')) return 'format1';
  if (area.querySelector('#format2Table, #format2Horizontal')) return 'format2';
  if (area.querySelector('#format3Table, #format3Horizontal')) return 'format3';
  const sel = document.querySelector('input[name="format"]:checked');
  return sel ? sel.value : '';
};

window.rerenderByFormat = function rerenderByFormat(fmt){
  const area = document.getElementById('previewArea');
  if (!area){ alert('æ‰¾ä¸åˆ°é è¦½å€å¡Š'); return; }
  if (fmt === 'format1'){
    area.innerHTML = generateFormat1() + generateFormat1Horizontal();
  } else if (fmt === 'format2'){
    area.innerHTML = generateFormat2() + generateFormat2Horizontal();
  } else if (fmt === 'format3'){
    area.innerHTML = generateFormat3() + generateFormat3Horizontal();
  } else {
    alert('å°šæœªé¸æ“‡æ¨™ç¤ºæ ¼å¼');
  }
};

/* ç¶å®šæŒ‰éˆ•äº‹ä»¶ï¼ˆç¢ºä¿ DOM å°±ç·’å¾Œç¶å®šï¼‰ */
document.addEventListener('DOMContentLoaded', () => {
  const b = document.getElementById('btnRegen');
  if (b) b.addEventListener('click', window.regeneratePreview);
});

function toGram(val, unit){
  const u = String(unit).toLowerCase();
  if (u === 'g') return val;
  if (u === 'mg') return val/1000;
  if (u === 'mcg' || u === 'Î¼g') return val/1_000_000;
  return val; // å…¶ä»–ç•¶æˆ gï¼Œä¸æœƒé€²åˆ°ç†±é‡è¨ˆç®—
}
function computeKcalFromAdditionalF3(){
  let proteinG=0, fatG=0, carbG=0, fiberG=0, eryth=0, otherPolyols=0, organicAcidsG=0, ethanolG=0;

  for (const n of formData.additionalNutrients){
    const nm = String(n.name||'');
    const gram = toGram(Number(n.value)||0, n.unit);

    if (nm === 'è›‹ç™½è³ª') proteinG += gram;
    else if (nm === 'è„‚è‚ª') fatG += gram;
    else if (nm === 'ç¢³æ°´åŒ–åˆç‰©') carbG += gram;
    else if (nm.includes('è†³é£Ÿçº–ç¶­')) fiberG += gram;
    else if (nm.includes('èµ¤è—»ç³–é†‡')) eryth += gram;
    else if (nm.includes('ç³–é†‡')) otherPolyols += gram;          // å…¶ä»–ç³–é†‡
    else if (n.isOrganicAcid) organicAcidsG += gram;              // æœ‰æ©Ÿé…¸æ——æ¨™
    else if (nm.includes('é…’ç²¾')) ethanolG += gram;
  }

  const netCarb = Math.max(0, carbG - fiberG - eryth);
  return proteinG*4 + fatG*9 + netCarb*4 + fiberG*2 + otherPolyols*2.4 + organicAcidsG*3 + ethanolG*7;
}
  function getDisplayName(n){
  if (n && n.isOrganicAcid) {
    const custom = (n.organicAcidName || '').trim();
    return custom || 'æœ‰æ©Ÿé…¸'; // è‹¥ä½¿ç”¨è€…æ²’å¡«ï¼Œé€€å›ã€Œæœ‰æ©Ÿé…¸ã€
  }
  return n?.name || '';
}
	  // åªå›å‚³ã€Œæ¯ä¸€ä»½é‡ã€å³å´è¦é¡¯ç¤ºçš„å…§å®¹
function getCapsuleServingContent(){
  const modeEl = document.querySelector('input[name="capsuleMode"]:checked');
  const label = formData.capsuleUnitLabel || 'é¡†';

  // é¡†æ•¸æ¨¡å¼ï¼ˆæ¯ä»½ å¹¾é¡† Ã— æ¯é¡† é‡é‡ï¼‰
  if (modeEl && modeEl.value === 'count') {
    const count = parseFloat(document.getElementById('capsuleCount')?.value) || 0;
    const per   = parseFloat(document.getElementById('capsuleUnitWeight')?.value) || 0;
    const perU  = document.getElementById('capsuleUnitWeightUnit')?.value === 'mg' ? 'æ¯«å…‹' : 'å…¬å…‹';
    // ä¾‹ï¼š2 é¡†ï¼ˆæ¯é¡†0.50 å…¬å…‹ï¼‰
    return `${count} ${label}ï¼ˆæ¯${label}${per.toFixed(2)} ${perU}ï¼‰`;
  }

  // é‡é‡æ¨¡å¼ï¼ˆç›´æ¥é¡¯ç¤ºæ¯ä»½é‡é‡ï¼Œå–®ä½å›ºå®šå…¬å…‹/æ¯«å…‹ï¼‰
  if (modeEl && modeEl.value === 'weight') {
    const w = parseFloat(document.getElementById('capsuleServingWeight')?.value) || 0;
    const u = (document.getElementById('capsuleServingWeightUnit')?.value === 'mg') ? 'æ¯«å…‹' : 'å…¬å…‹';
    // ä¾‹ï¼š0.80 å…¬å…‹
    return `${w.toFixed(2)} ${u}`;
  }

  // å¾Œå‚™ï¼šè‹¥æ²’é¸æ¨¡å¼ï¼Œå°±ç”¨å·²ç®—å¥½çš„æ¯ä»½é‡é‡ï¼ˆå…¬å…‹ï¼‰
  return `${(Number(formData.servingSize)||0).toFixed(2)} å…¬å…‹`;
}

  </script>
</body>
</html>





