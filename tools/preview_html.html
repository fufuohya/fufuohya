<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å³æ™‚ HTML ç·¨è¼¯èˆ‡é è¦½å·¥å…·</title>
  <style>
    :root{
      --bg-primary: #0a0e1a;
      --bg-secondary: #0f1419;
      --bg-tertiary: #151b26;
      --surface: #1a2332;
      --surface-hover: #1f2937;
      --border: #2d3748;
      --border-light: #374151;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-glow: rgba(59, 130, 246, 0.3);
      --success: #10b981;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --warning: #f59e0b;
      --highlight: #fbbf24;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --glow: 0 0 20px var(--accent-glow);
    }
    
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }
    
    html,body{
      height:100%;
      overflow:hidden;
    }
    
    body{
      background: linear-gradient(135deg, #0a0e1a 0%, #0f1419 50%, #0a0e1a 100%);
      color:var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Header å„ªåŒ– */
    header{
      display:flex;
      align-items:center;
      gap:1rem;
      justify-content:space-between;
      padding:1rem 1.5rem;
      background: linear-gradient(180deg, rgba(15, 20, 25, 0.95), rgba(10, 14, 26, 0.98));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      position:sticky;
      top:0;
      z-index:100;
      flex-wrap:wrap;
      box-shadow: var(--shadow-md);
    }
    
    .brand{
      display:flex;
      align-items:center;
      gap:.75rem;
    }
    
    .brand .dot{
      width:12px;
      height:12px;
      border-radius:50%;
      background: linear-gradient(135deg, var(--accent), #60a5fa);
      box-shadow: 0 0 16px var(--accent-glow), 0 0 32px var(--accent-glow);
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }
    
    .brand h1{
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.3px;
      color: var(--text-primary);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* Toolbar å„ªåŒ– */
    .toolbar{
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      align-items:center;
    }
    
    .toolbar button,
    .toolbar label{
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: .5rem .875rem;
      border-radius: .5rem;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      user-select: none;
    }
    
    .toolbar button:hover{
      background: var(--surface-hover);
      border-color: var(--border-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      color: var(--text-primary);
    }
    
    .toolbar button:active{
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .toolbar label{
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem .75rem;
    }
    
    .toolbar label input[type="checkbox"]{
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--accent);
    }
    
    .toolbar .stat{
      color: var(--success);
      font-size: 12px;
      font-weight: 600;
      padding: .5rem .875rem;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: .5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .toolbar button.danger{
      border-color: rgba(239, 68, 68, 0.4);
      color: var(--danger);
    }
    
    .toolbar button.danger:hover{
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
      color: #fca5a5;
    }

    /* Layout å„ªåŒ– */
    .layout{
      display: grid;
      grid-template-columns: minmax(400px, 1fr) minmax(450px, 1fr);
      gap: 1rem;
      height: calc(100% - 77px);
      padding: 1rem;
      overflow: hidden;
    }
    
    .pane{
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    
    .pane h2{
      padding: .875rem 1.25rem;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }

    /* Editor Section å„ªåŒ– */
    .editor-wrap{
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      padding: 1rem;
      overflow: hidden;
    }
    
    .editor-actions{
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    
    .editor-actions button{
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: .4rem .75rem;
      border-radius: .4rem;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s ease;
    }
    
    .editor-actions button:hover{
      background: var(--surface);
      border-color: var(--border-light);
      color: var(--text-primary);
    }
    
    .editor-actions button.danger:hover{
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
      color: #fca5a5;
    }
    
    /* Search & Replace å„ªåŒ– */
    .search-replace{
      display: flex;
      flex-direction: column;
      gap: .625rem;
      padding: .875rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: .75rem;
      box-shadow: var(--shadow-sm);
    }
    
    .search-row{
      display: flex;
      gap: .5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .search-replace input[type="text"]{
      flex: 1;
      min-width: 160px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: .5rem .75rem;
      border-radius: .5rem;
      font-size: 13px;
      font-family: inherit;
      transition: all .2s ease;
    }
    
    .search-replace input[type="text"]:focus{
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    
    .search-replace input[type="text"]::placeholder{
      color: var(--text-muted);
    }
    
    .search-replace button{
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: .5rem .875rem;
      border-radius: .5rem;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s ease;
      white-space: nowrap;
    }
    
    .search-replace button:hover{
      background: var(--surface-hover);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .search-replace .badge{
      border: 1px solid var(--border);
      padding: .375rem .625rem;
      border-radius: .4rem;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      background: var(--surface);
      white-space: nowrap;
    }
    
    .search-replace .count{
      color: var(--success);
      font-weight: 700;
    }
    
    /* Textarea å„ªåŒ– */
    textarea{
      flex: 1;
      width: 100%;
      resize: none;
      border-radius: .75rem;
      padding: 1rem;
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      outline: none;
      transition: all .2s ease;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    textarea:focus{
      border-color: var(--accent);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 3px var(--accent-glow);
    }
    
    textarea::selection{
      background: rgba(59, 130, 246, 0.3);
    }
    
    .hint{
      color: var(--text-muted);
      font-size: 11px;
      padding: 0 .25rem;
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
    }

    /* Preview Section å„ªåŒ– */
    .preview-wrap{
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow: hidden;
    }
    
    iframe{
      flex: 1;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: .75rem;
      background: #ffffff;
      box-shadow: var(--shadow-md);
    }

    /* Utility Components */
    .kbd{
      display: inline-block;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: .125rem .375rem;
      border-radius: .3rem;
      font-size: 11px;
      font-family: inherit;
      color: var(--text-secondary);
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    /* Footer å„ªåŒ– */
    .footer{
      padding: .75rem 1.5rem;
      color: var(--text-muted);
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      font-size: 12px;
      text-align: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.2);
    }

    /* Responsive */
    @media (max-width: 1024px){
      .layout{
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }
      
      header{
        padding: .875rem 1rem;
      }
      
      .brand h1{
        font-size: 13px;
      }
    }
    
    @media (max-width: 640px){
      .toolbar{
        font-size: 12px;
      }
      
      .toolbar button,
      .toolbar label{
        padding: .4rem .625rem;
        font-size: 12px;
      }
      
      .layout{
        padding: .5rem;
        gap: .5rem;
      }
    }

    /* Scrollbar å„ªåŒ– */
    ::-webkit-scrollbar{
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track{
      background: var(--bg-tertiary);
    }
    
    ::-webkit-scrollbar-thumb{
      background: var(--border-light);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover{
      background: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="dot"></div>
      <h1>å³æ™‚ HTML ç·¨è¼¯èˆ‡é è¦½å·¥å…· Â· Live HTML Pad</h1>
    </div>
    <div class="toolbar">
      <button id="btn-new" title="æ¸…ç©ºå…§å®¹ (Alt+N)">ğŸ”„ æ–°æª”</button>
      <input type="file" id="file-open" hidden accept=".html,.htm,.txt" />
      <button id="btn-open" title="é–‹å•Ÿæª”æ¡ˆ (Alt+O)">ğŸ“‚ é–‹å•Ÿ</button>
      <button id="btn-save" title="ä¸‹è¼‰ (Ctrl/Cmd+S)">ğŸ’¾ ä¸‹è¼‰</button>
      <button id="btn-format" title="ç°¡æ˜“æ’ç‰ˆ (Alt+F)">âœ¨ æ ¼å¼åŒ–</button>
      <label title="åˆ‡æ›è‡ªå‹•æ›´æ–° (Alt+U)">
        <input type="checkbox" id="auto-update" checked />
        è‡ªå‹•æ›´æ–°
      </label>
      <span class="stat" id="status">å°±ç·’</span>
    </div>
  </header>

  <div class="layout">
    <section class="pane">
      <h2>HTML åŸå§‹ç¢¼</h2>
      <div class="editor-wrap">
        <div class="editor-actions">
          <button id="btn-select-all" title="å…¨é¸æ–‡å­— (Ctrl/Cmd+A)">ğŸ“‹ å…¨é¸</button>
          <button id="btn-clear-all" class="danger" title="æ¸…ç©ºç·¨è¼¯å™¨ (Alt+C)">ğŸ—‘ï¸ å…¨åˆªé™¤</button>
          <button id="btn-copy" title="è¤‡è£½åˆ°å‰ªè²¼ç°¿ (Ctrl/Cmd+C)">ğŸ“‹ è¤‡è£½</button>
          <button id="btn-undo" title="å¾©åŸ (Ctrl/Cmd+Z)">â†©ï¸ å¾©åŸ</button>
        </div>
        
        <div class="search-replace">
          <div class="search-row">
            <input type="text" id="search-code" placeholder="ğŸ” æœå°‹ç¨‹å¼ç¢¼..." />
            <button id="btn-prev-code">â–² ä¸Šä¸€å€‹</button>
            <button id="btn-next-code">â–¼ ä¸‹ä¸€å€‹</button>
            <span class="badge">ç¬¦åˆï¼š<span id="code-match-count" class="count">0</span></span>
            <span class="badge">ç›®å‰ï¼š<span id="code-match-index">-</span></span>
          </div>
          <div class="search-row">
            <input type="text" id="replace-code" placeholder="âœï¸ å–ä»£ç‚º..." />
            <button id="btn-replace-one">å–ä»£ç›®å‰</button>
            <button id="btn-replace-all">å…¨éƒ¨å–ä»£</button>
          </div>
        </div>
        
        <textarea id="editor" spellcheck="false" placeholder="åœ¨æ­¤è¼¸å…¥æˆ–è²¼ä¸Š HTML â€¦"></textarea>
        <div class="hint">
          âœ¦ å¿«æ·éµï¼š
          <span class="kbd">Ctrl/Cmd + F</span> æœå°‹
          <span class="kbd">Ctrl/Cmd + S</span> ä¸‹è¼‰
          <span class="kbd">Alt + C</span> å…¨åˆªé™¤
        </div>
      </div>
    </section>

    <section class="pane">
      <h2>å³æ™‚é è¦½</h2>
      <div class="preview-wrap">
        <iframe id="preview" sandbox="allow-scripts allow-modals"></iframe>
      </div>
    </section>
  </div>

  <div class="footer">ğŸ’¡ æœ¬å·¥å…·ä¸æœƒä¸Šå‚³è³‡æ–™ï¼›ç·¨è¼¯å…§å®¹æœƒæš«å­˜æ–¼ç€è¦½å™¨ã€‚å»ºè­°å¸¸ç”¨ã€Œä¸‹è¼‰ã€ä¿å­˜å‰¯æœ¬ã€‚</div>

<script>
(function(){
  const editor = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const searchCodeBox = document.getElementById('search-code');
  const replaceCodeBox = document.getElementById('replace-code');
  const statusEl = document.getElementById('status');
  const codeCountEl = document.getElementById('code-match-count');
  const codeIdxEl = document.getElementById('code-match-index');
  const autoUpdate = document.getElementById('auto-update');

  const btnNew = document.getElementById('btn-new');
  const btnOpen = document.getElementById('btn-open');
  const fileOpen = document.getElementById('file-open');
  const btnSave = document.getElementById('btn-save');
  const btnFormat = document.getElementById('btn-format');
  const btnPrevCode = document.getElementById('btn-prev-code');
  const btnNextCode = document.getElementById('btn-next-code');
  const btnReplaceOne = document.getElementById('btn-replace-one');
  const btnReplaceAll = document.getElementById('btn-replace-all');
  const btnSelectAll = document.getElementById('btn-select-all');
  const btnClearAll = document.getElementById('btn-clear-all');
  const btnCopy = document.getElementById('btn-copy');
  const btnUndo = document.getElementById('btn-undo');

  let debounceTimer = null;
  let codeMatches = [];
  let currentCodeMatch = -1;
  let history = [];
  let historyIndex = -1;

  const DEFAULT_HTML = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>æˆ‘çš„é é¢</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial; margin:2rem; line-height:1.6}
    h1{font-size:clamp(1.6rem, 2.5vw, 2rem);}
    p{margin:.5rem 0}
    .note{padding:.5rem .75rem; border:1px dashed #9ca3af; border-radius:.5rem; background:#f8fafc}
    mark{padding:.05rem .2rem; border-radius:.2rem}
  </style>
</head>
<body>
  <h1>æ­¡è¿ä½¿ç”¨å³æ™‚ HTML ç·¨è¼¯å™¨ âœ¨</h1>
  <p>å·¦å´è¼¸å…¥ HTMLï¼Œå³å´å³æ™‚é è¦½ã€‚è©¦è‘—è¼¸å…¥ä¸€äº› <strong>æ®µè½æ–‡å­—</strong>ï¼Œå†ç”¨ä¸Šæ–¹çš„æœå°‹æ¡†å°‹æ‰¾å§ã€‚</p>
  <p class="note">æç¤ºï¼šæœ¬å·¥å…·æœƒæœå°‹ç¨‹å¼ç¢¼å…§å®¹ï¼Œä¸¦æ”¯æ´å–ä»£åŠŸèƒ½ã€‚</p>
  <p>å¿«é€Ÿéµï¼š<kbd>Ctrl/Cmd + S</kbd> ä¸‹è¼‰ã€<kbd>Ctrl/Cmd + F</kbd> æœå°‹ã€‚</p>
</body>
</html>`;

  function saveToHistory(content){
    if(historyIndex < history.length - 1){
      history = history.slice(0, historyIndex + 1);
    }
    history.push(content);
    if(history.length > 50) history.shift();
    else historyIndex++;
  }

  function setStatus(msg){
    statusEl.textContent = msg;
    clearTimeout(setStatus._t);
    setStatus._t = setTimeout(()=> statusEl.textContent = 'å°±ç·’', 1200);
  }

  function injectPreview(html){
    const wrapper = `<!doctype html><html><head><meta charset="utf-8"><style>
      html{scroll-behavior:smooth}
    </style></head><body data-livepad>
    ${html}
    </body></html>`;
    preview.srcdoc = wrapper;
  }

  function updatePreview(){
    injectPreview(editor.value);
  }

  function debounceUpdate(){
    if(!autoUpdate.checked) return;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 250);
  }

  function searchInCode(){
    const query = searchCodeBox.value;
    codeMatches = [];
    currentCodeMatch = -1;

    if(!query){
      codeCountEl.textContent = '0';
      codeIdxEl.textContent = '-';
      return;
    }

    const code = editor.value;
    const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    let match;
    
    while((match = regex.exec(code)) !== null){
      codeMatches.push({
        index: match.index,
        length: match[0].length
      });
    }

    codeCountEl.textContent = String(codeMatches.length);
    
    if(codeMatches.length > 0){
      currentCodeMatch = 0;
      highlightCodeMatch();
    } else {
      codeIdxEl.textContent = '-';
    }
  }

  function highlightCodeMatch(){
    if(currentCodeMatch < 0 || currentCodeMatch >= codeMatches.length){
      codeIdxEl.textContent = '-';
      return;
    }

    const match = codeMatches[currentCodeMatch];
    editor.focus();
    editor.setSelectionRange(match.index, match.index + match.length);
    
    const lineHeight = 20;
    const lines = editor.value.substring(0, match.index).split('\n').length;
    editor.scrollTop = Math.max(0, (lines - 10) * lineHeight);
    
    codeIdxEl.textContent = `${currentCodeMatch + 1}/${codeMatches.length}`;
  }

  function nextCodeMatch(){
    if(codeMatches.length === 0) return;
    currentCodeMatch = (currentCodeMatch + 1) % codeMatches.length;
    highlightCodeMatch();
  }

  function prevCodeMatch(){
    if(codeMatches.length === 0) return;
    currentCodeMatch = (currentCodeMatch - 1 + codeMatches.length) % codeMatches.length;
    highlightCodeMatch();
  }

  function replaceCurrentMatch(){
    if(currentCodeMatch < 0 || currentCodeMatch >= codeMatches.length){
      setStatus('è«‹å…ˆæœå°‹ä¸¦é¸æ“‡è¦å–ä»£çš„å…§å®¹');
      return;
    }

    const searchText = searchCodeBox.value;
    const replaceText = replaceCodeBox.value;
    
    if(!searchText){
      setStatus('è«‹è¼¸å…¥æœå°‹å…§å®¹');
      return;
    }

    saveToHistory(editor.value);
    
    const match = codeMatches[currentCodeMatch];
    const before = editor.value.substring(0, match.index);
    const after = editor.value.substring(match.index + match.length);
    
    editor.value = before + replaceText + after;
    localStorage.setItem('livepad_html', editor.value);
    updatePreview();
    
    searchInCode();
    setStatus('âœ“ å·²å–ä»£ 1 è™•');
  }

  function replaceAllMatches(){
    const searchText = searchCodeBox.value;
    const replaceText = replaceCodeBox.value;
    
    if(!searchText){
      setStatus('è«‹è¼¸å…¥æœå°‹å…§å®¹');
      return;
    }

    if(codeMatches.length === 0){
      setStatus('æ‰¾ä¸åˆ°ç¬¦åˆçš„å…§å®¹');
      return;
    }

    if(!confirm(`ç¢ºå®šè¦å–ä»£å…¨éƒ¨ ${codeMatches.length} è™•ç¬¦åˆçš„å…§å®¹å—ï¼Ÿ`)){
      return;
    }

    saveToHistory(editor.value);
    
    const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    editor.value = editor.value.replace(regex, replaceText);
    
    const count = codeMatches.length;
    localStorage.setItem('livepad_html', editor.value);
    updatePreview();
    searchInCode();
    
    setStatus(`âœ“ å·²å–ä»£ ${count} è™•`);
  }

  function saveAs(){
    const blob = new Blob([editor.value], {type:'text/html;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'live-html.html';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    setStatus('âœ“ å·²ä¸‹è¼‰');
  }

  function openFile(){ fileOpen.click(); }

  fileOpen.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    
    try {
      const text = await file.text();
      saveToHistory(editor.value);
      editor.value = text;
      updatePreview();
      localStorage.setItem('livepad_html', text);
      setStatus(`âœ“ å·²è¼‰å…¥ï¼š${file.name}`);
    } catch(error) {
      setStatus('âŒ è®€å–æª”æ¡ˆå¤±æ•—');
      console.error('File read error:', error);
    }
    
    fileOpen.value = '';
  });

  function newDoc(){
    if(editor.value.trim() && !confirm('ç¢ºå®šæ¸…ç©ºç›®å‰å…§å®¹ï¼Ÿ')) return;
    saveToHistory(editor.value);
    editor.value = DEFAULT_HTML;
    updatePreview();
    searchCodeBox.value = '';
    replaceCodeBox.value = '';
    searchInCode();
    localStorage.setItem('livepad_html', editor.value);
    setStatus('âœ“ å·²å»ºç«‹æ–°æª”');
  }

  function selectAll(){
    editor.select();
    editor.focus();
    setStatus('âœ“ å·²å…¨é¸');
  }

  function clearAll(){
    if(!editor.value.trim()){
      setStatus('ç·¨è¼¯å™¨å·²æ˜¯ç©ºçš„');
      return;
    }
    if(!confirm('ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨å…§å®¹å—ï¼Ÿæ­¤æ“ä½œå¯å¾©åŸã€‚')){
      return;
    }
    saveToHistory(editor.value);
    editor.value = '';
    updatePreview();
    localStorage.setItem('livepad_html', '');
    setStatus('âœ“ å·²æ¸…ç©ºå…§å®¹');
  }

  function copyToClipboard(){
    if(!editor.value.trim()){
      setStatus('ç„¡å…§å®¹å¯è¤‡è£½');
      return;
    }
    navigator.clipboard.writeText(editor.value).then(()=>{
      setStatus('âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }).catch(()=>{
      editor.select();
      document.execCommand('copy');
      setStatus('âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    });
  }

  function undo(){
    if(historyIndex <= 0){
      setStatus('ç„¡æ³•å¾©åŸ');
      return;
    }
    historyIndex--;
    editor.value = history[historyIndex];
    updatePreview();
    localStorage.setItem('livepad_html', editor.value);
    setStatus('âœ“ å·²å¾©åŸ');
  }

  function simpleFormat(html){
    try{
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const voids = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
      let out = '';
      let indent = 0;
      const pad = (n)=>'  '.repeat(n);
      function walk(node){
        for(const child of node.childNodes){
          if(child.nodeType === 1){
            const tag = child.tagName.toLowerCase();
            out += `\n${pad(indent)}<${tag}${[...child.attributes].map(a=>` ${a.name}="${a.value}"`).join('')}>`;
            if(!voids.has(tag)){
              indent++;
              walk(child);
              indent--;
              out += `\n${pad(indent)}</${tag}>`;
            }
          } else if(child.nodeType === 3){
            const text = child.nodeValue.replace(/\s+/g,' ').trim();
            if(text) out += `\n${pad(indent)}${text}`;
          } else if(child.nodeType === 8){
            out += `\n${pad(indent)}<!--${child.nodeValue}-->`;
          }
        }
      }
      walk(doc.documentElement);
      out = '<!DOCTYPE html>' + out + '\n';
      return out.trimStart();
    }catch(e){
      return html;
    }
  }

  editor.addEventListener('input', ()=>{ 
    localStorage.setItem('livepad_html', editor.value); 
    debounceUpdate();
    if(searchCodeBox.value){
      searchInCode();
    }
  });
  
  searchCodeBox.addEventListener('input', searchInCode);
  btnNextCode.addEventListener('click', nextCodeMatch);
  btnPrevCode.addEventListener('click', prevCodeMatch);
  btnReplaceOne.addEventListener('click', replaceCurrentMatch);
  btnReplaceAll.addEventListener('click', replaceAllMatches);
  btnSave.addEventListener('click', saveAs);
  btnOpen.addEventListener('click', openFile);
  btnNew.addEventListener('click', newDoc);
  btnSelectAll.addEventListener('click', selectAll);
  btnClearAll.addEventListener('click', clearAll);
  btnCopy.addEventListener('click', copyToClipboard);
  btnUndo.addEventListener('click', undo);
  btnFormat.addEventListener('click', ()=>{ 
    saveToHistory(editor.value);
    editor.value = simpleFormat(editor.value); 
    setStatus('âœ“ å·²æ ¼å¼åŒ–'); 
    updatePreview(); 
    localStorage.setItem('livepad_html', editor.value); 
  });

  window.addEventListener('keydown', (e)=>{
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    const ctrlCmd = isMac ? e.metaKey : e.ctrlKey;
    
    if(ctrlCmd && e.key.toLowerCase() === 's'){
      e.preventDefault(); saveAs();
    }
    if(e.altKey && e.key.toLowerCase() === 'c'){
      e.preventDefault(); clearAll();
    }
    if(ctrlCmd && e.key.toLowerCase() === 'z' && !e.shiftKey){
      e.preventDefault(); undo();
    }
    if(ctrlCmd && e.key.toLowerCase() === 'f'){
      e.preventDefault();
      searchCodeBox.focus();
      setTimeout(()=>searchCodeBox.select(), 0);
    }
    if(e.altKey && e.key.toLowerCase() === 'u'){ 
      e.preventDefault(); 
      autoUpdate.checked = !autoUpdate.checked; 
      setStatus('è‡ªå‹•æ›´æ–°ï¼š' + (autoUpdate.checked?'é–‹å•Ÿ':'é—œé–‰')); 
    }
    if(e.altKey && e.key.toLowerCase() === 'f'){ 
      e.preventDefault(); btnFormat.click(); 
    }
    if(e.altKey && e.key.toLowerCase() === 'n'){ 
      e.preventDefault(); newDoc(); 
    }
    if(e.altKey && e.key.toLowerCase() === 'o'){ 
      e.preventDefault(); openFile(); 
    }
    if(e.key === 'F3' || (ctrlCmd && e.key.toLowerCase() === 'g')){
      e.preventDefault();
      if(e.shiftKey) prevCodeMatch();
      else nextCodeMatch();
    }
  });

  const cached = localStorage.getItem('livepad_html');
  const initial = cached || DEFAULT_HTML;
  editor.value = initial;
  saveToHistory(initial);
  updatePreview();
})();
</script>
</body>
</html>
