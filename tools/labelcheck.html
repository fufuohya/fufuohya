<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é£Ÿå“æ¨™ç±¤æ‰¹æ¬¡åˆ†æå·¥å…·ï¼ˆå„ªåŒ–ç‰ˆï¼‰</title>

  <!-- è§£æ PDF / DOCX æ‰€éœ€å¤–æ›ï¼ˆCDNï¼‰ -->
  <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script defer>
    // æŒ‡å®š PDF.js workerï¼ˆå¿…è¦ï¼‰
    window.addEventListener('DOMContentLoaded', () => {
      if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
      }
    });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

<style>
  /* åŸºç¤æ¨£å¼ */
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
  .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);backdrop-filter:blur(10px)}
  h1{text-align:center;color:#333;margin-bottom:30px;font-size:2.5em;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
  .config-section{background:#f8f9fa;padding:20px;border-radius:15px;margin-bottom:20px;border:2px solid #e9ecef}
  .config-section h3{margin-bottom:15px;color:#495057;display:flex;align-items:center}
  .config-section h3::before{content:"âš™ï¸";margin-right:10px}
  .form-group{margin-bottom:20px}
  label{display:block;margin-bottom:8px;font-weight:600;color:#495057}
  input[type="text"],input[type="file"]{width:100%;padding:12px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all .3s ease}
  input[type="text"]:focus,input[type="file"]:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
  .upload-area{border:3px dashed #667eea;border-radius:15px;padding:40px;text-align:center;background:#f8f9ff;transition:all .3s ease;cursor:pointer;margin-bottom:20px}
  .upload-area:hover{background:#f0f4ff;transform:translateY(-2px)}
  .upload-area.dragover{background:#e6f0ff;border-color:#4dabf7}
  .btn{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;padding:12px 30px;border:none;border-radius:25px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;margin-right:10px}
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.3)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .progress-section{margin-top:30px;padding:20px;background:#e8f5e8;border-radius:15px;display:none}
  .progress-bar{width:100%;height:20px;background:#ddd;border-radius:10px;overflow:hidden;margin-bottom:15px}
  .progress-fill{height:100%;background:linear-gradient(90deg,#28a745,#34ce57);width:0%;transition:width .3s ease;border-radius:10px}
  .current-file{font-weight:600;color:#155724;margin-bottom:10px}
  .status{color:#666;font-style:italic}
  .results{margin-top:30px;display:none}
  .results-table-container{background:#fff;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.1);overflow:hidden;margin-top:20px}

  /* è¡¨æ ¼ï¼šå›ºå®šæ¬„å¯¬ï¼‹æ›è¡Œ */
  .results-table{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed}
  .results-table th{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;padding:15px 8px;text-align:center;font-weight:600;position:sticky;top:0;z-index:10;white-space:normal;word-break:break-word;overflow-wrap:anywhere}
  .results-table td{padding:12px 8px;border-bottom:1px solid #e9ecef;vertical-align:top;position:relative;max-width:none;overflow:visible;text-overflow:clip;white-space:normal;word-break:break-word;overflow-wrap:anywhere}

  /* ç¬¬ä¸€æ¬„ sticky èˆ‡å¯¬åº¦ */
  .results-table th:first-child,.results-table td:first-child{background:#f8f9fa;font-weight:600;position:sticky;left:0;z-index:11;border-right:2px solid #dee2e6;min-width:100px;max-width:1000px}

  /* â¤ æ¯ä¸€æ¬„ã€Œé è¨­å¯¬åº¦ã€ */
  .results-table th:nth-child(2), .results-table td:nth-child(2){ width:180px; max-width:180px }
  .results-table th:nth-child(3), .results-table td:nth-child(3){ width:360px; max-width:360px }
  .results-table th:nth-child(4), .results-table td:nth-child(4){ width:120px; max-width:120px }
  .results-table th:nth-child(5), .results-table td:nth-child(5){ width:380px; max-width:380px }
  .results-table th:nth-child(6), .results-table td:nth-child(6){ width:240px; max-width:240px }
  .results-table th:nth-child(7), .results-table td:nth-child(7){ width:160px; max-width:160px }
  .results-table th:nth-child(8), .results-table td:nth-child(8){ width:300px; max-width:300px }
  .results-table th:nth-child(9), .results-table td:nth-child(9){ width:160px; max-width:160px }
  .results-table th:nth-child(10), .results-table td:nth-child(10){ width:170px; max-width:170px }
  .results-table th:nth-child(11), .results-table td:nth-child(11){ width:110px; max-width:110px }

  .results-table tbody tr:hover{background:#f8f9ff}
  .results-table tbody tr.processing{background:#fff3cd}
  .results-table tbody tr.error{background:#f8d7da}

  /* å„²å­˜æ ¼å…§å±¤å®¹å™¨ */
  .cell-content{max-height:200px;overflow-y:auto;font-size:12px;line-height:1.4}
  .cell-content.json-content{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#f8f9fa;padding:5px;border-radius:4px}

  .status-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase}
  .status-badge.success{background:#d4edda;color:#155724}
  .status-badge.processing{background:#fff3cd;color:#856404}
  .status-badge.error{background:#f8d7da;color:#721c24}

  .table-scroll{max-height:600px;overflow:auto}

  .error{color:#dc3545;background:#f8d7da;border:1px solid #f5c6cb;padding:10px;border-radius:5px;margin-top:10px}
  .export-section{margin-top:20px;text-align:center}
  .file-list{margin-top:15px;max-height:200px;overflow-y:auto}
  .file-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fff;margin-bottom:5px;border-radius:8px;border:1px solid #e9ecef}
  .file-item.processing{background:#fff3cd;border-color:#ffeaa7}
  .file-item.completed{background:#d4edda;border-color:#c3e6cb}
  .file-item.error{background:#f8d7da;border-color:#f5c6cb}
  .countdown{font-weight:bold;color:#fd7e14}

  /* å¯é¸ï¼šçª„è¢å¹•èª¿æ•´ */
  @media (max-width: 1024px){
    .results-table th, .results-table td{ font-size:12px }
    .results-table th:nth-child(3), .results-table td:nth-child(3){ width:300px; max-width:300px }
    .results-table th:nth-child(5), .results-table td:nth-child(5){ width:320px; max-width:320px }
    .results-table th:first-child, .results-table td:first-child{ min-width:200px; max-width:200px }
  }
  .visually-hidden-file {
    position: absolute;
    left: -9999px;
    top: 0;
    width: 0;
    height: 0;
    opacity: 0;
  }
</style>
</head>
<body>
  <div class="container">
    <h1 aria-live="polite">ğŸ± é£Ÿå“æ¨™ç±¤æ‰¹æ¬¡åˆ†æå·¥å…·</h1>

    <div class="config-section">
      <h3>API è¨­å®š</h3>
      <div class="form-group">
        <label for="apiKey">Gemini API Key:</label>
        <input type="text" id="apiKey" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key" autocomplete="off"/>
        <small style="color:#666;display:block;margin-top:5px;">âš ï¸ é‡‘é‘°åƒ…åœ¨æœ¬é é‹è¡ŒæœŸé–“å­˜åœ¨è¨˜æ†¶é«”ï¼Œä¸æœƒè¢«å„²å­˜ã€‚</small>
      </div>
    </div>

    <div class="config-section">
      <h3>æª”æ¡ˆä¸Šå‚³</h3>
      <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-label="é»æ“Šæˆ–æ‹–æ”¾æª”æ¡ˆåˆ°æ­¤è™•">
        <div style="font-size:3em;margin-bottom:10px;" aria-hidden="true">ğŸ“</div>
        <p>é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹–æ‹½åˆ°æ­¤è™•</p>
        <p style="color:#666;margin-top:10px;">æ”¯æ´ï¼šJPG/PNG/WEBP/GIFï¼ˆè‡ªå‹•è½‰PNGï¼‰ã€PDFã€DOCXã€TXT</p>
      </div>
      <input type="file" id="fileInput" multiple
       accept=".pdf,.docx,.txt,image/*"
       class="visually-hidden-file"/>
      <div class="file-list" id="fileList" aria-live="polite"></div>
    </div>

    <div style="text-align:center;margin:20px 0;">
      <button class="btn" id="startBtn">ğŸš€ é–‹å§‹åˆ†æ</button>
      <button class="btn" id="stopBtn" style="background:#dc3545;display:none;">â¹ï¸ åœæ­¢åˆ†æ</button>
    </div>

    <div class="progress-section" id="progressSection" aria-live="polite">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="current-file" id="currentFile"></div>
      <div class="status" id="status"></div>
      <div class="countdown" id="countdown"></div>
    </div>

    <div class="results" id="results">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3>ğŸ“Š åˆ†æçµæœ</h3>
        <div class="export-section">
          <button class="btn" id="exportJsonBtn">ğŸ’¾ åŒ¯å‡º JSON</button>
          <button class="btn" id="exportCsvBtn">ğŸ“„ åŒ¯å‡º CSV</button>
          <button class="btn" id="clearBtn" style="background:#dc3545;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
        </div>
      </div>
      <div class="results-table-container">
        <div class="table-scroll">
          <table class="results-table" id="resultsTable">
            <colgroup>
              <col style="width:100px">  <!-- æª”æ¡ˆåç¨± -->
              <col style="width:200px">  <!-- å“å -->
              <col style="width:280px">  <!-- å…§å®¹ç‰©åŠæˆåˆ† -->
              <col style="width:110px">  <!-- æ·¨é‡ -->
              <col style="width:320px">  <!-- ç‡Ÿé¤Šæ¨™ç¤º -->
              <col style="width:220px">  <!-- éæ•åŸè³‡è¨Š -->
              <col style="width:160px">  <!-- æœ‰æ•ˆæ—¥æœŸ -->
              <col style="width:260px">  <!-- å» å•†è³‡è¨Š -->
              <col style="width:140px">  <!-- åŸç”¢åœ° -->
              <col style="width:160px">  <!-- åˆ†ææ™‚é–“ -->
              <col style="width:100px">  <!-- ç‹€æ…‹ -->
            </colgroup>
            <thead>
              <tr>
                <th>æª”æ¡ˆåç¨±</th>
                <th>å“å</th>
                <th>å…§å®¹ç‰©åŠæˆåˆ†</th>
                <th>æ·¨é‡</th>
                <th>ç‡Ÿé¤Šæ¨™ç¤º</th>
                <th>éæ•åŸè³‡è¨Š</th>
                <th>æœ‰æ•ˆæ—¥æœŸ</th>
                <th>å» å•†è³‡è¨Š</th>
                <th>åŸç”¢åœ°</th>
                <th>åˆ†ææ™‚é–“</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="resultsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/** â€”â€” åŸºæœ¬ç‹€æ…‹ â€”â€” */
const MODEL = "gemini-2.5-flash";           // å¿«é€Ÿå¤šæ¨¡æ…‹æ¨¡å‹
const DELAY_SECONDS = 10;                    // æ¯çµ„å®Œæˆå¾Œç­‰å¾…ç§’æ•¸
const TEXT_LIMIT = 30000;                    // æ–‡å­—æª”æœ€å¤§é€å‡ºé•·åº¦

let files = [];
let isAnalyzing = false;
let currentIndex = 0;
let analysisTimeout;
const allResults = [];                       // è·¨æ‰¹æ¬¡ç´¯ç©çµæœï¼ˆç”¨æ–¼åŒ¯å‡ºï¼‰

// ç©ºå€¼åˆ¤æ–· & é¡¯ç¤ºè¦å‰‡ï¼šæ²’å…§å®¹å°±é¡¯ç¤º N/A
const isBlank = (v) => v === null || v === undefined || (typeof v === "string" && v.trim() === "");
const show = (v) => (isBlank(v) ? "N/A" : String(v));

/** â€”â€” DOM â€”â€” */
const els = {
  uploadArea: document.getElementById("uploadArea"),
  fileInput: document.getElementById("fileInput"),
  fileList: document.getElementById("fileList"),
  startBtn: document.getElementById("startBtn"),
  stopBtn: document.getElementById("stopBtn"),
  progressSection: document.getElementById("progressSection"),
  progressFill: document.getElementById("progressFill"),
  currentFile: document.getElementById("currentFile"),
  status: document.getElementById("status"),
  countdown: document.getElementById("countdown"),
  results: document.getElementById("results"),
  resultsBody: document.getElementById("resultsTableBody"),
  apiKey: document.getElementById("apiKey"),
  exportJsonBtn: document.getElementById("exportJsonBtn"),
  exportCsvBtn: document.getElementById("exportCsvBtn"),
  clearBtn: document.getElementById("clearBtn"),
};

// Gemini æ”¯æ´çš„å½±åƒ MIMEï¼ˆGIF æœƒè½‰ PNGï¼‰ã€‚è¨»ï¼šå¤šæ•¸ç€è¦½å™¨ä¸æ”¯æ´ HEIC/HEIFã€‚
const GEMINI_SUPPORTED_IMG = new Set([
  "image/png", "image/jpeg", "image/webp"
]);

/** â€”â€” æª”ååˆ†çµ„å·¥å…· â€”â€” */
function extractGroupKey(filename = "") {
  const name = String(filename).trim();
  const m = name.match(/^\s*(\d{1,6})\s*(?:\(\d+\))?/);
  return m ? m[1] : name;
}
function groupFilesByLeadingNumber(fileList = []) {
  const map = new Map();
  for (const f of fileList) {
    const key = extractGroupKey(f.name || "");
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(f);
  }
  return map;
}

/** â€”â€” æª”æ¡ˆå·¥å…· â€”â€” */
function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(String(fr.result || ""));
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
function dataURLToPngBase64(dataURL) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement("canvas");
      c.width = img.naturalWidth || img.width;
      c.height = img.naturalHeight || img.height;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0);
      const pngDataURL = c.toDataURL("image/png");
      resolve(pngDataURL.split(",")[1]);
    };
    img.onerror = reject;
    img.src = dataURL;
  });
}
async function getFileData(file) {
  const type = file.type || "";
  const nameLower = (file.name || "").toLowerCase();

  // å½±åƒ
  if (type.startsWith("image/")) {
    const dataURL = await fileToDataURL(file);
    if (type === "image/gif" || !GEMINI_SUPPORTED_IMG.has(type)) {
      // GIF æˆ–ç€è¦½å™¨ä¸æ”¯æ´æ ¼å¼ â†’ è½‰ PNG
      const base64 = await dataURLToPngBase64(dataURL);
      return { mode: "image", mimeType: "image/png", base64, filename: file.name };
    }
    return { mode: "image", mimeType: type, base64: dataURL.split(",")[1], filename: file.name };
  }
  // ç´”æ–‡å­—
  if (type === "text/plain" || nameLower.endsWith(".txt")) {
    const text = await file.text();
    return { mode: "text", text, filename: file.name };
  }
  // PDF
  if (type === "application/pdf" || nameLower.endsWith(".pdf")) {
    const text = await extractPdfText(file);
    return { mode: "text", text, filename: file.name };
  }
  // DOCX
  const isDocx = type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || nameLower.endsWith(".docx");
  if (isDocx) {
    const text = await extractDocxText(file);
    return { mode: "text", text, filename: file.name };
  }
  throw new Error(`ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼š${file.name}ï¼ˆ${type || "unknown"}ï¼‰`);
}
async function extractPdfText(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = "";
  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const strings = content.items.map(item => item.str).filter(Boolean);
    fullText += strings.join(" ") + "\n";
  }
  return fullText;
}
async function extractDocxText(file) {
  const arrayBuffer = await file.arrayBuffer();
  const { value } = await window.mammoth.extractRawText({ arrayBuffer });
  return value || "";
}

/** â€”â€” ä¸Šå‚³å€äº’å‹• â€”â€” */
els.uploadArea.addEventListener("click", () => els.fileInput.click());
els.uploadArea.addEventListener("keydown", (e) => { if (e.key === 'Enter' || e.key === ' ') els.fileInput.click(); });
els.fileInput.addEventListener("change", (e) => addFiles(Array.from(e.target.files)));
["dragover","dragleave","drop"].forEach(evt => {
  els.uploadArea.addEventListener(evt, (e) => e.preventDefault());
});
els.uploadArea.addEventListener("dragover", () => els.uploadArea.classList.add("dragover"));
els.uploadArea.addEventListener("dragleave", () => els.uploadArea.classList.remove("dragover"));
els.uploadArea.addEventListener("drop", (e) => {
  els.uploadArea.classList.remove("dragover");
  const dropped = Array.from(e.dataTransfer.files);
  addFiles(dropped);
});
function addFiles(newFiles){
  files = [...files, ...newFiles];
  renderFileList();
}
function renderFileList(){
  if(!files.length){ els.fileList.innerHTML = ""; return;}
  els.fileList.innerHTML = files.map((f, i) => `
    <div class="file-item" id="file-${i}">
      <span>${f.name} (${(f.size/1024/1024).toFixed(2)} MB)</span>
      <button onclick="removeFile(${i})" style="background:#dc3545;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">ç§»é™¤</button>
    </div>`).join("");
}
window.removeFile = (i) => { files.splice(i,1); renderFileList(); };

/** â€”â€” æ“ä½œæŒ‰éˆ• â€”â€” */
els.startBtn.addEventListener("click", startAnalysis);
els.stopBtn.addEventListener("click", stopAnalysis);
els.exportJsonBtn.addEventListener("click", exportResultsJSON);
els.exportCsvBtn.addEventListener("click", exportResultsCSV);
els.clearBtn.addEventListener("click", clearAllRecords);

async function startAnalysis(){
  const apiKey = els.apiKey.value.trim();
  if(!apiKey){ alert("è«‹è¼¸å…¥ Gemini API Key"); return; }
  if(!files.length){ alert("è«‹é¸æ“‡è¦åˆ†æçš„æª”æ¡ˆ"); return; }

  // ä¾ä¸»æ¨™è™Ÿåˆ†çµ„
  const groupMap = groupFilesByLeadingNumber(files);
  const groups = Array.from(groupMap.entries()).map(([key, list]) => ({ groupKey: key, list }));

  isAnalyzing = true;
  currentIndex = 0;

  // UI ç‹€æ…‹
  els.progressSection.style.display = "block";
  els.results.style.display = "block";
  els.startBtn.style.display = "none";
  els.stopBtn.style.display = "inline-block";
  els.progressFill.style.width = "0%";
  els.status.textContent = "æº–å‚™é–‹å§‹åˆ†æâ€¦";
  els.countdown.textContent = "";

  // é å…ˆæ’å…¥ã€Œè™•ç†ä¸­ã€åˆ—
  const rowsMeta = groups.map(g => {
    const rowId = `row-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
    const label = `æ¨™è™Ÿ ${g.groupKey}ï¼ˆ${g.list.length} ç­†ï¼‰`;
    addTableRow({ rowId, label, sources: g.list.map(f => f.name), status: "processing" });
    return { rowId, group: g };
  });

  // é€çµ„é–‹å§‹
  for (const meta of rowsMeta){
    if(!isAnalyzing) break;

    const idx = currentIndex;
    const g = meta.group;
    els.currentFile.textContent = `æ­£åœ¨åˆ†æï¼šæ¨™è™Ÿ ${g.groupKey}ï¼ˆç¬¬ ${idx+1}/${rowsMeta.length} çµ„ï¼›å…± ${g.list.length} æª”ï¼‰`;
    els.status.textContent = "åˆ†æä¸­â€¦";

    try{
      const data = await analyzeGroupWithJSONMode(g.list, g.groupKey, apiKey);

      // ç´¯ç©çµæœ
      allResults.push({
        groupKey: g.groupKey,
        sources: g.list.map(f => f.name),
        analyzedAt: new Date().toLocaleString("zh-TW"),
        success: true,
        data
      });

      // æ›´æ–°è¡¨æ ¼
      updateTableRow(meta.rowId, data, "success", "", {
        label: `æ¨™è™Ÿ ${g.groupKey}ï¼ˆåˆä½µ ${g.list.length} ç­†ï¼‰`,
        sources: g.list.map(f => f.name)
      });

    }catch(err){
      allResults.push({
        groupKey: g.groupKey,
        sources: g.list.map(f => f.name),
        analyzedAt: new Date().toLocaleString("zh-TW"),
        success: false,
        error: String(err?.message || err)
      });
      updateTableRow(meta.rowId, { }, "error", String(err?.message || err), {
        label: `æ¨™è™Ÿ ${g.groupKey}ï¼ˆåˆä½µ ${g.list.length} ç­†ï¼‰`,
        sources: g.list.map(f => f.name)
      });
    }

    currentIndex++;
    els.progressFill.style.width = `${Math.round((currentIndex/rowsMeta.length)*100)}%`;

    // å€’æ•¸èˆ‡ç­‰å¾…
    if(isAnalyzing && currentIndex < rowsMeta.length){
      els.status.textContent = "ç­‰å¾…ä¸‹ä¸€çµ„æª”æ¡ˆâ€¦";
      let left = DELAY_SECONDS;
      els.countdown.textContent = `${left} ç§’å¾Œè™•ç†ä¸‹ä¸€çµ„`;
      await new Promise((resolve)=>{
        const iv = setInterval(()=>{
          left -= 1;
          if(left > 0){
            els.countdown.textContent = `${left} ç§’å¾Œè™•ç†ä¸‹ä¸€çµ„`;
          } else {
            clearInterval(iv);
            els.countdown.textContent = "";
            resolve();
          }
        }, 1000);
      });
    }
  }

  completeAnalysis();
}

function stopAnalysis(){
  isAnalyzing = false;
  if(analysisTimeout) clearTimeout(analysisTimeout);
  els.startBtn.style.display = "inline-block";
  els.stopBtn.style.display = "none";
  els.status.textContent = "åˆ†æå·²åœæ­¢";
  els.countdown.textContent = "";
}

function completeAnalysis(){
  isAnalyzing = false;
  els.startBtn.style.display = "inline-block";
  els.stopBtn.style.display = "none";
  els.progressFill.style.width = "100%";
  els.status.textContent = `åˆ†æå®Œæˆï¼æœ¬æ‰¹å…±è™•ç† ${currentIndex} çµ„`;
  els.countdown.textContent = "";
}

/** â€”â€” å‘¼å« Geminiï¼ˆJSON Modeï¼Œæ”¯æ´ã€ŒåŒæ¨™è™Ÿå¤šæª”åˆä½µã€ï¼‰ â€”â€” */
async function analyzeGroupWithJSONMode(fileList, groupKey, apiKey) {
  const parts = [];

  // ğŸ”§ ä¿®æ­£ï¼šå»é™¤é‡è¤‡å®£å‘Šèˆ‡è¡çª schemaï¼Œçµ±ä¸€è¦æ±‚ã€Œæ‰å¹³éµï¼å€¼ç‰©ä»¶ã€
  const prompt = `ä½ æ˜¯å°ˆé–€é–±è®€ã€Œè‡ºç£åŒ…è£é£Ÿå“æ¨™ç¤ºã€çš„åŠ©ç†ã€‚ä½ æœƒä¸€æ¬¡æ”¶åˆ°ã€ŒåŒä¸€ç”¢å“/åŒä¸€æ¨™è™Ÿï¼ˆæ¨™è™Ÿï¼š${groupKey}ï¼‰ã€çš„å¤šå¼µé£Ÿå“æ¨™ç¤ºåœ–ç‰‡ï¼Œæˆ–ç”± PDF/DOCX/TXT è½‰å‡ºçš„å¤šæ®µç´”æ–‡å­—ã€‚è«‹åªæ ¹æ“šæä¾›çš„å…§å®¹ï¼ˆçœ‹å¾—åˆ°çš„æ–‡å­—ï¼‰ä½œç­”ï¼Œä¸è¦è‡†æ¸¬ã€ä¸è¦ä¸Šç¶²æŸ¥ã€‚è‹¥ä¸åŒä¾†æºæœ‰è¡çªï¼Œè«‹ä»¥ã€Œä¸€è‡´å‡ºç¾æˆ–è¼ƒæ¸…æ™°å®Œæ•´ã€è€…ç‚ºæº–ï¼Œä¸¦åšå‡ºå–®ä¸€æ•´åˆçµæœã€‚

ã€è¼¸å‡ºè¦æ ¼ï¼ˆVBA ç›¸å®¹ç‰ˆï¼‰ã€‘
1) åªè¼¸å‡ºã€Œå–®ä¸€ JSON ç‰©ä»¶ã€ï¼Œä¸è¦åŠ å…¥ä»»ä½•è§£é‡‹æ–‡å­—ã€Markdown æˆ–ç¨‹å¼ç¢¼åœæ¬„ã€‚
2) **æ‰€æœ‰æ¬„ä½çš„å€¼ä¸€å¾‹ç‚ºå­—ä¸²**ï¼ˆåŒ…æ‹¬å¸ƒæ—è«‹è¼¸å‡ºå­—ä¸² "true"/"false"ï¼‰ï¼Œä¸è¦è¼¸å‡º nullã€æ•¸å­—ã€å¸ƒæ—ã€é™£åˆ—æˆ–ç‰©ä»¶ï¼ˆç‡Ÿé¤Šç´ é™¤å¤–ï¼Œè¦‹ä¸‹ï¼‰ã€‚
3) è‹¥çœ‹ä¸åˆ°æˆ–ä¸ç¢ºå®šï¼Œè«‹è¼¸å‡ºç©ºå­—ä¸² ""ï¼ˆæˆ–çœç•¥è©²éµï¼‰ã€‚
4) æ•¸å€¼è«‹ä¿ç•™å–®ä½èˆ‡è¨˜è™Ÿï¼ˆä¾‹å¦‚ "240å¤§å¡"ã€"1.1æ¯«å…‹"ã€"<0.01å…¬å…‹"ã€"ç´„5ä»½"ï¼‰ã€‚
5) éµåèˆ‡å–®ä½è«‹ä½¿ç”¨åŠå½¢ç©ºæ ¼èˆ‡ä¸‹åˆ—å›ºå®šå¯«æ³•ï¼Œä»¥åˆ©ç¨‹å¼æ­£ç¢ºåŒ¹é…ã€‚

è«‹è¼¸å‡ºä¸”åƒ…åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆå¯çœç•¥ä¸ç¢ºå®šè€…ï¼›å€¼ä¸€å¾‹ç‚ºå­—ä¸²ï¼‰ï¼š
{
  "productName": string,
  "ingredients": string,
  "netWeight": string,

  "æ¯ä¸€ä»½é‡": string,
  "æ¯ä»½é‡": string,
  "æ¯1ä»½é‡": string,
  "æœ¬åŒ…è£å«": string,

  "ç†±é‡ æ¯ä»½": string,
  "ç†±é‡ æ¯100å…¬å…‹": string,
  "ç†±é‡ æ¯100æ¯«å‡": string,
  "è›‹ç™½è³ª æ¯ä»½": string,
  "è›‹ç™½è³ª æ¯100å…¬å…‹": string,
  "è›‹ç™½è³ª æ¯100æ¯«å‡": string,
  "è„‚è‚ª æ¯ä»½": string,
  "è„‚è‚ª æ¯100å…¬å…‹": string,
  "è„‚è‚ª æ¯100æ¯«å‡": string,
  "é£½å’Œè„‚è‚ª æ¯ä»½": string,
  "é£½å’Œè„‚è‚ª æ¯100å…¬å…‹": string,
  "é£½å’Œè„‚è‚ª æ¯100æ¯«å‡": string,
  "åå¼è„‚è‚ª æ¯ä»½": string,
  "åå¼è„‚è‚ª æ¯100å…¬å…‹": string,
  "åå¼è„‚è‚ª æ¯100æ¯«å‡": string,
  "ç¢³æ°´åŒ–åˆç‰© æ¯ä»½": string,
  "ç¢³æ°´åŒ–åˆç‰© æ¯100å…¬å…‹": string,
  "ç¢³æ°´åŒ–åˆç‰© æ¯100æ¯«å‡": string,
  "ç³– æ¯ä»½": string,
  "ç³– æ¯100å…¬å…‹": string,
  "ç³– æ¯100æ¯«å‡": string,
  "éˆ‰ æ¯ä»½": string,
  "éˆ‰ æ¯100å…¬å…‹": string,
  "éˆ‰ æ¯100æ¯«å‡": string,

  // å…¶ä»–ç‡Ÿé¤Šç´ è«‹ä¾ç›¸åŒéµåè¦å‰‡æ–°å¢ï¼ˆä¾‹å¦‚ä¸‹åˆ—å…©å€‹ç¤ºä¾‹éµï¼‰ï¼š
  // "è†³é£Ÿçº–ç¶­ æ¯ä»½": string,
  // "è†³é£Ÿçº–ç¶­ æ¯100å…¬å…‹": string,

  "allergens": string,
  "hasExpiryDate": string,        // "true" / "false"
  "expiryDateText": string,
  "hasManufacturerInfo": string,  // "true" / "false"
  "manufacturerText": string,
  "hasCountryOfOrigin": string,   // "true" / "false"
  "originText": string
}

ã€ç‰¹åˆ¥æ³¨æ„ç‡Ÿé¤Šæ¨™ç¤ºæ ¼å¼ã€‘
1) ç‡Ÿé¤Šç´ éµåæ ¼å¼å›ºå®šç‚ºï¼šã€Œ<ç‡Ÿé¤Šæˆåˆ†åç¨±><åŠå½¢ç©ºæ ¼><æ¯ä»½|æ¯100å…¬å…‹|æ¯100æ¯«å‡>ã€ã€‚
2) å…«å¤§ä¸»è¦ç‡Ÿé¤Šæˆåˆ†åç¨±çµ±ä¸€ç‚ºï¼šç†±é‡ã€è›‹ç™½è³ªã€è„‚è‚ªã€é£½å’Œè„‚è‚ªã€åå¼è„‚è‚ªã€ç¢³æ°´åŒ–åˆç‰©ã€ç³–ã€éˆ‰ã€‚
3) è‹¥åŸæ¨™ç¤ºç”¨è©æœ‰å·®ç•°ï¼ˆå¦‚ã€Œèƒ½é‡ã€ã€Œé¹½ã€ç­‰ï¼‰ï¼Œè«‹æ­£è¦åŒ–ç‚ºä¸Šè¿°åç¨±ã€‚
4) æ¯ä»½é‡è³‡è¨Šè«‹å¡«å…¥ã€Œæ¯ä¸€ä»½é‡ã€æˆ–ã€Œæ¯ä»½é‡ã€æˆ–ã€Œæ¯1ä»½é‡ã€å…¶ä¸­ä¹‹ä¸€ï¼Œå€¼ä¿ç•™å–®ä½ï¼ˆä¾‹ï¼š"4.4å…¬å…‹"ã€"250æ¯«å‡"ï¼‰ã€‚
5) åŒ…è£å«é‡è«‹å¡«å…¥ã€Œæœ¬åŒ…è£å«ã€ï¼Œä¾‹ï¼š"ç´„5ä»½"ã€‚
6) åªä½¿ç”¨å¯è¦‹æ–‡å­—ï¼›ä»»ä½•ç¼ºæ¼æˆ–æ¨¡ç³Šè«‹è¼¸å‡ºç©ºå­—ä¸² ""ã€‚`;

  parts.push({ text: prompt });

  // è’é›†ä¾†æºï¼šå½±åƒ â†’ inline_dataï¼›æ–‡å­— â†’ é™„æ–¼åŒä¸€å°è©±ä¸­
  for (const f of fileList) {
    const d = await getFileData(f);
    if (d.mode === "image") {
      parts.push({ inline_data: { mime_type: d.mimeType, data: d.base64 } });
      parts.push({ text: `ã€å½±åƒä¾†æºã€‘${d.filename}` });
    } else {
      const truncated = String(d.text || "").slice(0, TEXT_LIMIT);
      parts.push({ text: `ã€æ–‡å­—ä¾†æºã€‘${d.filename}\n${truncated}` });
    }
  }

  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent`;

  async function fetchWithRetry(body, tries = 3, baseDelay = 300) {
    for (let i = 0; i < tries; i++) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
        body: JSON.stringify(body)
      });
      if (res.ok) return res;
      const txt = await res.text();
      if (res.status < 500 || res.status >= 600 || i === tries - 1) {
        throw new Error(`API éŒ¯èª¤ï¼šHTTP ${res.status} â€” ${txt}`);
      }
      await new Promise(r => setTimeout(r, baseDelay * Math.pow(2, i)));
    }
  }

  const body = {
    contents: [{ parts }],
    generationConfig: {
      temperature: 0,
      responseMimeType: "application/json"
      // ğŸ”§ å»é™¤ responseSchemaï¼Œé¿å…èˆ‡ã€Œæ‰å¹³éµã€è¦æ ¼è¡çª
    }
  };

  const res = await fetchWithRetry(body);
  const json = await res.json();
  const out = json?.candidates?.[0]?.content?.parts?.[0]?.text || "";
  if (!out) throw new Error("API è¿”å›ç‚ºç©ºæˆ–æ ¼å¼ç•°å¸¸ã€‚");
  let parsed;
  try { parsed = JSON.parse(out); }
  catch (e) { throw new Error("æ¨¡å‹æœªå›å‚³æœ‰æ•ˆ JSONã€‚"); }
  return parsed;
}

/** â€”â€” å‘ˆç¾å·¥å…· â€”â€” */
function renderNutrition(nl) {
  if (!nl) return "N/A";

  // å…¼å®¹é™£åˆ—/ç‰©ä»¶/å­—ä¸²è¼¸å…¥
  let obj = {};
  if (Array.isArray(nl)) {
    obj = Object.fromEntries(
      nl.filter(x => x && typeof x.key === "string").map(x => [x.key, x.value ?? ""])
    );
  } else if (typeof nl === "object") {
    obj = { ...nl };
  } else {
    return String(nl || "N/A");
  }

  // å…ˆé¡¯ç¤ºï¼šæ¯ä¸€ä»½é‡/æ¯ä»½é‡/æ¯1ä»½é‡ â†’ æœ¬åŒ…è£å« â†’ æ·¨é‡ï¼Œå†é¡¯ç¤ºå…¶ä»–ç‡Ÿé¤Šç´ 
  const orderKeys = ["æ¯ä¸€ä»½é‡", "æ¯ä»½é‡", "æ¯1ä»½é‡", "æœ¬åŒ…è£å«", "æ·¨é‡"];
  const lines = [];
  for (const k of orderKeys) {
    if (!isBlank(obj[k])) {
      lines.push(`${k}: ${obj[k]}`);
      delete obj[k];
    }
  }

  const rest = Object.entries(obj).map(([k, v]) => `${k}: ${v ?? ""}`);
  const out = [...lines, ...rest];
  return out.length ? out.join("\n") : "N/A";
}


/** â€”â€” è¡¨æ ¼æ¸²æŸ“ â€”â€” */
function addTableRow({rowId, label, sources = [], status}){
  const tr = document.createElement("tr");
  tr.id = rowId;
  tr.className = status; // processing / success / error
  tr.innerHTML = `
    <td>
      <div><strong>${escapeHtml(label)}</strong></div>
      <div style="font-size:12px;color:#666;margin-top:4px;">ä¾†æºï¼š${sources.map(escapeHtml).join(", ") || "â€”"}</div>
    </td>
    <td><div class="cell-content">...</div></td>
    <td><div class="cell-content">...</div></td>
    <td><div class="cell-content">...</div></td>
    <td><div class="cell-content json-content">...</div></td>
    <td><div class="cell-content">...</div></td>
    <td><div class="cell-content">...</div></td>
    <td><div class="cell-content">...</div></td>
    <td><div class="cell-content">...</div></td>
    <td><div class="cell-content">${new Date().toLocaleString("zh-TW")}</div></td>
    <td><span class="status-badge processing">åˆ†æä¸­â€¦</span></td>
  `;
  els.resultsBody.appendChild(tr);
}

function updateTableRow(rowId, data, status, errMsg = "", meta = {label:"N/A", sources:[]}) {
  const tr = document.getElementById(rowId);
  if (!tr) return;

  // å…¼å®¹è‹±/ä¸­éµå
  const value = (en, zh) => (data?.[en] !== undefined ? data?.[en] : data?.[zh]);

  // ğŸ”§ æ–°å¢ï¼šè‹¥æ²’æœ‰ nutritionLabelï¼Œå¾æ‰å¹³éµè‡ªå‹•è’é›†ç‡Ÿé¤Šç´ éµå€¼
  // å…ˆå–å‡ºæ¨¡å‹å¯èƒ½ç”¢å‡ºçš„ nutritionLabelï¼›å¦å‰‡å¾æ‰å¹³éµè’é›†
  let nutrition = value("nutritionLabel", "ç‡Ÿé¤Šæ¨™ç¤º");
  if (Array.isArray(nutrition)) {
    nutrition = Object.fromEntries(
      nutrition.filter(x => x && typeof x.key === "string").map(x => [x.key, x.value ?? ""])
    );
  }
  if (!nutrition || typeof nutrition !== "object") {
    nutrition = Object.fromEntries(
      Object.entries(data || {}).filter(([k]) => / (æ¯ä»½|æ¯100å…¬å…‹|æ¯100æ¯«å‡)$/.test(k))
    );
  }

  // ğŸ”— åˆä½µï¼šæ¯ä¸€ä»½é‡/æ¯ä»½é‡/æ¯1ä»½é‡ã€æœ¬åŒ…è£å«ã€æ·¨é‡ â†’ ä¸€èµ·æ”¾é€²ç‡Ÿé¤Šæ¨™ç¤º
  const servingKey = ["æ¯ä¸€ä»½é‡","æ¯ä»½é‡","æ¯1ä»½é‡"].find(k => !isBlank(data?.[k]));
  if (servingKey) nutrition[servingKey] = data[servingKey];

  if (!isBlank(data?.["æœ¬åŒ…è£å«"])) {
    nutrition["æœ¬åŒ…è£å«"] = data["æœ¬åŒ…è£å«"];
  }

  const netW = value("netWeight", "æ·¨é‡");
  if (!isBlank(netW)) {
    nutrition["æ·¨é‡"] = netW;  // çµ±ä¸€é¡¯ç¤ºç‚ºä¸­æ–‡éµ
  }


  const analyzedAt = new Date().toLocaleString("zh-TW");

  const firstCell = `
    <div><strong>${escapeHtml(show(meta.label))}</strong></div>
    <div style="font-size:12px;color:#666;margin-top:4px;">ä¾†æºï¼š${(meta.sources||[]).map(escapeHtml).join(", ") || "â€”"}</div>
  `;

  if (status === "success") {
    tr.className = "";
    tr.innerHTML = `
      <td>${firstCell}</td>
      <td><div class="cell-content">${escapeHtml(show(value("productName", "å“å")))}</div></td>
      <td><div class="cell-content">${escapeHtml(show(value("ingredients", "å…§å®¹ç‰©åŠé£Ÿå“æ·»åŠ ç‰©æˆåˆ†")))}</div></td>
      <td><div class="cell-content">${escapeHtml(show(value("netWeight", "æ·¨é‡")))}</div></td>
      <td><div class="cell-content json-content">${escapeHtml(renderNutrition(nutrition))}</div></td>
      <td><div class="cell-content">${escapeHtml(show(value("allergens", "éæ•åŸè³‡è¨Š")))}</div></td>
      <td><div class="cell-content">${escapeHtml(show(value("expiryDateText", "æœ‰æ•ˆæ—¥æœŸ")))}</div></td>
      <td><div class="cell-content">${escapeHtml(show(value("manufacturerText", "å» å•†è³‡è¨Š")))}</div></td>
      <td><div class="cell-content">${escapeHtml(show(value("originText", "åŸç”¢åœ°")))}</div></td>
      <td><div class="cell-content">${analyzedAt}</div></td>
      <td><span class="status-badge success">å®Œæˆ</span></td>
    `;
  } else {
    tr.className = "error";
    tr.innerHTML = `
      <td>${firstCell}</td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">N/A</div></td>
      <td><div class="cell-content">${analyzedAt}</div></td>
      <td><span class="status-badge error">${escapeHtml(errMsg || "å¤±æ•—")}</span></td>
    `;
  }
}

function escapeHtml(s=""){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** â€”â€” åŒ¯å‡º / æ¸…é™¤ â€”â€” */
function exportResultsJSON(){
  if(!allResults.length){ alert("æ²’æœ‰å¯åŒ¯å‡ºçš„çµæœ"); return; }
  const blob = new Blob([JSON.stringify(allResults, null, 2)], { type:"application/json" });
  downloadBlob(blob, `é£Ÿå“æ¨™ç±¤åˆ†æçµæœ_${new Date().toISOString().split("T")[0]}.json`);
}

// æ›´ç©©å¥çš„ä¸‹è¼‰å™¨ï¼šè™•ç† Safari/Edge/IEã€éæ—© revokeã€DOM å®‰å…¨é»æ“Š
function downloadBlob(blob, filename){
  // IE/Edge(èˆŠç‰ˆ) å°ˆç”¨
  // eslint-disable-next-line no-undef
  if (window.navigator && window.navigator.msSaveOrOpenBlob){
    // eslint-disable-next-line no-undef
    window.navigator.msSaveOrOpenBlob(blob, filename);
    return;
  }
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.rel = 'noopener';
  document.body.appendChild(a);
  // éƒ¨åˆ†ç€è¦½å™¨éœ€å°‡ç¯€é»åŠ å…¥ DOM æ‰èƒ½è§¸ç™¼ä¸‹è¼‰
  const supportsDownload = 'download' in a;
  if (!supportsDownload){
    // æ¥µå°‘æ•¸ç€è¦½å™¨ä¸æ”¯æ´ download å±¬æ€§ï¼Œé€€å›é–‹æ–°åˆ†é 
    window.open(url, '_blank');
    setTimeout(() => URL.revokeObjectURL(url), 2000);
    a.remove();
    return;
  }
  a.click();
  // é¿å…é»æ“Šå°šæœªè™•ç†å®Œæˆå°± revokeï¼Œå»¶å¾Œæ¸…ç†
  setTimeout(() => {
    a.remove();
    URL.revokeObjectURL(url);
  }, 1000);
}

function exportResultsCSV() {
  if (!allResults.length) {
    alert("æ²’æœ‰å¯åŒ¯å‡ºçš„çµæœ");
    return;
  }

  const headers = [
    "æ¨™è™Ÿ","ä¾†æºæª”å","åˆ†ææ™‚é–“","å“å","æˆåˆ†","æ·¨é‡",
    "ç‡Ÿé¤Šæ¨™ç¤º","éæ•åŸ","æœ‰æ•ˆæ—¥æœŸ","å» å•†è³‡è¨Š","åŸç”¢åœ°","ç‹€æ…‹"
  ];
  const rows = [headers.join(",")];

  const esc = (v) => {
    const s = isBlank(v) ? "N/A" : (typeof v === "object" ? JSON.stringify(v) : String(v));
    return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
  };

  const normalizeNutrition = (d) => {
    const base = {};

    // 1) å…ˆåƒæ‰æ¨¡å‹å¯èƒ½å›å‚³çš„ nutritionLabelï¼ˆç›¸å®¹èˆŠæ ¼å¼ï¼‰
    const nl = d?.nutritionLabel;
    if (Array.isArray(nl)) {
      for (const x of nl) {
        if (x && typeof x.key === "string") base[x.key] = x.value ?? "";
      }
    } else if (nl && typeof nl === "object") {
      Object.assign(base, nl);
    }

    // 2) å†å¾æ‰å¹³éµè’é›†æ‰€æœ‰ç‡Ÿé¤Šç´ ï¼ˆæ¯ä»½/æ¯100å…¬å…‹/æ¯100æ¯«å‡ï¼‰
    for (const [k, v] of Object.entries(d || {})) {
      if (/ (æ¯ä»½|æ¯100å…¬å…‹|æ¯100æ¯«å‡)$/.test(k)) base[k] = v ?? "";
    }

    // 3) ä½µå…¥ï¼šæ¯ä¸€ä»½é‡/æ¯ä»½é‡/æ¯1ä»½é‡ã€æœ¬åŒ…è£å«ã€æ·¨é‡
    const servingKey = ["æ¯ä¸€ä»½é‡","æ¯ä»½é‡","æ¯1ä»½é‡"].find(k => !isBlank(d?.[k]));
    if (servingKey) base[servingKey] = d[servingKey];

    if (!isBlank(d?.["æœ¬åŒ…è£å«"])) base["æœ¬åŒ…è£å«"] = d["æœ¬åŒ…è£å«"];

    const netW = d?.["æ·¨é‡"] || d?.["netWeight"];
    if (!isBlank(netW)) base["æ·¨é‡"] = netW;

    return Object.keys(base).length ? base : "N/A";
  };


  for (const item of allResults) {
    if (item.success) {
      const d = item.data || {};
      rows.push([
        esc(item.groupKey || ""),
        esc((item.sources||[]).join("; ")),
        esc(item.analyzedAt),
        esc(d.productName),
        esc(d.ingredients),
        esc(d.netWeight),
        esc(normalizeNutrition(d)),
        esc(d.allergens),
        esc(d.expiryDateText),
        esc(d.manufacturerText),
        esc(d.originText),
        "æˆåŠŸ"
      ].join(","));
    } else {
      rows.push([
        esc(item.groupKey || ""),
        esc((item.sources||[]).join("; ")),
        esc(item.analyzedAt),
        "N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A",
        `éŒ¯èª¤ï¼š${item.error || ""}`
      ].join(","));
    }
  }

  // Windows/Excel å‹å–„ï¼šUTF-8 BOM + CRLF
  const csvText = rows.join("\r\n");
  const blob = new Blob(["\uFEFF" + csvText], { type: "text/csv;charset=utf-8" });
  downloadBlob(blob, `é£Ÿå“æ¨™ç±¤åˆ†æçµæœ_${new Date().toISOString().split("T")[0]}.csv`);
}

function clearAllRecords(){
  if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åˆ†æè¨˜éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
  allResults.length = 0;
  els.resultsBody.innerHTML = "";
  els.results.style.display = "none";
  files = [];
  renderFileList();
  els.progressSection.style.display = "none";
  els.status.textContent = "";
  els.countdown.textContent = "";
  alert("æ‰€æœ‰è¨˜éŒ„å·²æ¸…é™¤");
}
</script>
</body>
</html>
